---
phase: 10-batch-dto-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/presentation/dto/batch.dto.ts
  - apps/api/src/presentation/controllers/batch.controller.ts
autonomous: true

must_haves:
  truths:
    - "Invalid mode values return 400 with structured error including valid options (LIST_MODE, PROFILE_MODE)"
    - "Missing mode field returns 400 with structured error"
    - "Valid mode values pass validation and reach CreateBatchUseCase"
    - "Controller contains zero parsing, persistence, or business logic"
  artifacts:
    - path: "apps/api/src/presentation/dto/batch.dto.ts"
      provides: "Zod v4 schema with custom enum error message"
      contains: "z.nativeEnum(BatchMode"
    - path: "apps/api/src/presentation/controllers/batch.controller.ts"
      provides: "Thin controller delegating to use case"
      contains: "createBatch.execute"
  key_links:
    - from: "apps/api/src/presentation/controllers/batch.controller.ts"
      to: "apps/api/src/presentation/dto/batch.dto.ts"
      via: "createBatchSchema import for validation"
      pattern: "createBatchSchema\\.safeParse"
    - from: "apps/api/src/presentation/controllers/batch.controller.ts"
      to: "apps/api/src/core/use-cases/batch"
      via: "CreateBatchUseCase.execute() delegation"
      pattern: "this\\.createBatch\\.execute"
---

<objective>
Harden the CreateBatchDto Zod v4 schema with a custom enum error message and refactor the BatchController to use `safeParse` for consistency with ZodValidationPipe patterns.

Purpose: The current batch.dto.ts and controller work but use Zod's generic enum error message and `parse` with try/catch. This plan improves error clarity (users see valid options on bad input) and aligns the manual validation pattern with the project's `safeParse` convention used in ZodValidationPipe. The controller must remain thin -- validation and delegation only.

Output: Updated batch.dto.ts with custom error message, updated batch.controller.ts using safeParse pattern, TypeScript compilation and linting pass.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-batch-dto-validation/10-CONTEXT.md
@.planning/phases/10-batch-dto-validation/10-RESEARCH.md

Key files to read before starting:
@apps/api/src/presentation/dto/batch.dto.ts
@apps/api/src/presentation/controllers/batch.controller.ts
@apps/api/src/presentation/pipes/zod-validation.pipe.ts
@apps/api/src/core/entities/batch.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add custom error message to CreateBatchDto schema and refactor controller to use safeParse</name>
  <files>
    apps/api/src/presentation/dto/batch.dto.ts
    apps/api/src/presentation/controllers/batch.controller.ts
  </files>
  <action>
    **batch.dto.ts changes:**
    Update `createBatchSchema` to include a custom error message on the `mode` field so users see valid options when validation fails:
    ```typescript
    export const createBatchSchema = z.object({
      mode: z.nativeEnum(BatchMode, {
        error: { message: 'Mode must be either LIST_MODE or PROFILE_MODE' },
      }),
    });
    ```
    Keep the `CreateBatchDto` type export unchanged.

    **batch.controller.ts changes:**
    Refactor the manual Zod validation block (lines 39-58) to use `safeParse` instead of `parse` with try/catch. This aligns with the `ZodValidationPipe` pattern already used in the project (see `zod-validation.pipe.ts`).

    Replace the current try/catch block:
    ```typescript
    // Before (parse + try/catch):
    let validated: CreateBatchDto;
    try {
      validated = createBatchSchema.parse({ mode });
    } catch (error) {
      if (error instanceof Error && 'issues' in error) { ... }
      throw error;
    }
    ```

    With the safeParse pattern:
    ```typescript
    // After (safeParse):
    const result = createBatchSchema.safeParse({ mode });
    if (!result.success) {
      const errors = result.error.issues.map((issue) => ({
        field: issue.path.join('.'),
        message: issue.message,
      }));
      throw new BadRequestException({
        message: 'Validation failed',
        errors,
      });
    }
    const validated = result.data;
    ```

    This eliminates the `error instanceof Error && 'issues' in error` type guard hack and the unsafe type assertion (`error as { issues: ... }`). The `safeParse` approach is type-safe out of the box.

    Keep everything else in the controller unchanged:
    - ClerkAuthGuard, FilesInterceptor, FileContentValidationPipe
    - File presence check (`!uploadedFiles || uploadedFiles.length === 0`)
    - ExcelFileInput transformation
    - Use case delegation (`this.createBatch.execute(...)`)

    The `let validated: CreateBatchDto` declaration becomes `const validated = result.data` (better: const over let).

    Remove the unused import of `type CreateBatchDto` from batch.dto.ts imports IF the variable is now inferred from `result.data`. Keep the `createBatchSchema` import.
  </action>
  <verify>
    Run from project root:
    1. `npm run build --filter=@populatte/api` -- TypeScript compiles without errors
    2. `npm run lint --filter=@populatte/api` -- ESLint passes without errors
    3. Verify batch.dto.ts contains custom error message string "LIST_MODE or PROFILE_MODE"
    4. Verify batch.controller.ts uses `safeParse` (not `parse` in try/catch)
    5. Verify batch.controller.ts has no imports from core/entities, infrastructure/database, or xlsx
    6. Verify controller method body has NO: SheetJS calls, repository calls, direct database access, transaction management
  </verify>
  <done>
    - createBatchSchema uses Zod v4 nativeEnum with custom error message mentioning valid options
    - BatchController uses safeParse pattern consistent with ZodValidationPipe
    - Controller contains only: validation, file presence check, file transformation, use case delegation
    - TypeScript compilation and ESLint pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build --filter=@populatte/api` passes
2. `npm run lint --filter=@populatte/api` passes
3. `npm run test --filter=@populatte/api` passes (existing tests unbroken)
4. batch.dto.ts: schema uses `z.nativeEnum(BatchMode, { error: { message: ... } })`
5. batch.controller.ts: uses `createBatchSchema.safeParse()` (not `.parse()` in try/catch)
6. batch.controller.ts: delegates to `this.createBatch.execute()` without business logic
7. No new dependencies added
</verification>

<success_criteria>
- CreateBatchDto uses Zod v4 schema with custom error message for mode field validation
- Controller uses safeParse pattern (consistent with ZodValidationPipe)
- Controller delegates to CreateBatchUseCase without containing any parsing or persistence logic
- All builds, lints, and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-batch-dto-validation/10-01-SUMMARY.md`
</output>
