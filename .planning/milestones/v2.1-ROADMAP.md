# Milestone v2.1: Batch Read Layer

**Status:** SHIPPED 2026-01-30
**Phases:** 11-12
**Total Plans:** 2

## Overview

This milestone closed the read cycle for ingested Excel data. The journey started by extending the repository layer with paginated query methods and comprehensive soft-delete filtering (Phase 11), then exposed three GET endpoints with ownership validation, pagination, and row counting (Phase 12). By completion, the API can serve batch metadata with totalRows, paginated batch lists, and paginated row data ordered by original Excel row index — everything the dashboard needs to display ingested data for user validation.

## Phases

### Phase 11: Repository Layer
**Goal**: Extend repositories with pagination and soft-delete filtering
**Depends on**: Phase 10
**Requirements**: REPO-01, REPO-02
**Success Criteria** (what must be TRUE):
  1. RowRepository can query paginated rows for a batch with total count
  2. All read queries filter out soft-deleted records (batches and rows)
  3. Pagination method accepts limit, offset, and returns { items, total }
**Plans**: 1 plan

Plans:
- [x] 11-01-PLAN.md — PaginatedResult type, paginated repository methods, soft-delete audit, ordering fixes

**Details:**
- Created PaginatedResult<T> generic type for consistent pagination across repositories
- Implemented findByProjectIdPaginated() and findByBatchIdPaginated() with Promise.all two-query pattern
- Fixed batch ordering from ASC to DESC (newest first) on findByProjectId()
- Added soft-delete filtering to ProjectRepository.findByIdOnly()
- Established tiebreaker sorting on rows (sourceRowIndex ASC, id ASC)
- Duration: 2min 36s

### Phase 12: Read Endpoints
**Goal**: Batch and row read endpoints with ownership validation
**Depends on**: Phase 11
**Requirements**: BREAD-01, BREAD-02, BREAD-03, RREAD-01, RREAD-02, RREAD-03
**Success Criteria** (what must be TRUE):
  1. User can retrieve single batch metadata via GET /projects/:projectId/batches/:batchId
  2. User can list all batches for a project via GET /projects/:projectId/batches
  3. User can retrieve paginated rows via GET /projects/:projectId/batches/:batchId/rows?limit=N&offset=N
  4. Batch read endpoints return 404 if project not found, 403 if user is not owner
  5. Row responses include pagination metadata (items, total, limit, offset) and are ordered by sourceRowIndex
**Plans**: 1 plan

Plans:
- [x] 12-01-PLAN.md — GET endpoints for batch detail, batch list, and paginated rows with ownership validation

**Details:**
- Created countByBatchId repository method from scratch (abstract + Drizzle implementation)
- Three read use cases: GetBatch, ListBatches, ListRows — all with ownership validation (404/403 distinction)
- Three GET routes on BatchController with correct ordering to prevent path conflicts
- Pagination schema with Zod coercion (limit 1-100 default 50, offset >=0 default 0)
- Defense-in-depth: batch.projectId === projectId verification after batch lookup
- Duration: 3min 41s

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**
- PaginatedResult<T> returns only items + total; use case layer adds limit/offset to compose full response
- Batches sorted by createdAt DESC (newest first), rows by sourceRowIndex ASC with id ASC tiebreaker
- Shared conditions variable between data and count queries prevents inconsistency
- countByBatchId created from scratch for efficient row counting (avoids pagination hack)
- N+1 query pattern in ListBatchesUseCase acceptable for MVP with Promise.all parallelization
- Pagination uses Zod coercion with strict limits: 1-100 default 50, offset >=0 default 0
- Route ordering: @Get() before @Get(':batchId') before @Get(':batchId/rows') to prevent path conflicts
- Defense-in-depth: verify batch.projectId === projectId after batch lookup

**Issues Resolved:**
- Pre-existing unused imports in create-batch test file (auto-fixed during Phase 12)

**Issues Deferred:**
- ListBatchesUseCase N+1 query pattern (future: SQL subquery or JOIN optimization)

**Technical Debt Incurred:**
- N+1 query pattern in ListBatchesUseCase (max 101 parallel queries at limit=100, MVP-acceptable)

---

_For current project status, see .planning/ROADMAP.md_
