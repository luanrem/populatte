# Milestone v2.3: Field Inventory

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 17-20
**Total Plans:** 7

## Overview

Field-level analytics and exploration for ingested Excel data. Backend endpoints for per-field statistics (presence count, unique values, inferred type) and paginated distinct values with search. Frontend card-based field inventory with view toggle and side sheet for value browsing with infinite scroll and clipboard copy.

## Phases

### Phase 17: Backend Field Stats with Type Inference

**Goal**: Field-level analytics endpoint with presence, uniqueness, and type detection
**Depends on**: Phase 16
**Plans**: 2 plans

Plans:
- [x] 17-01: TDD TypeInferenceService with Brazilian locale support
- [x] 17-02: Repository aggregation, GetFieldStatsUseCase, and REST endpoint

**Details:**
- TypeInferenceService with majority-wins heuristic (80% threshold) detecting STRING, NUMBER, DATE, BOOLEAN, UNKNOWN
- Brazilian locale support: CPF/CNPJ/CEP as STRING, DD/MM/YYYY dates, R$ currency as NUMBER
- CTE-based single-query field aggregation (no N+1 per field)
- GetFieldStatsUseCase orchestrating ownership validation + aggregation + type inference
- 35 test cases covering all type detection edge cases
- Zero-row batch edge case handling via columnMetadata

### Phase 18: Backend Field Values Endpoint

**Goal**: Paginated distinct values retrieval for specific fields
**Depends on**: Phase 17
**Plans**: 1 plan

Plans:
- [x] 18-01: Field values endpoint with search, pagination, and ownership validation

**Details:**
- Parallel CTE queries (Promise.all) for optimal performance: values+matchingCount and totalDistinctCount
- ILIKE case-insensitive search with SQL parameterization
- Dual count system: matchingCount (filtered) + totalDistinctCount (unfiltered) for rich UI pagination
- URL-encoded field key handling with decodeURIComponent at controller layer
- Field existence validation via columnMetadata with proper 404 error

### Phase 19: Frontend Field Inventory Grid

**Goal**: Card-based field exploration UI with view toggle
**Depends on**: Phase 17
**Plans**: 2 plans

Plans:
- [x] 19-01: Field stats Zod schema, API endpoint, and React Query hook
- [x] 19-02: Field inventory grid components, view toggle, and page integration

**Details:**
- Field stats Zod schema with z.enum InferredType matching backend exactly
- useFieldStats React Query hook with queryKey convention for nested resources
- BatchViewToggle with shadcn ToggleGroup for table/inventory switching
- FieldCard with color-coded type badges (STRING=slate, NUMBER=blue, DATE=amber, BOOLEAN=emerald)
- Presence progress bar with 50% amber threshold and ID badge for unique fields
- BatchFieldInventory grid with search filter, skeleton loading, empty states
- PROFILE_MODE defaults to field inventory, LIST_MODE defaults to table

### Phase 20: View Values Side Sheet

**Goal**: Non-modal value exploration with search and copy
**Depends on**: Phases 18, 19
**Plans**: 2 plans

Plans:
- [x] 20-01: Field values Zod schema, API endpoint, useFieldValuesInfinite hook, useDebounce hook
- [x] 20-02: FieldValuesSideSheet and FieldValueRow components, Sheet integration into BatchFieldInventory

**Details:**
- useInfiniteQuery with offset-based pagination for seamless infinite scroll
- Generic useDebounce hook (300ms) for search input delay
- FieldValuesSideSheet with header, sticky search, scrollable value list
- FieldValueRow with copy-to-clipboard and CheckCheck icon feedback (1.5s)
- Sentinel-based infinite scroll via react-intersection-observer IntersectionObserver
- Key-prop remount pattern for state reset when switching fields (React Compiler compatible)

---

## Milestone Summary

**Key Decisions:**
- TDD for core type inference service (RED-GREEN-REFACTOR cycle)
- Brazilian date check BEFORE ISO parse prevents MM/DD/YYYY misinterpretation
- Single CTE-based aggregation query for field stats (no N+1)
- Parallel CTE queries for field values (values+count separate from total count)
- ILIKE search applies only to values query enabling "X of Y matches (Z total)" UX
- Key-prop remount instead of useEffect setState for React Compiler compatibility
- React Compiler auto-memoization replaces manual useMemo

**Issues Resolved:**
- React Compiler lint errors for setState in useEffect and ref.current access during render (fixed with key-prop remount pattern)
- Uncontrolled-to-controlled input warning (fixed with single controlled Input across loading states)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None — no new tech debt introduced by v2.3

---

_For current project status, see .planning/ROADMAP.md_
