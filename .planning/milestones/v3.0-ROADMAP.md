# Milestone v3.0: Backend Mapping

**Status:** SHIPPED 2026-02-03
**Phases:** 21-23
**Total Plans:** 6

## Overview

Build the mapping CRUD layer that associates Excel columns to web form selectors, enabling the Chrome extension to fetch and execute form-filling recipes. Three phases deliver domain foundation, mapping lifecycle, and step management -- following established Clean Architecture patterns from v2.x.

## Phases

### Phase 21: Domain Foundation

**Goal**: Mapping and Step domain models exist with database persistence and repository abstractions
**Depends on**: Nothing (foundation phase)
**Requirements**: DOM-01, DOM-02, DOM-03
**Plans:** 2 plans

Plans:
- [x] 21-01-PLAN.md -- Mapping domain layer (entity, schema, repository interface, mapper, Drizzle implementation)
- [x] 21-02-PLAN.md -- Step domain layer (entity, schema, repository, mapper, implementation) + DrizzleModule registration + migration

**Details:**
- Mapping entity with projectId, name, targetUrl, isActive, nullable successTrigger enum (url_change, text_appears, element_disappears), and soft-delete timestamps
- Step entity with mappingId, action enum (fill, click, wait, verify), selector, selectorFallbacks array, mutually exclusive sourceFieldKey/fixedValue, stepOrder, and config options
- Drizzle schema creates mappings and steps tables with proper foreign keys, indexes, and relationships
- Repository interfaces and Drizzle implementations support CRUD operations with soft-delete filtering on mappings

### Phase 22: Mapping CRUD

**Goal**: Users can create, list, view, update, and soft-delete mappings for their projects
**Depends on**: Phase 21
**Requirements**: MAP-01, MAP-02, MAP-03, MAP-04, MAP-05, SEC-01, SEC-03
**Plans:** 2 plans

Plans:
- [x] 22-01-PLAN.md -- Mapping use cases (create, list, get, update, soft-delete) with ownership validation and repository extensions
- [x] 22-02-PLAN.md -- Mapping controller, DTOs, and endpoint wiring with MappingModule

**Details:**
- User can create a mapping with name, targetUrl, and optional successTrigger for a project they own
- User can list paginated mappings for a project, with optional targetUrl prefix filter returning only active mappings
- User can view a mapping's details including all associated steps ordered by stepOrder
- User can update a mapping's name, targetUrl, isActive status, and successTrigger
- User can soft-delete a mapping, making it and its steps inaccessible via mapping endpoints

### Phase 23: Step CRUD

**Goal**: Users can manage ordered steps within their mappings with full defense-in-depth security
**Depends on**: Phase 22
**Requirements**: STEP-01, STEP-02, STEP-03, STEP-04, SEC-02
**Plans:** 2 plans

Plans:
- [x] 23-01-PLAN.md -- Step use cases (create, update, delete, reorder) with defense-in-depth ownership
- [x] 23-02-PLAN.md -- Step controller, DTOs, and endpoint wiring with StepModule

**Details:**
- User can add a step to a mapping with action type, selector, and auto-assigned order at the end
- User can update a step's action, selector, fallbacks, sourceFieldKey or fixedValue (mutually exclusive), and config options
- User can delete a step from a mapping
- User can reorder steps by providing an ordered list of step IDs
- All step operations enforce the full ownership chain: step belongs to mapping, mapping belongs to project, project belongs to user

---

## Milestone Summary

**Key Decisions:**
- No userId param in MappingRepository -- ownership validated at use-case layer via project lookup
- Steps use hard-delete (no deletedAt column) unlike mappings -- steps are cheap to recreate
- Inverted URL prefix matching enables extension to find mappings for current URL
- Zod preprocess for successTrigger enum coercion (empty string to null)
- Step routes nested under /mappings/:mappingId (not /projects/:projectId)
- Zod validates mutual exclusion of sourceFieldKey/fixedValue at DTO level

**Issues Resolved:**
- None - all phases completed cleanly without blockers

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None identified during v3.0 execution

---

*For current project status, see .planning/ROADMAP.md*

---
*Archived: 2026-02-03 as part of v3.0 milestone completion*
