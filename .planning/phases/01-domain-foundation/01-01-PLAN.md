---
phase: 01-domain-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/core/entities/batch.entity.ts
  - apps/api/src/core/entities/row.entity.ts
  - apps/api/src/core/entities/index.ts
  - apps/api/src/core/repositories/batch.repository.ts
  - apps/api/src/core/repositories/row.repository.ts
  - apps/api/src/core/repositories/index.ts
autonomous: true

must_haves:
  truths:
    - "Batch entity defines all fields needed for ingestion tracking (id, projectId, userId, mode, status, fileCount, rowCount, columnMetadata, timestamps, soft delete with deletedBy)"
    - "Row entity defines all fields needed for data storage and traceability (id, batchId, data JSONB, status, validationMessages, sourceFileName, sourceSheetName, sourceRowIndex, timestamps, soft delete)"
    - "BatchRepository abstract class declares persistence contract including create, findById, findByProjectId, softDelete"
    - "RowRepository abstract class declares persistence contract including createMany with chunking signature, findByBatchId"
  artifacts:
    - path: "apps/api/src/core/entities/batch.entity.ts"
      provides: "Batch interface, BatchStatus enum, BatchMode enum, ColumnMetadata type, CreateBatchData interface"
      contains: "export interface Batch"
    - path: "apps/api/src/core/entities/row.entity.ts"
      provides: "Row interface, RowStatus enum, ValidationMessage type, CreateRowData interface"
      contains: "export interface Row"
    - path: "apps/api/src/core/repositories/batch.repository.ts"
      provides: "BatchRepository abstract class"
      contains: "export abstract class BatchRepository"
    - path: "apps/api/src/core/repositories/row.repository.ts"
      provides: "RowRepository abstract class with createMany"
      contains: "export abstract class RowRepository"
  key_links:
    - from: "apps/api/src/core/entities/index.ts"
      to: "batch.entity.ts, row.entity.ts"
      via: "barrel re-exports"
      pattern: "export \\* from"
    - from: "apps/api/src/core/repositories/index.ts"
      to: "batch.repository.ts, row.repository.ts"
      via: "barrel re-exports"
      pattern: "export \\* from"
    - from: "apps/api/src/core/repositories/batch.repository.ts"
      to: "apps/api/src/core/entities/batch.entity.ts"
      via: "import entity types"
      pattern: "import.*from.*batch\\.entity"
    - from: "apps/api/src/core/repositories/row.repository.ts"
      to: "apps/api/src/core/entities/row.entity.ts"
      via: "import entity types"
      pattern: "import.*from.*row\\.entity"
---

<objective>
Create the Core layer domain abstractions for the ingestion pipeline: Batch and Row entities with their enums and helper types, plus abstract repository classes defining the persistence contracts.

Purpose: Establish the domain foundation that Infrastructure implementations will build upon, following the exact patterns from User/Project entities and repositories in the v1.0 codebase.

Output: 6 files -- 2 entity files, 2 repository files, 2 updated barrel exports.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-domain-foundation/01-CONTEXT.md

# Existing patterns to follow exactly:
@apps/api/src/core/entities/user.entity.ts
@apps/api/src/core/entities/project.entity.ts
@apps/api/src/core/entities/index.ts
@apps/api/src/core/repositories/user.repository.ts
@apps/api/src/core/repositories/project.repository.ts
@apps/api/src/core/repositories/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Batch and Row domain entities with enums and helper types</name>
  <files>
    apps/api/src/core/entities/batch.entity.ts
    apps/api/src/core/entities/row.entity.ts
    apps/api/src/core/entities/index.ts
  </files>
  <action>
Create `batch.entity.ts` following the exact pattern from `user.entity.ts` and `project.entity.ts` (TypeScript interfaces, not classes; enums exported alongside):

**BatchStatus enum** (SCREAMING_SNAKE_CASE values as decided in CONTEXT.md):
- `PendingReview = 'PENDING_REVIEW'`
- `Completed = 'COMPLETED'`
- `Failed = 'FAILED'`

**BatchMode enum:**
- `ListMode = 'LIST_MODE'`
- `ProfileMode = 'PROFILE_MODE'`

**ColumnMetadata type** (array of objects for downstream consumers -- stores column info from parsed Excel headers):
```typescript
export interface ColumnMetadata {
  originalHeader: string;
  normalizedKey: string;
  inferredType: string;  // 'string' | 'number' | 'date' | 'boolean'
  position: number;
}
```

**Batch interface:**
- `id: string`
- `projectId: string`
- `userId: string`
- `mode: BatchMode`
- `status: BatchStatus`
- `fileCount: number`
- `rowCount: number`
- `columnMetadata: ColumnMetadata[]` (Pitfall 19: store column list as metadata)
- `createdAt: Date`
- `updatedAt: Date`
- `deletedAt: Date | null`
- `deletedBy: string | null` (userId of who deleted -- audit trail per CONTEXT.md)

**CreateBatchData interface** (input for creating a batch):
- `projectId: string`
- `userId: string`
- `mode: BatchMode`
- `fileCount: number`
- `rowCount: number`
- `columnMetadata: ColumnMetadata[]`

Create `row.entity.ts`:

**RowStatus enum:**
- `Valid = 'VALID'`
- `Warning = 'WARNING'`
- `Error = 'ERROR'`

**ValidationMessage type** (structured for dashboard field-level warnings per CONTEXT.md):
```typescript
export interface ValidationMessage {
  field: string;
  type: string;
  message: string;
}
```

**Row interface:**
- `id: string`
- `batchId: string`
- `data: Record<string, unknown>` (JSONB normalized data -- REQ-06)
- `status: RowStatus`
- `validationMessages: ValidationMessage[]`
- `sourceFileName: string` (REQ-07: source filename traceability)
- `sourceSheetName: string`
- `sourceRowIndex: number`
- `createdAt: Date`
- `updatedAt: Date`
- `deletedAt: Date | null`

**CreateRowData interface** (input for creating rows):
- `batchId: string`
- `data: Record<string, unknown>`
- `status?: RowStatus`
- `validationMessages?: ValidationMessage[]`
- `sourceFileName: string`
- `sourceSheetName: string`
- `sourceRowIndex: number`

Update `index.ts` barrel to add:
```typescript
export * from './batch.entity';
export * from './row.entity';
```

**Important patterns to follow:**
- Use TypeScript `interface` (not `class`) for entities, matching User/Project pattern
- Use TypeScript `enum` with PascalCase keys and string values, matching ProjectStatus pattern
- Use `| null` for nullable fields, matching existing pattern (not optional `?`)
- `createdAt` and `updatedAt` are `Date` (not nullable), matching existing pattern
  </action>
  <verify>
Run `npx tsc --noEmit --project apps/api/tsconfig.json` from repo root -- should pass with no errors.
Verify both entity files export interfaces and enums by checking barrel: `grep -c "export \*" apps/api/src/core/entities/index.ts` should show 4 lines.
  </verify>
  <done>
Batch and Row entity interfaces exist with all fields from CONTEXT.md. BatchStatus (PENDING_REVIEW, COMPLETED, FAILED), BatchMode (LIST_MODE, PROFILE_MODE), RowStatus (VALID, WARNING, ERROR) enums exist. ColumnMetadata and ValidationMessage helper types exist. CreateBatchData and CreateRowData input interfaces exist. Barrel exports updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BatchRepository and RowRepository abstract classes</name>
  <files>
    apps/api/src/core/repositories/batch.repository.ts
    apps/api/src/core/repositories/row.repository.ts
    apps/api/src/core/repositories/index.ts
  </files>
  <action>
Create `batch.repository.ts` following the exact pattern from `user.repository.ts` and `project.repository.ts` (abstract class with `public abstract` methods):

```typescript
import { Batch, CreateBatchData } from '../entities/batch.entity';

export abstract class BatchRepository {
  public abstract create(data: CreateBatchData): Promise<Batch>;
  public abstract findById(id: string): Promise<Batch | null>;
  public abstract findByProjectId(projectId: string): Promise<Batch[]>;
  public abstract softDelete(id: string, deletedBy: string): Promise<void>;
}
```

Note the import path uses `../entities/batch.entity` (relative to repositories folder), matching the existing `user.repository.ts` pattern that imports from `'../entities/user.entity'`.

Create `row.repository.ts`:

```typescript
import { Row, CreateRowData } from '../entities/row.entity';

export abstract class RowRepository {
  public abstract createMany(data: CreateRowData[]): Promise<void>;
  public abstract findByBatchId(batchId: string): Promise<Row[]>;
}
```

Key design decisions:
- `createMany()` returns `Promise<void>` NOT `Promise<Row[]>` -- Pitfall 16 says omit `.returning()` on bulk row inserts to avoid overhead. The implementation will chunk at ~5,000 rows per INSERT (Pitfall 5). The return type at the abstract level is `void` since we don't need inserted rows back.
- `softDelete` on BatchRepository takes `deletedBy: string` (userId) for audit trail per CONTEXT.md decision.
- `findByProjectId` filters by projectId and `deletedAt IS NULL` (implementation detail, but the contract expects only non-deleted batches).

Update `index.ts` barrel to add:
```typescript
export * from './batch.repository';
export * from './row.repository';
```

**Patterns to match exactly:**
- Abstract class (not interface) -- matches UserRepository/ProjectRepository
- `public abstract` method visibility -- matches existing pattern
- Import from `'../entities/X.entity'` -- matches existing import paths
  </action>
  <verify>
Run `npx tsc --noEmit --project apps/api/tsconfig.json` from repo root -- should pass with no errors.
Verify both repository files export abstract classes: `grep "abstract class" apps/api/src/core/repositories/batch.repository.ts apps/api/src/core/repositories/row.repository.ts` should show 2 matches.
  </verify>
  <done>
BatchRepository abstract class exists with create, findById, findByProjectId, softDelete methods. RowRepository abstract class exists with createMany (void return, chunks in implementation) and findByBatchId methods. Both import from their entity files. Barrel exports updated.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project apps/api/tsconfig.json` passes with no errors
2. `apps/api/src/core/entities/index.ts` exports from all 4 entity files (user, project, batch, row)
3. `apps/api/src/core/repositories/index.ts` exports from all 4 repository files (user, project, batch, row)
4. Entity interfaces use `interface` keyword (not `class`), matching existing pattern
5. Repository abstractions use `abstract class` keyword, matching existing pattern
6. No imports from infrastructure or presentation layers (Clean Architecture dependency rule)
</verification>

<success_criteria>
- Batch entity has all fields: id, projectId, userId, mode, status, fileCount, rowCount, columnMetadata, createdAt, updatedAt, deletedAt, deletedBy
- Row entity has all fields: id, batchId, data (Record<string, unknown>), status, validationMessages, sourceFileName, sourceSheetName, sourceRowIndex, createdAt, updatedAt, deletedAt
- BatchStatus enum: PENDING_REVIEW, COMPLETED, FAILED
- BatchMode enum: LIST_MODE, PROFILE_MODE
- RowStatus enum: VALID, WARNING, ERROR
- BatchRepository: create, findById, findByProjectId, softDelete (with deletedBy)
- RowRepository: createMany (void return), findByBatchId
- TypeScript compilation succeeds
- No circular dependencies introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-domain-foundation/01-01-SUMMARY.md`
</output>
