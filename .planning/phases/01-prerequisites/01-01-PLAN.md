---
phase: 01-prerequisites
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/infrastructure/database/drizzle/schema/users.schema.ts
  - apps/api/src/infrastructure/database/drizzle/repositories/drizzle-user.repository.ts
  - apps/api/src/core/repositories/user.repository.ts
  - apps/api/src/core/entities/user.entity.ts
  - apps/api/src/infrastructure/config/env.validation.ts
  - apps/api/src/app.module.ts
autonomous: false

user_setup:
  - service: clerk
    why: "JWT claims must be configured in Clerk Dashboard - Claude cannot access external dashboards"
    dashboard_config:
      - task: "Configure session token customization with user profile claims"
        location: "Clerk Dashboard -> Sessions -> Customize session token"

must_haves:
  truths:
    - "Database schema includes lastSyncedAt, deletedAt, and source columns"
    - "Partial unique index on clerkId excludes soft-deleted records"
    - "Repository has atomic upsert method using INSERT ON CONFLICT DO UPDATE"
    - "Missing CLERK_SECRET_KEY causes app startup failure"
    - "Clerk JWT tokens include email, firstName, lastName, imageUrl claims"
  artifacts:
    - path: "apps/api/src/infrastructure/database/drizzle/schema/users.schema.ts"
      provides: "Extended user schema with soft delete and sync tracking"
      contains: "lastSyncedAt"
    - path: "apps/api/src/infrastructure/database/drizzle/repositories/drizzle-user.repository.ts"
      provides: "Atomic upsert method"
      contains: "onConflictDoUpdate"
    - path: "apps/api/src/core/repositories/user.repository.ts"
      provides: "Upsert method signature"
      contains: "upsert"
    - path: "apps/api/src/infrastructure/config/env.validation.ts"
      provides: "Joi validation schema for env vars"
      contains: "CLERK_SECRET_KEY"
  key_links:
    - from: "apps/api/src/infrastructure/database/drizzle/repositories/drizzle-user.repository.ts"
      to: "users.schema.ts"
      via: "onConflictDoUpdate targeting clerkId"
      pattern: "onConflictDoUpdate.*target.*clerkId"
    - from: "apps/api/src/app.module.ts"
      to: "env.validation.ts"
      via: "ConfigModule validationSchema"
      pattern: "validationSchema.*envValidationSchema"
---

<objective>
Extend database schema for soft delete and sync tracking, implement atomic upsert pattern, and add environment validation. Configure Clerk JWT template with user profile claims.

Purpose: Establish foundation for request-time user sync - database must handle concurrent requests atomically and JWT must contain user data for sync operations.
Output: Extended user schema, upsert repository method, env validation, and configured Clerk JWT template.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-prerequisites/01-CONTEXT.md
@.planning/phases/01-prerequisites/01-RESEARCH.md

@apps/api/src/infrastructure/database/drizzle/schema/users.schema.ts
@apps/api/src/infrastructure/database/drizzle/repositories/drizzle-user.repository.ts
@apps/api/src/core/repositories/user.repository.ts
@apps/api/src/core/entities/user.entity.ts
@apps/api/src/app.module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend user schema and add upsert method</name>
  <files>
    apps/api/src/infrastructure/database/drizzle/schema/users.schema.ts
    apps/api/src/infrastructure/database/drizzle/repositories/drizzle-user.repository.ts
    apps/api/src/core/repositories/user.repository.ts
    apps/api/src/core/entities/user.entity.ts
    apps/api/src/infrastructure/database/drizzle/mappers/user.mapper.ts
  </files>
  <action>
    1. **Extend users.schema.ts:**
       - Add `lastSyncedAt: timestamp('last_synced_at', { withTimezone: true })` for debugging stale data
       - Add `deletedAt: timestamp('deleted_at', { withTimezone: true })` for soft delete
       - Add `source: text('source').notNull().default('clerk_sync')` for audit trail (values: 'clerk_sync', 'manual', 'import')
       - Replace `.unique()` on clerkId with partial unique index: `uniqueIndex('users_clerk_id_unique').on(table.clerkId).where(sql\`deleted_at IS NULL\`)`
       - Add partial index on email: `index('idx_users_email').on(table.email).where(sql\`deleted_at IS NULL\`)`
       - Import `sql` from 'drizzle-orm' and `uniqueIndex` from 'drizzle-orm/pg-core'

    2. **Update user.entity.ts:**
       - Add to User interface: `lastSyncedAt: Date | null`, `deletedAt: Date | null`, `source: string`
       - Add UpsertUserData interface with all sync fields (clerkId, email, firstName, lastName, imageUrl)

    3. **Update user.repository.ts:**
       - Add abstract method: `upsert(data: UpsertUserData): Promise<User>`

    4. **Update user.mapper.ts:**
       - Map new fields in toDomain: lastSyncedAt, deletedAt, source

    5. **Implement upsert in drizzle-user.repository.ts:**
       - Import `sql` from 'drizzle-orm'
       - Add `upsert()` method using `onConflictDoUpdate`:
         ```typescript
         public async upsert(data: UpsertUserData): Promise<User> {
           const result = await this.drizzle
             .getClient()
             .insert(users)
             .values({
               clerkId: data.clerkId,
               email: data.email,
               firstName: data.firstName ?? null,
               lastName: data.lastName ?? null,
               imageUrl: data.imageUrl ?? null,
               source: 'clerk_sync',
               lastSyncedAt: new Date(),
             })
             .onConflictDoUpdate({
               target: users.clerkId,
               set: {
                 email: sql`EXCLUDED.email`,
                 firstName: sql`EXCLUDED.first_name`,
                 lastName: sql`EXCLUDED.last_name`,
                 imageUrl: sql`EXCLUDED.image_url`,
                 updatedAt: sql`NOW()`,
                 lastSyncedAt: sql`NOW()`,
               },
               setWhere: sql`
                 ${users.email} IS DISTINCT FROM EXCLUDED.email OR
                 ${users.firstName} IS DISTINCT FROM EXCLUDED.first_name OR
                 ${users.lastName} IS DISTINCT FROM EXCLUDED.last_name OR
                 ${users.imageUrl} IS DISTINCT FROM EXCLUDED.image_url
               `,
             })
             .returning();

           const row = result[0];
           if (!row) {
             throw new Error('Upsert failed: no row returned');
           }
           return UserMapper.toDomain(row);
         }
         ```
       - Note: Use `EXCLUDED.column_name` with snake_case matching database column names
  </action>
  <verify>
    1. `npm run type-check --filter=@populatte/api` passes with no errors
    2. `npm run lint --filter=@populatte/api` passes
    3. Grep confirms: `grep -r "onConflictDoUpdate" apps/api/src/` returns the upsert implementation
    4. Grep confirms: `grep -r "lastSyncedAt" apps/api/src/` shows field in schema, entity, mapper
  </verify>
  <done>
    - User schema has lastSyncedAt, deletedAt, source columns with partial unique index
    - Repository has upsert() method using onConflictDoUpdate with setWhere optimization
    - Entity and mapper updated to include new fields
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add environment variable validation</name>
  <files>
    apps/api/src/infrastructure/config/env.validation.ts
    apps/api/src/infrastructure/config/index.ts
    apps/api/src/app.module.ts
  </files>
  <action>
    1. **Create env.validation.ts:**
       - Install joi if not present: check package.json first, add if missing
       - Create Joi validation schema:
         ```typescript
         import * as Joi from 'joi';

         export const envValidationSchema = Joi.object({
           // Clerk configuration
           CLERK_SECRET_KEY: Joi.string().required()
             .description('Clerk secret key for backend API calls'),
           CLERK_PUBLISHABLE_KEY: Joi.string().required()
             .description('Clerk publishable key for frontend'),
           CLERK_WEBHOOK_SIGNING_SECRET: Joi.string().optional()
             .description('Clerk webhook signing secret'),

           // Database
           DATABASE_URL: Joi.string().required()
             .description('PostgreSQL connection string'),

           // Application
           NODE_ENV: Joi.string()
             .valid('development', 'production', 'test')
             .default('development'),
           PORT: Joi.number().default(3001),
         });
         ```

    2. **Update config/index.ts:**
       - Export envValidationSchema: `export { envValidationSchema } from './env.validation';`

    3. **Update app.module.ts:**
       - Import envValidationSchema from config
       - Add to ConfigModule.forRoot():
         ```typescript
         ConfigModule.forRoot({
           isGlobal: true,
           load: [clerkConfig, databaseConfig],
           validationSchema: envValidationSchema,
           validationOptions: {
             abortEarly: false, // Show all validation errors
             allowUnknown: true, // Allow other env vars
           },
         }),
         ```
  </action>
  <verify>
    1. `npm run type-check --filter=@populatte/api` passes
    2. Run API without CLERK_SECRET_KEY: `CLERK_SECRET_KEY= npm run dev --filter=@populatte/api` should fail at startup with validation error (test briefly, then restore)
    3. Grep confirms: `grep -r "validationSchema" apps/api/src/app.module.ts` shows integration
  </verify>
  <done>
    - env.validation.ts exists with Joi schema for required env vars
    - ConfigModule uses validation schema
    - App fails at startup if CLERK_SECRET_KEY is missing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Configure Clerk JWT and verify end-to-end</name>
  <what-built>
    Claude has completed:
    - Extended user schema with lastSyncedAt, deletedAt, source columns
    - Partial unique index on clerkId (excludes soft-deleted records)
    - Atomic upsert method using INSERT ON CONFLICT DO UPDATE
    - Environment variable validation at startup
  </what-built>
  <how-to-verify>
    **Step 1: Configure Clerk Session Token (human action)**
    1. Go to Clerk Dashboard (https://dashboard.clerk.com)
    2. Select your application
    3. Navigate to: Sessions -> Customize session token
    4. Add this JSON template:
       ```json
       {
         "email": "{{user.primary_email_address}}",
         "firstName": "{{user.first_name}}",
         "lastName": "{{user.last_name}}",
         "imageUrl": "{{user.image_url}}"
       }
       ```
    5. Click "Save"

    **Step 2: Verify database schema**
    1. Run migration to update database: `cd apps/api && npx drizzle-kit push`
    2. Verify columns exist: `npx drizzle-kit studio` and inspect users table
    3. Confirm columns: id, clerk_id, email, first_name, last_name, image_url, last_synced_at, deleted_at, source, created_at, updated_at

    **Step 3: Verify env validation**
    1. Temporarily remove CLERK_SECRET_KEY from .env
    2. Run: `npm run dev --filter=@populatte/api`
    3. Should see validation error and fail to start
    4. Restore CLERK_SECRET_KEY to .env
    5. Run again - should start successfully

    **Step 4: Verify JWT claims (after Clerk config)**
    1. Start the web app: `npm run dev --filter=@populatte/web`
    2. Sign in to the app
    3. Open browser devtools -> Application -> Cookies
    4. Find `__session` cookie, decode JWT at jwt.io
    5. Confirm payload contains: email, firstName, lastName, imageUrl

    **Expected outcomes:**
    - Database has new columns and partial unique index
    - App fails fast on missing env vars
    - JWT contains user profile claims
  </how-to-verify>
  <resume-signal>Type "approved" after completing Clerk configuration and verifying all steps, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema verification:**
   ```bash
   grep -r "lastSyncedAt\|deletedAt\|source" apps/api/src/infrastructure/database/drizzle/schema/users.schema.ts
   ```
   Should show all three new columns.

2. **Upsert verification:**
   ```bash
   grep -r "onConflictDoUpdate" apps/api/src/infrastructure/database/drizzle/repositories/
   ```
   Should show upsert implementation.

3. **Env validation verification:**
   ```bash
   grep -r "validationSchema" apps/api/src/app.module.ts
   ```
   Should show ConfigModule using envValidationSchema.

4. **Type check:**
   ```bash
   npm run type-check --filter=@populatte/api
   ```
   Should pass with no errors.
</verification>

<success_criteria>
Phase 1 is complete when:

1. **CFG-01:** Clerk JWT tokens contain email, firstName, lastName, imageUrl claims
   - Verified by decoding JWT from authenticated session

2. **CFG-02:** Database uses upsert pattern with INSERT ON CONFLICT DO UPDATE
   - Repository has `upsert()` method
   - Uses `onConflictDoUpdate` with `setWhere` optimization
   - Partial unique index excludes soft-deleted records

3. **Bonus:** Environment validation fails fast on missing required vars
   - App won't start without CLERK_SECRET_KEY
</success_criteria>

<output>
After completion, create `.planning/phases/01-prerequisites/01-01-SUMMARY.md`
</output>
