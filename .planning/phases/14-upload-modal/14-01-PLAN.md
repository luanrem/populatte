---
phase: 14-upload-modal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/projects/upload-batch-modal.tsx
  - apps/web/app/(platform)/projects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can open upload modal from project detail page via Nova Importacao button"
    - "User can select List Mode or Profile Mode via visual card selector before choosing files"
    - "User can add files via drag-and-drop or click-to-browse with visual feedback on dragover"
    - "User sees toast errors for invalid files (wrong type, >5MB, wrong count per mode)"
    - "User sees selected files with name, size, and remove button before upload"
    - "Upload submit creates batch via FormData API call with mode and file fields"
    - "Modal closes and batch list refreshes on successful upload with success toast"
    - "Modal stays open on failure with error toast so user can retry"
    - "Modal cannot be closed during active upload (Escape, close button, overlay click all blocked)"
  artifacts:
    - path: "apps/web/components/projects/upload-batch-modal.tsx"
      provides: "Upload modal with mode selector, dropzone, file list, and upload mutation"
      min_lines: 120
    - path: "apps/web/app/(platform)/projects/[id]/page.tsx"
      provides: "Wired Nova Importacao button opening the upload modal"
      contains: "UploadBatchModal"
  key_links:
    - from: "apps/web/app/(platform)/projects/[id]/page.tsx"
      to: "apps/web/components/projects/upload-batch-modal.tsx"
      via: "import UploadBatchModal, pass open/onOpenChange/projectId props"
      pattern: "UploadBatchModal.*open.*onOpenChange.*projectId"
    - from: "apps/web/components/projects/upload-batch-modal.tsx"
      to: "apps/web/lib/query/hooks/use-batches.ts"
      via: "useUploadBatch hook for FormData mutation"
      pattern: "useUploadBatch"
    - from: "apps/web/components/projects/upload-batch-modal.tsx"
      to: "sonner"
      via: "toast.success and toast.error for upload feedback"
      pattern: "toast\\.(success|error)"
---

<objective>
Build the upload batch modal component and wire it to the project detail page. The modal has a two-step flow: first the user selects List Mode or Profile Mode via side-by-side cards, then a drag-and-drop zone appears for adding .xlsx files. Client-side validation rejects wrong types and oversized files via toast. The submit button triggers the useUploadBatch mutation with FormData, and the modal blocks closing during upload.

Purpose: Enable users to upload Excel files and create batches from the project detail page, completing the upload flow that connects the UI to the ingestion API.
Output: upload-batch-modal.tsx component and wired project detail page button.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/components/projects/project-form-dialog.tsx (modal pattern reference)
@apps/web/app/(platform)/projects/[id]/page.tsx (wire upload button here)
@apps/web/lib/query/hooks/use-batches.ts (useUploadBatch hook)
@apps/web/lib/api/endpoints/batches.ts (upload endpoint - FormData body)
@apps/web/components/ui/dialog.tsx (showCloseButton prop)
@apps/web/components/ui/card.tsx (Card components for mode selector)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone and create upload-batch-modal.tsx</name>
  <files>
    apps/web/components/projects/upload-batch-modal.tsx
  </files>
  <action>
1. Install react-dropzone in the monorepo:
   ```bash
   cd /Users/luanmartins/source/projects/populatte && npm install react-dropzone@^14.4.0 --legacy-peer-deps
   ```

2. Create `apps/web/components/projects/upload-batch-modal.tsx` as a single "use client" component with this structure:

**Props interface:**
```typescript
interface UploadBatchModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  projectId: string;
}
```

**Internal state:**
- `selectedMode`: `'LIST_MODE' | 'PROFILE_MODE' | null` (starts null — no default)
- `selectedFiles`: `File[]` (managed by component, not by react-dropzone's internal state)

**useUploadBatch hook:**
- Call `useUploadBatch(projectId)` to get `mutate`, `isPending`

**onOpenChange handler:**
- Block closing when `isPending` is true (return early if `!open && isPending`)
- On close (when allowed), reset `selectedMode` to null and `selectedFiles` to empty array
- Pass this handler to `<Dialog onOpenChange={...}>`

**Mode selector section (shown when selectedMode is null):**
- Two side-by-side Card components in a `grid grid-cols-2 gap-4` container
- List Mode card: icon (e.g. `List` from lucide-react), title "Modo Lista", description "Importe uma planilha com varios registros"
- Profile Mode card: icon (e.g. `Users` from lucide-react), title "Modo Perfil", description "Importe arquivos individuais por entidade"
- Cards have `cursor-pointer` and on click set `selectedMode`
- Selected card gets `border-primary ring-2 ring-primary` styling via `cn()`
- After selection, show the dropzone section (do NOT hide mode selector — keep it visible but allow re-selection)
  - IMPORTANT: When mode changes after files are selected, clear the `selectedFiles` array (prevents invalid file counts when switching from Profile to List)

**Dropzone section (shown when selectedMode is not null):**
- Use `useDropzone` from react-dropzone with:
  - `accept`: `{ 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }`
  - `maxSize`: `5 * 1024 * 1024` (5MB)
  - `maxFiles`: `selectedMode === 'LIST_MODE' ? 1 : undefined` (unlimited for Profile Mode)
  - `multiple`: `selectedMode !== 'LIST_MODE'`
  - `onDrop`: callback that sets `selectedFiles` — for List Mode, replace previous file; for Profile Mode, append to existing files
  - `onDropRejected`: callback that shows toast.error for each rejected file:
    - `file-invalid-type` -> "Formato invalido. Use arquivos .xlsx"
    - `file-too-large` -> "Arquivo muito grande. Tamanho maximo: 5MB"
    - `too-many-files` -> "Modo Lista aceita apenas 1 arquivo"
    - Fallback -> the raw error message from react-dropzone
- Dropzone div: solid `bg-muted/50` background, `rounded-lg`, `p-8`, centered content
- On `isDragActive`: switch to `bg-primary/10 border-2 border-primary` with text "Solte os arquivos aqui"
- Default state: Upload icon (lucide-react `Upload`), text "Arraste arquivos .xlsx ou clique para selecionar", subtext with size limit info
- Apply `getRootProps()` on the container div and `getInputProps()` on a hidden input inside

**Selected files list (shown below dropzone when files.length > 0):**
- Each file: rounded row with `FileSpreadsheet` icon (lucide-react), file name, file size (format as KB with 2 decimal places via `(file.size / 1024).toFixed(2) + ' KB'`), and a ghost remove button (`X` icon)
- Remove button calls a `removeFile(index)` function that filters out the file by index
- Remove button disabled when `isPending`

**Dialog footer (shown when selectedMode is not null):**
- Cancel button (variant="outline"): calls `onOpenChange(false)`, disabled when `isPending`
- Submit button "Importar": disabled when `selectedFiles.length === 0 || isPending`
  - When `isPending`, show `Loader2` icon with `animate-spin` class (same pattern as project-form-dialog.tsx)
  - On click, calls `handleSubmit` function

**handleSubmit function:**
- Constructs FormData: `formData.append('mode', selectedMode)`, then for List Mode `formData.append('file', selectedFiles[0])`, for Profile Mode `selectedFiles.forEach(f => formData.append('files', f))`
- Calls `mutate(formData, { onSuccess, onError })`
- `onSuccess`: call `onOpenChange(false)` (which resets state), then `toast.success('Importacao realizada com sucesso')`
- `onError`: call `toast.error('Erro ao importar. Tente novamente.')` — modal stays open, form intact

**DialogContent props:**
- `showCloseButton={!isPending}` to hide the X button during upload
- `className="sm:max-w-lg"` for consistent width

**Full component structure:**
```
Dialog > DialogContent > DialogHeader (title + description) + Mode cards + Dropzone + File list + DialogFooter
```

All text in Portuguese (matching existing codebase patterns).
  </action>
  <verify>
    - File exists: `ls apps/web/components/projects/upload-batch-modal.tsx`
    - react-dropzone installed: `ls node_modules/react-dropzone/dist/index.js` or check package.json
    - Component imports useUploadBatch, useDropzone, toast, Dialog, Card components
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30`
  </verify>
  <done>
    upload-batch-modal.tsx exists with mode selector cards, react-dropzone integration, file list display, FormData construction, upload mutation with toast feedback, and modal close blocking during upload. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire upload modal to project detail page</name>
  <files>
    apps/web/app/(platform)/projects/[id]/page.tsx
  </files>
  <action>
Modify the project detail page to open the upload modal:

1. Add imports at top of file:
   - `import { useState } from "react"` (add `useState` to existing `use, useEffect` import from React)
   - `import { UploadBatchModal } from "@/components/projects/upload-batch-modal"`

2. Inside the component function (after the hooks section, before the return), add:
   ```typescript
   const [uploadModalOpen, setUploadModalOpen] = useState(false);
   ```

3. In the "Loaded state" return block, change the disabled button:
   **FROM:**
   ```tsx
   <Button size="sm" disabled>
     <Upload className="mr-2 h-4 w-4" />
     Nova Importacao
   </Button>
   ```
   **TO:**
   ```tsx
   <Button size="sm" onClick={() => setUploadModalOpen(true)}>
     <Upload className="mr-2 h-4 w-4" />
     Nova Importacao
   </Button>
   ```

4. Add the UploadBatchModal component right before the closing `</main>` tag:
   ```tsx
   <UploadBatchModal
     open={uploadModalOpen}
     onOpenChange={setUploadModalOpen}
     projectId={id}
   />
   ```

Keep all existing code (breadcrumb, loading states, error states, batch list) unchanged. Only touch the button and add the modal import + state + render.
  </action>
  <verify>
    - Button no longer has `disabled` prop: `grep -n "disabled" apps/web/app/\(platform\)/projects/\[id\]/page.tsx` should NOT show the Nova Importacao button as disabled
    - Modal component rendered: `grep "UploadBatchModal" apps/web/app/\(platform\)/projects/\[id\]/page.tsx`
    - State hook present: `grep "uploadModalOpen" apps/web/app/\(platform\)/projects/\[id\]/page.tsx`
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30`
    - Lint passes: `cd /Users/luanmartins/source/projects/populatte && npm run lint --filter=@populatte/web 2>&1 | tail -20`
  </verify>
  <done>
    "Nova Importacao" button opens the upload modal. UploadBatchModal is rendered with open, onOpenChange, and projectId props. TypeScript and lint pass.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `cd apps/web && npx tsc --noEmit` passes with no errors
2. Lint: `npm run lint --filter=@populatte/web` passes
3. File structure: `upload-batch-modal.tsx` exists in `apps/web/components/projects/`
4. Integration: Project detail page imports and renders UploadBatchModal
5. react-dropzone: Package is in node_modules and importable
6. All 9 requirements (UPLD-01 through UPLD-09) addressed:
   - UPLD-01: Button click opens modal
   - UPLD-02: Mode card selector (List/Profile)
   - UPLD-03: Drag-and-drop zone with dragover feedback
   - UPLD-04: Click-to-browse fallback via react-dropzone getInputProps
   - UPLD-05: Client-side validation with toast errors
   - UPLD-06: File list with name, size, remove button
   - UPLD-07: FormData upload via useUploadBatch mutation
   - UPLD-08: Modal closes + batch list refreshes on success
   - UPLD-09: Toast notifications on success and failure
</verification>

<success_criteria>
- Upload modal opens from "Nova Importacao" button on project detail page
- Mode selector shows two cards (List Mode / Profile Mode) with no default
- Drag-and-drop zone appears after mode selection with dragover visual feedback
- Invalid files rejected with Portuguese toast messages
- Selected files displayed with name, size, and remove button
- Submit constructs correct FormData and calls useUploadBatch mutation
- Success: modal closes, success toast, batch list refreshes
- Failure: error toast, modal stays open for retry
- Modal close blocked during upload (Escape, X button, overlay all disabled)
</success_criteria>

<output>
After completion, create `.planning/phases/14-upload-modal/14-01-SUMMARY.md`
</output>
