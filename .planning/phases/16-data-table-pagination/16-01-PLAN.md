---
phase: 16-data-table-pagination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/ui/table.tsx
  - apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx
  - apps/web/components/projects/batch-detail-header.tsx
  - apps/web/components/projects/batch-data-table.tsx
  - apps/web/components/projects/batch-table-pagination.tsx
  - apps/web/components/projects/batch-table-empty-state.tsx
  - apps/web/lib/query/hooks/use-batches.ts
autonomous: true

must_haves:
  truths:
    - "User navigates from batch card to batch detail page at /projects/[id]/batches/[batchId]"
    - "Batch detail page shows metadata header with mode badge, creation date, and total row count"
    - "Data table columns are generated dynamically from batch columnMetadata preserving Excel order"
    - "Data table displays paginated rows with Previous/Next controls and 'Showing X-Y of Z rows' label"
    - "User can change page size via dropdown (25/50/100)"
    - "Page transitions are smooth with previous data staying visible while next page loads"
    - "Loading state shows skeleton rows mimicking table structure"
    - "Empty batch with zero rows shows illustration and message"
  artifacts:
    - path: "apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx"
      provides: "Batch detail route and page component"
      min_lines: 80
    - path: "apps/web/components/projects/batch-detail-header.tsx"
      provides: "Batch metadata header with breadcrumb, mode badge, date, row count"
      min_lines: 40
    - path: "apps/web/components/projects/batch-data-table.tsx"
      provides: "Dynamic-column data table with horizontal scroll and sticky row numbers"
      min_lines: 80
    - path: "apps/web/components/projects/batch-table-pagination.tsx"
      provides: "Pagination controls with page size selector and page navigation"
      min_lines: 50
    - path: "apps/web/components/projects/batch-table-empty-state.tsx"
      provides: "Empty state for batches with zero rows"
      min_lines: 15
    - path: "apps/web/components/ui/table.tsx"
      provides: "shadcn/ui Table component"
  key_links:
    - from: "apps/web/components/projects/batch-card.tsx"
      to: "apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx"
      via: "Next.js Link href /projects/[id]/batches/[batchId]"
      pattern: "Link.*href.*batches"
    - from: "apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx"
      to: "apps/web/lib/query/hooks/use-batches.ts"
      via: "useBatch and useBatchRows hooks"
      pattern: "useBatch\\(|useBatchRows\\("
    - from: "apps/web/components/projects/batch-data-table.tsx"
      to: "batch.columnMetadata"
      via: "Dynamic column generation from ColumnMetadata array"
      pattern: "columnMetadata.*map|columns.*from"
    - from: "apps/web/lib/query/hooks/use-batches.ts"
      to: "useBatchRows"
      via: "placeholderData keepPreviousData for smooth page transitions"
      pattern: "keepPreviousData|placeholderData"
---

<objective>
Build the batch detail page with a dynamic-column data table, server-side pagination, and all loading/empty states.

Purpose: Users who click a batch card in the project detail page (Phase 15) arrive at this page to inspect their ingested Excel data in a familiar table view. This is the final phase of v2.2 and completes the dashboard upload & listing UI milestone.

Output:
- Batch detail route at /projects/[id]/batches/[batchId]
- Batch metadata header with breadcrumb, mode badge, date, total row count
- Dynamic-column table generated from batch columnMetadata
- Server-side pagination with page size dropdown and page navigation
- Loading skeleton table, empty state, error state with retry
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-api-foundation-project-detail-page/13-01-SUMMARY.md

Key existing files to reference:
@apps/web/app/(platform)/projects/[id]/page.tsx — Project detail page pattern (breadcrumbs, use() for params, loading/error states)
@apps/web/components/projects/batch-card.tsx — Navigation source (links to /projects/[id]/batches/[batchId])
@apps/web/lib/api/schemas/batch.schema.ts — Zod schemas with ColumnMetadata, BatchResponse, RowResponse, PaginatedRowsResponse types
@apps/web/lib/query/hooks/use-batches.ts — Existing hooks: useBatch, useBatchRows (must update useBatchRows to add keepPreviousData)
@apps/web/components/projects/batch-grid.tsx — Reference pattern for loading/empty state switching
@apps/web/components/projects/batch-empty-state.tsx — Reference pattern for empty state design
@apps/web/components/ui/tooltip.tsx — Existing tooltip component for cell truncation
@apps/web/components/ui/select.tsx — Existing select component for page size dropdown
@apps/web/components/ui/badge.tsx — Existing badge component for mode badge
@apps/web/components/ui/skeleton.tsx — Existing skeleton component for loading states
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shadcn/ui Table component and update useBatchRows hook with keepPreviousData</name>
  <files>
    apps/web/components/ui/table.tsx
    apps/web/lib/query/hooks/use-batches.ts
  </files>
  <action>
    **Step 1: Add shadcn/ui table component.**
    Run from apps/web directory:
    ```bash
    cd apps/web && pnpm dlx shadcn@latest add table
    ```
    This creates `apps/web/components/ui/table.tsx` with Table, TableHeader, TableBody, TableRow, TableHead, TableCell, TableCaption, TableFooter exports.

    **Step 2: Update useBatchRows hook to support keepPreviousData.**
    In `apps/web/lib/query/hooks/use-batches.ts`, update the `useBatchRows` function:
    - Import `keepPreviousData` from `@tanstack/react-query`
    - Add `placeholderData: keepPreviousData` to the useQuery options in useBatchRows
    - This ensures previous page data stays visible while the next page loads, preventing flash of loading state between pages

    The updated import line should be:
    ```typescript
    import { keepPreviousData, useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
    ```

    The useBatchRows query options should include:
    ```typescript
    placeholderData: keepPreviousData,
    ```
  </action>
  <verify>
    - `apps/web/components/ui/table.tsx` exists and exports Table, TableHeader, TableBody, TableRow, TableHead, TableCell
    - `apps/web/lib/query/hooks/use-batches.ts` imports keepPreviousData and uses it in useBatchRows
    - Run `npm run type-check --filter=@populatte/web` passes (or at minimum, no new errors introduced)
  </verify>
  <done>
    shadcn/ui Table component is available for import. useBatchRows hook supports smooth page transitions via keepPreviousData.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create batch detail components (header, data table, pagination, empty state)</name>
  <files>
    apps/web/components/projects/batch-detail-header.tsx
    apps/web/components/projects/batch-data-table.tsx
    apps/web/components/projects/batch-table-pagination.tsx
    apps/web/components/projects/batch-table-empty-state.tsx
  </files>
  <action>
    Create four components for the batch detail page:

    **Component 1: BatchDetailHeader** (`batch-detail-header.tsx`)
    - "use client" directive
    - Props: `{ batch: BatchResponse; projectId: string; projectName: string }`
    - Renders a card-style header panel at the top of the page with:
      - Breadcrumb navigation: Projetos > {projectName} > Importacao #{batch short id or date-based label}
        - "Projetos" links to `/projects`
        - {projectName} links to `/projects/${projectId}`
        - Last item is current page (non-clickable)
      - Batch metadata fields in a row:
        - Mode badge (reuse the same color scheme from batch-card.tsx: blue for LIST_MODE "Modo Lista", purple for PROFILE_MODE "Modo Perfil")
        - Status badge (green/emerald for COMPLETED, yellow/amber for PROCESSING, red for FAILED)
        - Creation date formatted with Intl.DateTimeFormat('pt-BR') for a readable absolute date
        - Total row count with label: "{totalRows} registros"
    - Use shadcn Card component for the header panel
    - Use shadcn Badge for mode and status
    - Use lucide icons: Calendar for date, Rows for row count

    **Component 2: BatchDataTable** (`batch-data-table.tsx`)
    - "use client" directive
    - Props: `{ batch: BatchResponse; rows: RowResponse[]; isLoading: boolean; isPlaceholderData: boolean }`
    - Generates columns dynamically from `batch.columnMetadata`, sorted by `position` field (preserving Excel column order)
    - First column is a sequential row number column (header: "#", values: offset-based row numbers starting from `offset + 1`)
      - Actually, row numbers should be passed via prop or computed: accept `offset: number` prop for correct numbering across pages
    - Update props to: `{ batch: BatchResponse; rows: RowResponse[]; isLoading: boolean; isPlaceholderData: boolean; offset: number }`
    - Renders using shadcn Table component (Table, TableHeader, TableBody, TableRow, TableHead, TableCell)
    - Wrap table in a `div` with `overflow-x-auto` for horizontal scrolling
    - First column (row numbers) has sticky positioning: `sticky left-0 z-10 bg-background` class on both th and td
    - Column headers show `columnMetadata[i].originalHeader` (the human-readable Excel header)
    - Cell values accessed via `row.data[columnMetadata[i].normalizedKey]`
    - Long cell values: set `max-w-[200px] truncate` on td. Wrap each cell value in a Tooltip:
      - `<Tooltip><TooltipTrigger asChild><span className="truncate block">{value}</span></TooltipTrigger><TooltipContent>{fullValue}</TooltipContent></Tooltip>`
    - Only show tooltip for values that might be truncated (optional optimization: always show tooltip is fine for simplicity)
    - When `isPlaceholderData` is true, apply `opacity-60` to TableBody to indicate stale data during page transition
    - Loading state (isLoading && no rows): Render skeleton rows
      - Same table header structure (dynamic from columnMetadata)
      - 10 skeleton rows, each cell containing `<Skeleton className="h-4 w-full" />`
      - If batch data is not yet available (still loading), render 6 skeleton columns with generic widths

    **Component 3: BatchTablePagination** (`batch-table-pagination.tsx`)
    - "use client" directive
    - Props: `{ total: number; limit: number; offset: number; onPageChange: (offset: number) => void; onPageSizeChange: (limit: number) => void }`
    - Renders a pagination bar:
      - Left side: "Mostrando {start}-{end} de {total} registros" where start = offset + 1, end = Math.min(offset + limit, total)
      - Right side: Page size selector + page navigation
      - Page size: shadcn Select component with options 25, 50, 100. Current value = limit. On change, call `onPageSizeChange(newLimit)` and reset offset to 0
      - Page navigation:
        - Previous button (disabled when offset === 0)
        - Page number buttons showing current page and nearby pages. Use simple approach: show first, last, current, and adjacent pages with ellipsis for gaps
        - Next button (disabled when offset + limit >= total)
        - Use shadcn Button with variant="outline" size="sm" for page buttons, variant="default" for current page
      - Total pages = Math.ceil(total / limit)
      - Current page = Math.floor(offset / limit) + 1
    - Clicking a page number: `onPageChange((pageNumber - 1) * limit)`
    - Previous: `onPageChange(Math.max(0, offset - limit))`
    - Next: `onPageChange(offset + limit)`
    - Hide pagination entirely if total <= limit (all data fits on one page)

    **Component 4: BatchTableEmptyState** (`batch-table-empty-state.tsx`)
    - "use client" directive
    - No props needed
    - Simple illustration + message following the pattern from batch-empty-state.tsx
    - Use lucide `Table` or `FileSpreadsheet` icon in a dashed circle (same style as BatchEmptyState)
    - Heading: "Nenhum dado encontrado"
    - Subtext: "Esta importacao nao contem registros."
    - No action button needed (user can go back via breadcrumb)
  </action>
  <verify>
    - All four component files exist in apps/web/components/projects/
    - Each file has "use client" directive
    - Each component has explicit TypeScript props interface
    - Run `npm run type-check --filter=@populatte/web` -- no new errors
    - Imports reference existing shadcn components (Table, Badge, Skeleton, Select, Tooltip, Card, Button, Breadcrumb)
  </verify>
  <done>
    All four batch detail components are created with proper TypeScript types, following existing codebase patterns (Portuguese labels, shadcn components, lucide icons).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create batch detail page route and wire all components together</name>
  <files>
    apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx
  </files>
  <action>
    Create the batch detail page that wires all components from Task 2 together.

    **File: `apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx`**

    Follow the same page pattern as `apps/web/app/(platform)/projects/[id]/page.tsx`:
    - "use client" directive
    - Import `use` from React for Next.js 15 async params unwrapping
    - Accept params: `Promise<{ id: string; batchId: string }>`
    - Use `const { id, batchId } = use(params)` to unwrap

    State management:
    - `const [limit, setLimit] = useState(50)` — current page size
    - `const [offset, setOffset] = useState(0)` — current page offset

    Data fetching:
    - `const { data: project, isLoading: projectLoading } = useProject(id)` — for project name in breadcrumb
    - `const { data: batch, isLoading: batchLoading, isError: batchError, error: batchErrorData } = useBatch(id, batchId)`
    - `const { data: rowsData, isLoading: rowsLoading, isPlaceholderData } = useBatchRows(id, batchId, limit, offset)`

    Page size change handler:
    ```typescript
    function handlePageSizeChange(newLimit: number) {
      setLimit(newLimit);
      setOffset(0); // Reset to first page when page size changes
    }
    ```

    Error handling (same pattern as project detail page):
    - useEffect with toast.error for non-404 errors
    - 404 state: "Importacao nao encontrada" with "Voltar para o projeto" button linking to /projects/{id}
    - Generic error state: "Algo deu errado" with retry link

    Loading state:
    - While batchLoading or projectLoading: render full-page skeleton
    - Skeleton includes: breadcrumb skeleton, header skeleton (card with skeleton lines), table skeleton (header + 10 skeleton rows)

    Loaded state (batch && project available):
    - `<BatchDetailHeader batch={batch} projectId={id} projectName={project.name} />`
    - Conditional rendering:
      - If batch.totalRows === 0: `<BatchTableEmptyState />`
      - Else:
        - `<BatchDataTable batch={batch} rows={rowsData?.items ?? []} isLoading={rowsLoading} isPlaceholderData={isPlaceholderData} offset={offset} />`
        - `<BatchTablePagination total={rowsData?.total ?? batch.totalRows} limit={limit} offset={offset} onPageChange={setOffset} onPageSizeChange={handlePageSizeChange} />`

    Layout wrapper:
    - `<main className="w-full">` with inner content area matching project detail page spacing
    - Header section: `<div className="px-8 pt-4">` for breadcrumb (now inside BatchDetailHeader)
    - Actually, move breadcrumb INTO the page (not into BatchDetailHeader) to match project detail page pattern where breadcrumb is above the header. OR keep breadcrumb inside BatchDetailHeader -- Claude's discretion. Recommend keeping it in BatchDetailHeader for encapsulation since this header has different breadcrumb structure than project detail.
    - Content area: `<div className="mx-auto max-w-7xl px-8 py-6">` — use max-w-7xl (wider than project page's max-w-5xl) because data tables need more horizontal space
    - Table area should allow horizontal overflow

    Import all components:
    ```typescript
    import { BatchDetailHeader } from "@/components/projects/batch-detail-header";
    import { BatchDataTable } from "@/components/projects/batch-data-table";
    import { BatchTablePagination } from "@/components/projects/batch-table-pagination";
    import { BatchTableEmptyState } from "@/components/projects/batch-table-empty-state";
    import { Skeleton } from "@/components/ui/skeleton";
    import { Button } from "@/components/ui/button";
    import { useProject } from "@/lib/query/hooks/use-projects";
    import { useBatch, useBatchRows } from "@/lib/query/hooks/use-batches";
    import { ApiError } from "@/lib/api/types";
    ```
  </action>
  <verify>
    - File exists at `apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx`
    - Run `npm run type-check --filter=@populatte/web` passes (no new errors)
    - Run `npm run lint --filter=@populatte/web` passes (no new errors in modified files)
    - Navigation chain works: BatchCard href `/projects/[id]/batches/[batchId]` resolves to this page
    - Page uses useBatch, useBatchRows hooks with keepPreviousData support
    - Page handles all states: loading, error (404 + generic), empty, data
  </verify>
  <done>
    Batch detail page is fully wired: navigable from batch card, shows metadata header, renders dynamic-column table with server-side pagination, handles all loading/error/empty states. Page transitions are smooth with keepPreviousData.
  </done>
</task>

</tasks>

<verification>
1. Type check: `npm run type-check --filter=@populatte/web` passes
2. Lint: `npm run lint --filter=@populatte/web` passes (no new errors in created/modified files)
3. Navigation: BatchCard links resolve to batch detail page route
4. Data flow: useBatch fetches batch metadata, useBatchRows fetches paginated rows with keepPreviousData
5. Dynamic columns: Table columns generated from batch.columnMetadata array sorted by position
6. Pagination: Previous/Next/page number controls update offset, page size dropdown updates limit and resets offset
7. All states covered: loading skeleton, error (404 + generic), empty (zero rows), data (paginated table)
</verification>

<success_criteria>
- Batch detail page renders at /projects/[id]/batches/[batchId] with batch metadata and data table
- Table columns are dynamically generated from columnMetadata preserving Excel column order
- Pagination controls work: Previous, Next, page numbers, and page size dropdown (25/50/100)
- "Mostrando X-Y de Z registros" label accurately reflects current page position
- Page transitions are smooth (previous data visible while next page loads)
- Loading skeleton mimics table structure
- Empty state shown for zero-row batches
- Breadcrumb navigation allows returning to project detail page
</success_criteria>

<output>
After completion, create `.planning/phases/16-data-table-pagination/16-01-SUMMARY.md`
</output>
