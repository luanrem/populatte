---
phase: 19-frontend-field-inventory-grid
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/api/schemas/field-stats.schema.ts
  - apps/web/lib/api/endpoints/batches.ts
  - apps/web/lib/query/hooks/use-batches.ts
autonomous: true

must_haves:
  truths:
    - "Field stats data can be fetched from the API via React Query hook"
    - "Field stats response is Zod-validated with typed InferredType enum"
    - "Field stats hook only fetches when projectId and batchId are present"
  artifacts:
    - path: "apps/web/lib/api/schemas/field-stats.schema.ts"
      provides: "Zod schemas and TypeScript types for field stats API response"
      exports: ["fieldStatsResponseSchema", "FieldStatsResponse", "FieldStatsItem", "InferredType"]
    - path: "apps/web/lib/api/endpoints/batches.ts"
      provides: "getFieldStats method on batch endpoints"
      contains: "getFieldStats"
    - path: "apps/web/lib/query/hooks/use-batches.ts"
      provides: "useFieldStats React Query hook"
      exports: ["useFieldStats"]
  key_links:
    - from: "apps/web/lib/query/hooks/use-batches.ts"
      to: "apps/web/lib/api/endpoints/batches.ts"
      via: "endpoints.getFieldStats() call in queryFn"
      pattern: "endpoints\\.getFieldStats"
    - from: "apps/web/lib/api/endpoints/batches.ts"
      to: "apps/web/lib/api/schemas/field-stats.schema.ts"
      via: "safeParse validation of API response"
      pattern: "fieldStatsResponseSchema\\.safeParse"
---

<objective>
Create the data fetching layer for field stats: Zod schema matching the backend GetFieldStatsResult entity, a getFieldStats endpoint method, and a useFieldStats React Query hook.

Purpose: Establish the type-safe data pipeline from backend field-stats API to React components, following the exact patterns from existing batch endpoints (safeParse validation, useApiClient hook, queryKey convention).

Output: Three files modified — new schema file, updated endpoints, updated hooks — enabling Plan 02 to consume field stats data in UI components.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Backend entity shape (source of truth for Zod schema)
@apps/api/src/core/entities/field-stats.entity.ts

# Existing patterns to follow exactly
@apps/web/lib/api/schemas/batch.schema.ts
@apps/web/lib/api/endpoints/batches.ts
@apps/web/lib/query/hooks/use-batches.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create field stats Zod schema and types</name>
  <files>apps/web/lib/api/schemas/field-stats.schema.ts</files>
  <action>
Create a new Zod schema file that mirrors the backend GetFieldStatsResult entity (from `apps/api/src/core/entities/field-stats.entity.ts`).

Define the following schemas and exported types:

1. **`inferredTypeSchema`**: `z.enum(['STRING', 'NUMBER', 'DATE', 'BOOLEAN', 'UNKNOWN'])` — mirrors the backend InferredType enum
2. **`fieldStatsItemSchema`**: z.object with:
   - `fieldName`: z.string()
   - `presenceCount`: z.number()
   - `uniqueCount`: z.number()
   - `inferredType`: inferredTypeSchema
   - `confidence`: z.number()
   - `sampleValues`: z.array(z.unknown())
3. **`fieldStatsResponseSchema`**: z.object with:
   - `totalRows`: z.number()
   - `fields`: z.array(fieldStatsItemSchema)

Export inferred types:
- `type InferredType = z.infer<typeof inferredTypeSchema>`
- `type FieldStatsItem = z.infer<typeof fieldStatsItemSchema>`
- `type FieldStatsResponse = z.infer<typeof fieldStatsResponseSchema>`

Follow the exact import/export style of `batch.schema.ts`. Use `import { z } from 'zod'`.
  </action>
  <verify>Run `npx tsc --noEmit --project apps/web/tsconfig.json` — no type errors from the new schema file.</verify>
  <done>field-stats.schema.ts exists with Zod schemas matching backend entity, and all three types are exported.</done>
</task>

<task type="auto">
  <name>Task 2: Add getFieldStats endpoint and useFieldStats hook</name>
  <files>apps/web/lib/api/endpoints/batches.ts, apps/web/lib/query/hooks/use-batches.ts</files>
  <action>
**In `batches.ts` (endpoints):**

1. Import `fieldStatsResponseSchema` and `FieldStatsResponse` from `'../schemas/field-stats.schema'`
2. Add a new `getFieldStats` method to the returned object from `createBatchEndpoints`:

```typescript
async getFieldStats(
  projectId: string,
  batchId: string,
): Promise<FieldStatsResponse> {
  const response = await fetchFn(
    `/projects/${projectId}/batches/${batchId}/field-stats`,
  );
  const data: unknown = await response.json();

  const result = fieldStatsResponseSchema.safeParse(data);

  if (!result.success) {
    console.error(
      '[API] Field stats response validation failed:',
      result.error.issues,
    );
    throw new Error('Invalid field stats data received from server');
  }

  return result.data;
}
```

Follow the exact same pattern as `getById` and `listRows` — safeParse, error log, throw.

**In `use-batches.ts` (hooks):**

1. Import `FieldStatsResponse` type from `'../../api/schemas/field-stats.schema'`
2. Add a new exported hook:

```typescript
export function useFieldStats(projectId: string, batchId: string) {
  const client = useApiClient();
  const endpoints = createBatchEndpoints(client.fetch);

  return useQuery<FieldStatsResponse>({
    queryKey: ['projects', projectId, 'batches', batchId, 'field-stats'],
    queryFn: () => endpoints.getFieldStats(projectId, batchId),
    enabled: !!projectId && !!batchId,
  });
}
```

Query key convention: `['projects', projectId, 'batches', batchId, 'field-stats']` — consistent with existing nested resource keys.

Note: Do NOT add `keepPreviousData` — field stats don't paginate, so no need for placeholder data.
  </action>
  <verify>
1. Run `npx tsc --noEmit --project apps/web/tsconfig.json` — no type errors.
2. Run `npm run lint --filter=@populatte/web` — no lint errors in modified files.
  </verify>
  <done>getFieldStats endpoint returns FieldStatsResponse with safeParse validation, useFieldStats hook is exported and uses correct queryKey pattern.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project apps/web/tsconfig.json` passes with no errors
2. `npm run lint --filter=@populatte/web` passes with no errors
3. The field stats schema file exists at `apps/web/lib/api/schemas/field-stats.schema.ts`
4. The `getFieldStats` method exists in `createBatchEndpoints` return object
5. The `useFieldStats` hook is exported from `use-batches.ts`
</verification>

<success_criteria>
- Field stats Zod schema mirrors backend GetFieldStatsResult entity exactly
- getFieldStats endpoint follows safeParse validation pattern from existing endpoints
- useFieldStats hook follows useQuery pattern from existing hooks
- All TypeScript and ESLint checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-frontend-field-inventory-grid/19-01-SUMMARY.md`
</output>
