---
phase: 19-frontend-field-inventory-grid
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - apps/web/components/projects/batch-view-toggle.tsx
  - apps/web/components/projects/field-card.tsx
  - apps/web/components/projects/batch-field-inventory.tsx
  - apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle between table view and field inventory on any batch"
    - "Field inventory displays a card per field showing name, type badge, presence stats, unique count"
    - "PROFILE_MODE batches default to field inventory view, LIST_MODE defaults to table view"
    - "Skeleton cards display while stats are loading"
    - "Empty state shows when batch has no fields or no rows"
  artifacts:
    - path: "apps/web/components/projects/batch-view-toggle.tsx"
      provides: "Toggle group component for switching between table and field inventory views"
      exports: ["BatchViewToggle"]
    - path: "apps/web/components/projects/field-card.tsx"
      provides: "Individual field card with name, type badge, presence bar, unique count, sample values"
      exports: ["FieldCard"]
    - path: "apps/web/components/projects/batch-field-inventory.tsx"
      provides: "Grid of field cards with search filter, loading skeletons, and empty state"
      exports: ["BatchFieldInventory"]
    - path: "apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx"
      provides: "Batch detail page with view toggle integrating both table and field inventory"
      contains: "BatchViewToggle"
  key_links:
    - from: "apps/web/components/projects/batch-field-inventory.tsx"
      to: "apps/web/lib/query/hooks/use-batches.ts"
      via: "useFieldStats hook call for data fetching"
      pattern: "useFieldStats"
    - from: "apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx"
      to: "apps/web/components/projects/batch-view-toggle.tsx"
      via: "View toggle controls currentView state"
      pattern: "BatchViewToggle"
    - from: "apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx"
      to: "apps/web/components/projects/batch-field-inventory.tsx"
      via: "Conditional render based on currentView state"
      pattern: "BatchFieldInventory"
---

<objective>
Build the field inventory UI: a view toggle component, individual field cards, the field inventory grid with search/filter, and integrate everything into the batch detail page with mode-aware defaults.

Purpose: Enable users to explore per-field metadata (type, presence, uniqueness, sample values) in a visual card grid, with the ability to switch between the existing data table and this new field inventory view.

Output: Three new components (BatchViewToggle, FieldCard, BatchFieldInventory) and an updated batch detail page that conditionally renders either the data table or field inventory based on user toggle selection.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-frontend-field-inventory-grid/19-CONTEXT.md
@.planning/phases/19-frontend-field-inventory-grid/19-RESEARCH.md

# Prior plan output (schema + hook)
@.planning/phases/19-frontend-field-inventory-grid/19-01-SUMMARY.md

# Existing components to follow patterns from
@apps/web/components/projects/batch-detail-header.tsx
@apps/web/components/projects/batch-data-table.tsx
@apps/web/components/projects/batch-table-empty-state.tsx
@apps/web/components/projects/batch-card.tsx

# Page to modify
@apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx

# Types and hooks
@apps/web/lib/api/schemas/field-stats.schema.ts
@apps/web/lib/query/hooks/use-batches.ts
@apps/web/lib/api/schemas/batch.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui components and create view toggle, field card, and field inventory grid</name>
  <files>
    apps/web/components/projects/batch-view-toggle.tsx
    apps/web/components/projects/field-card.tsx
    apps/web/components/projects/batch-field-inventory.tsx
  </files>
  <action>
**Step 0: Install required shadcn/ui components**

Run from `apps/web`:
```bash
pnpm dlx shadcn@latest add toggle-group
pnpm dlx shadcn@latest add progress
```

These are needed for the view toggle and presence progress bars. If `toggle-group` or `progress` already exist, the CLI will skip them.

**Step 1: Create `batch-view-toggle.tsx`**

A compact icon toggle for switching between "table" and "inventory" views.

Props interface:
```typescript
type ViewMode = "table" | "inventory";

interface BatchViewToggleProps {
  value: ViewMode;
  onValueChange: (value: ViewMode) => void;
}
```

Implementation:
- Use shadcn `ToggleGroup` with `type="single"` and `variant="outline"`.
- Two `ToggleGroupItem` items:
  - value="table" with `<TableIcon className="h-4 w-4" />` from lucide-react (import as `Table2` to avoid conflict with shadcn Table)
  - value="inventory" with `<LayoutGrid className="h-4 w-4" />` from lucide-react
- Wrap in a `<div className="flex items-center gap-2">` with a small label `<span className="text-sm text-muted-foreground">Visualizacao:</span>` before the toggle group.
- The ToggleGroup `onValueChange` should guard against empty string (when user clicks already-selected item, ToggleGroup sends ""), and only call `onValueChange` when the new value is truthy.

**Step 2: Create `field-card.tsx`**

Individual field card component showing field metadata.

Props interface:
```typescript
interface FieldCardProps {
  fieldName: string;
  inferredType: string;
  presenceCount: number;
  totalRows: number;
  uniqueCount: number;
  sampleValues: unknown[];
  onClick?: () => void;
}
```

Implementation details:

**Card structure (top to bottom):**
1. **Field name** as `<h3 className="font-semibold text-sm truncate">` — the headline
2. **Type badge** — color-coded based on inferredType:
   - STRING: `bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-200`
   - NUMBER: `bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200`
   - DATE: `bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200`
   - BOOLEAN: `bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200`
   - UNKNOWN: `bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200`
3. **Presence stats** — progress bar + text:
   - Calculate `presencePercent = totalRows > 0 ? Math.round((presenceCount / totalRows) * 100) : 0`
   - Use shadcn `<Progress value={presencePercent} />` component
   - Below progress bar: `<span className="text-xs text-muted-foreground">{presenceCount} de {totalRows} registros ({presencePercent}%)</span>`
   - Progress bar color: use CSS variable override — if presencePercent < 50, add className `[&>div]:bg-amber-500` to tint the progress indicator amber/warning
4. **Unique count** — `<span className="text-xs text-muted-foreground">{uniqueCount} valores unicos</span>`
   - If `uniqueCount === totalRows && totalRows > 0`, add a small indicator: `<Badge variant="outline" className="text-[10px] px-1.5 py-0">ID</Badge>` next to it (signals likely ID/key field)
5. **Sample values** — show up to 3 sample values as muted comma-separated text:
   - `<p className="text-xs text-muted-foreground truncate">{sampleValues.map(String).join(', ')}</p>`
   - Only render this section if sampleValues.length > 0

**Card wrapper:**
- Use shadcn `<Card>` with `className="cursor-pointer transition-all hover:shadow-md hover:-translate-y-0.5"` (matching BatchCard hover pattern)
- Add `onClick` handler on the card
- `<CardContent className="p-4 space-y-3">`
- Uniform height: do NOT use flex-grow or dynamic height. Let content flow naturally but keep consistent padding.

**Step 3: Create `batch-field-inventory.tsx`**

Grid container that fetches field stats and renders field cards.

Props interface:
```typescript
interface BatchFieldInventoryProps {
  projectId: string;
  batchId: string;
  totalRows: number;
}
```

Implementation:

1. **Data fetching**: Call `useFieldStats(projectId, batchId)` from the hook created in Plan 01.

2. **Search filter**:
   - `const [searchQuery, setSearchQuery] = useState("")`
   - Use a simple `<Input placeholder="Filtrar campos..." className="max-w-sm" />` above the grid
   - Import `Input` from `@/components/ui/input`
   - Filter fields: `useMemo` that filters `data?.fields` by whether `fieldName.toLowerCase().includes(searchQuery.toLowerCase())`
   - Debounce is NOT needed here since filtering is client-side on an already-fetched array (no API calls on each keystroke)

3. **Loading state (skeleton cards)**:
   - When `isLoading` is true, render a grid of 8 skeleton cards
   - Each skeleton card: `<Card><CardContent className="p-4 space-y-3">` with:
     - `<Skeleton className="h-4 w-3/4" />` (field name)
     - `<Skeleton className="h-5 w-16" />` (badge)
     - `<Skeleton className="h-2 w-full" />` (progress bar)
     - `<Skeleton className="h-3 w-1/2" />` (stats text)
     - `<Skeleton className="h-3 w-2/3" />` (sample values)
   - Use same grid layout as the real cards

4. **Empty state** (no fields or no rows):
   - If `data` is loaded but `data.fields.length === 0` or `totalRows === 0`:
   - Render an empty state similar to `BatchTableEmptyState` but with field-specific copy:
     - Icon: `<LayoutGrid className="h-12 w-12 text-muted-foreground/50" />`
     - Title: "Nenhum campo encontrado"
     - Description: "Esta importacao nao possui campos para exibir."
   - If search is active and `filteredFields.length === 0` but `data.fields.length > 0`:
     - Show: "Nenhum campo corresponde a busca."

5. **Card grid**:
   - `<div className="grid grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-4">`
   - Map over filtered fields, render `<FieldCard>` for each
   - Pass `onClick` as a no-op for now (Phase 20 will wire it to the side sheet). Use `onClick={() => {}}` to keep the pointer cursor active.
   - Cards appear in original order (fields array from API preserves column order from columnMetadata)

6. **Wrapper**: `<div className="space-y-4">` containing search input then the grid or skeleton or empty state.
  </action>
  <verify>
1. Verify shadcn components installed: `ls apps/web/components/ui/toggle-group.tsx apps/web/components/ui/progress.tsx`
2. Run `npx tsc --noEmit --project apps/web/tsconfig.json` — no type errors
3. Run `npm run lint --filter=@populatte/web` — no lint errors
  </verify>
  <done>
- BatchViewToggle renders a toggle group with table/inventory icons
- FieldCard renders a card with field name, colored type badge, presence progress bar, unique count, and sample values
- BatchFieldInventory fetches field stats, renders filterable card grid with loading skeletons and empty state
- All three components compile and lint clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate view toggle and field inventory into batch detail page</name>
  <files>apps/web/app/(platform)/projects/[id]/batches/[batchId]/page.tsx</files>
  <action>
Modify the batch detail page to add view toggle and conditional rendering of table vs field inventory.

**Changes to BatchDetailPage:**

1. **Add imports:**
   - `import { BatchViewToggle, type ViewMode } from "@/components/projects/batch-view-toggle";`
   - `import { BatchFieldInventory } from "@/components/projects/batch-field-inventory";`

2. **Add view state with mode-aware default:**
   - Add state: `const [currentView, setCurrentView] = useState<ViewMode>("table");`
   - Add a `useEffect` that sets the default view based on batch mode once batch loads:
     ```typescript
     useEffect(() => {
       if (batch) {
         setCurrentView(batch.mode === "PROFILE_MODE" ? "inventory" : "table");
       }
     }, [batch?.mode]); // Only re-run when batch mode changes (not on every batch refetch)
     ```
   - Important: Use `batch?.mode` as the dependency (not `batch`) to avoid resetting the view on every refetch.

3. **Update the loaded content section (where batch.totalRows > 0):**

Replace the current content block (the `<div className="space-y-4">` containing BatchDataTable and pagination) with:

```tsx
{batch.totalRows === 0 ? (
  <BatchTableEmptyState />
) : (
  <div className="space-y-4">
    <BatchViewToggle value={currentView} onValueChange={setCurrentView} />

    {currentView === "table" ? (
      <>
        <BatchDataTable
          batch={batch}
          rows={rowsData?.items ?? []}
          isLoading={rowsLoading}
          isPlaceholderData={isPlaceholderData}
          offset={offset}
        />
        <BatchTablePagination
          total={rowsData?.total ?? batch.totalRows}
          limit={limit}
          offset={offset}
          onPageChange={setOffset}
          onPageSizeChange={handlePageSizeChange}
        />
      </>
    ) : (
      <BatchFieldInventory
        projectId={id}
        batchId={batchId}
        totalRows={batch.totalRows}
      />
    )}
  </div>
)}
```

Key decisions:
- The view toggle appears above content for both views (table AND inventory)
- When switching to table view, the existing pagination state (limit/offset) is preserved
- When switching to inventory view, field stats are fetched via useFieldStats inside BatchFieldInventory (lazy loading)
- The `BatchTableEmptyState` still shows for zero-row batches (no toggle needed)
  </action>
  <verify>
1. Run `npx tsc --noEmit --project apps/web/tsconfig.json` — no type errors
2. Run `npm run lint --filter=@populatte/web` — no lint errors
3. Run `npm run build --filter=@populatte/web` — build succeeds
  </verify>
  <done>
- Batch detail page shows view toggle between header and content
- PROFILE_MODE batches default to field inventory view
- LIST_MODE batches default to table view
- User can freely switch between views
- Table view preserves pagination state across toggles
- Field inventory lazy-loads stats data when selected
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Field inventory grid with view toggle on the batch detail page. Features:
- Toggle between table view (existing) and field inventory (new)
- PROFILE_MODE batches default to field inventory, LIST_MODE defaults to table
- Card grid with field name, colored type badge, presence progress bar, unique count, sample values
- Search/filter input above cards
- Loading skeleton cards
- Empty state for batches with no fields
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev` from project root
2. Navigate to the web app at http://localhost:3000
3. Go to any project with batches
4. Open a LIST_MODE batch — should default to table view, toggle visible above
5. Click the grid icon in the toggle — should switch to field inventory
6. Verify each card shows: field name, type badge (colored), presence bar with percentage, unique count, sample values
7. Type in the search input — cards should filter by field name
8. Open a PROFILE_MODE batch — should default to field inventory view
9. Click the table icon — should switch back to data table with pagination intact
10. Verify loading state: open a batch and observe skeleton cards while field stats load
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project apps/web/tsconfig.json` passes
2. `npm run lint --filter=@populatte/web` passes
3. `npm run build --filter=@populatte/web` succeeds
4. Batch detail page renders view toggle above content
5. PROFILE_MODE batches default to inventory view
6. LIST_MODE batches default to table view
7. Field cards display correct metadata (name, type, presence, unique count, samples)
8. Search input filters cards by field name
9. Skeleton loading state displays 8 placeholder cards
10. Empty state displays when batch has no fields
</verification>

<success_criteria>
- User can toggle between table view and field inventory on any batch
- Field inventory displays a card per field showing name, type badge, presence stats, unique count
- PROFILE_MODE batches default to field inventory view, LIST_MODE defaults to table view
- Skeleton cards display while stats are loading
- Empty state shows when batch has no fields or no rows
- All five Phase 19 success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/19-frontend-field-inventory-grid/19-02-SUMMARY.md`
</output>
