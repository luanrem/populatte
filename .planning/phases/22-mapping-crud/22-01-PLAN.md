---
phase: 22-mapping-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/core/use-cases/mapping/create-mapping.use-case.ts
  - apps/api/src/core/use-cases/mapping/list-mappings.use-case.ts
  - apps/api/src/core/use-cases/mapping/get-mapping.use-case.ts
  - apps/api/src/core/use-cases/mapping/update-mapping.use-case.ts
  - apps/api/src/core/use-cases/mapping/delete-mapping.use-case.ts
  - apps/api/src/core/use-cases/mapping/index.ts
  - apps/api/src/core/use-cases/index.ts
  - apps/api/src/core/repositories/mapping.repository.ts
  - apps/api/src/infrastructure/database/drizzle/repositories/drizzle-mapping.repository.ts
autonomous: true

must_haves:
  truths:
    - "CreateMappingUseCase creates a mapping for a project the user owns"
    - "ListMappingsUseCase returns paginated mappings with stepCount and optional URL/isActive filters"
    - "GetMappingUseCase returns mapping detail with ordered steps"
    - "UpdateMappingUseCase updates name, targetUrl, isActive, successTrigger"
    - "DeleteMappingUseCase soft-deletes mapping"
    - "All use cases validate project ownership before operating on mappings"
  artifacts:
    - path: "apps/api/src/core/use-cases/mapping/create-mapping.use-case.ts"
      provides: "CreateMappingUseCase with ownership validation"
      exports: ["CreateMappingUseCase", "CreateMappingInput"]
    - path: "apps/api/src/core/use-cases/mapping/list-mappings.use-case.ts"
      provides: "ListMappingsUseCase with pagination, URL filter, and isActive filter"
      exports: ["ListMappingsUseCase", "ListMappingsResult", "MappingListItem"]
    - path: "apps/api/src/core/use-cases/mapping/get-mapping.use-case.ts"
      provides: "GetMappingUseCase with steps array"
      exports: ["GetMappingUseCase", "MappingWithSteps"]
    - path: "apps/api/src/core/use-cases/mapping/update-mapping.use-case.ts"
      provides: "UpdateMappingUseCase with ownership validation"
      exports: ["UpdateMappingUseCase"]
    - path: "apps/api/src/core/use-cases/mapping/delete-mapping.use-case.ts"
      provides: "DeleteMappingUseCase with soft-delete"
      exports: ["DeleteMappingUseCase"]
  key_links:
    - from: "use-cases/*"
      to: "ProjectRepository.findByIdOnly"
      via: "ownership validation (404/403 pattern)"
      pattern: "findByIdOnly.*projectId"
    - from: "ListMappingsUseCase"
      to: "MappingRepository.findByProjectIdPaginated"
      via: "paginated query with optional URL and isActive filters"
      pattern: "findByProjectIdPaginated"
    - from: "GetMappingUseCase"
      to: "StepRepository.findByMappingId"
      via: "fetch steps for mapping detail"
      pattern: "findByMappingId"
---

<objective>
Create mapping use cases with ownership validation following established Clean Architecture patterns

Purpose: Deliver the business logic layer for mapping CRUD, enabling users to manage mappings for their projects with proper authorization and soft-delete semantics
Output: 5 use case classes with input/output types, barrel exports, and repository method extensions
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-mapping-crud/22-CONTEXT.md
@.planning/phases/21-domain-foundation/21-01-SUMMARY.md
@.planning/phases/21-domain-foundation/21-02-SUMMARY.md

# Existing patterns to follow
@apps/api/src/core/use-cases/project/create-project.use-case.ts
@apps/api/src/core/use-cases/project/list-projects.use-case.ts
@apps/api/src/core/use-cases/project/get-project.use-case.ts
@apps/api/src/core/use-cases/project/update-project.use-case.ts
@apps/api/src/core/use-cases/project/delete-project.use-case.ts
@apps/api/src/core/use-cases/batch/list-batches.use-case.ts

# Domain entities and repositories
@apps/api/src/core/entities/mapping.entity.ts
@apps/api/src/core/entities/step.entity.ts
@apps/api/src/core/repositories/mapping.repository.ts
@apps/api/src/core/repositories/step.repository.ts
@apps/api/src/core/repositories/project.repository.ts
@apps/api/src/infrastructure/database/drizzle/repositories/drizzle-mapping.repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend MappingRepository with pagination, URL filter, and isActive filter methods</name>
  <files>
    apps/api/src/core/repositories/mapping.repository.ts
    apps/api/src/infrastructure/database/drizzle/repositories/drizzle-mapping.repository.ts
  </files>
  <action>
1. In `mapping.repository.ts`, add these abstract methods:
   - `findByIdWithDeleted(id: string): Promise<Mapping | null>` - Returns mapping even if soft-deleted (for 404/403 separation)
   - `findByProjectIdPaginated(projectId: string, limit: number, offset: number, targetUrl?: string, isActive?: boolean): Promise<{ items: Mapping[]; total: number }>` - Paginated query with optional URL filter and optional isActive filter
   - `countStepsByMappingId(mappingId: string): Promise<number>` - Count steps for stepCount in list items

2. In `drizzle-mapping.repository.ts`, implement:

   **findByIdWithDeleted**: Query by ID only (no deletedAt filter). This enables ownership validation pattern where we first check if mapping exists (404), then check ownership (403).

   **findByProjectIdPaginated**:
   - Build conditions array: start with `eq(mappings.projectId, projectId)` AND `isNull(mappings.deletedAt)`
   - If `targetUrl` provided, add inverted prefix filter: `sql\`${targetUrl} LIKE ${mappings.targetUrl} || '%'\`` (current URL starts with stored targetUrl)
   - If `isActive` is not undefined, add: `eq(mappings.isActive, isActive)` to filter by active status
   - Order by `desc(mappings.createdAt)` (most recent first)
   - Apply limit/offset for pagination
   - Run count query in parallel with data query using `Promise.all`
   - Return `{ items, total }` matching PaginatedResult pattern

   **countStepsByMappingId**: Simple count query on steps table filtered by mappingId. Import `count` from drizzle-orm.

3. Import `desc, sql, count, and` from drizzle-orm as needed.
  </action>
  <verify>
    TypeScript compiles: `cd apps/api && npx tsc --noEmit`
  </verify>
  <done>
    MappingRepository has findByIdWithDeleted, findByProjectIdPaginated (with isActive parameter), countStepsByMappingId methods implemented with soft-delete filtering and inverted URL prefix matching
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mapping use cases with ownership validation</name>
  <files>
    apps/api/src/core/use-cases/mapping/create-mapping.use-case.ts
    apps/api/src/core/use-cases/mapping/list-mappings.use-case.ts
    apps/api/src/core/use-cases/mapping/get-mapping.use-case.ts
    apps/api/src/core/use-cases/mapping/update-mapping.use-case.ts
    apps/api/src/core/use-cases/mapping/delete-mapping.use-case.ts
    apps/api/src/core/use-cases/mapping/index.ts
    apps/api/src/core/use-cases/index.ts
  </files>
  <action>
Create `apps/api/src/core/use-cases/mapping/` directory with 5 use case files:

**create-mapping.use-case.ts:**
```typescript
export interface CreateMappingInput {
  projectId: string;
  userId: string;
  name: string;
  targetUrl: string;
  successTrigger?: SuccessTrigger | null;
  successConfig?: SuccessConfig | null;
}
```
- Inject ProjectRepository, MappingRepository
- Validate project ownership using findByIdOnly pattern (see ListBatchesUseCase)
- If project not found or soft-deleted: 404 NotFoundException
- If project.userId !== userId: 403 ForbiddenException with security log
- Create mapping via repository, return Mapping entity

**list-mappings.use-case.ts:**
```typescript
export interface MappingListItem {
  id: string;
  name: string;
  targetUrl: string;
  isActive: boolean;
  stepCount: number;
  createdAt: Date;
  updatedAt: Date;
}

export interface ListMappingsResult {
  items: MappingListItem[];
  total: number;
  page: number;   // IMPORTANT: Use 'page' not 'offset' per CONTEXT.md
  limit: number;
}
```
- Inject ProjectRepository, MappingRepository
- Validate project ownership (same 404/403 pattern)
- execute() parameters: `projectId: string, userId: string, limit: number, offset: number, targetUrl?: string, isActive?: boolean`
- Call findByProjectIdPaginated with optional targetUrl and isActive filters
- For each mapping, fetch stepCount via countStepsByMappingId (parallelize with Promise.all)
- Calculate `page` from offset: `Math.floor(offset / limit) + 1` (1-indexed page number)
- Return ListMappingsResult with `{ items, total, page, limit }`

**get-mapping.use-case.ts:**
```typescript
export interface MappingWithSteps extends Mapping {
  steps: Step[];
}
```
- Inject ProjectRepository, MappingRepository, StepRepository
- Validate project ownership first
- Find mapping by ID (using soft-delete-aware findById)
- If not found: 404
- Defense-in-depth: verify mapping.projectId === projectId (prevent cross-project access)
- Fetch steps via findByMappingId (already ordered by stepOrder)
- Return MappingWithSteps

**update-mapping.use-case.ts:**
- Inject ProjectRepository, MappingRepository
- Validate project ownership
- Find mapping by ID
- Defense-in-depth check
- Call repository.update with provided data
- Return updated Mapping or throw 404 if update fails

**delete-mapping.use-case.ts:**
- Inject ProjectRepository, MappingRepository
- Validate project ownership
- Find mapping by ID (use findByIdWithDeleted for proper 404 on already-deleted)
- Defense-in-depth check
- Call softDelete
- Return void

**index.ts:** Barrel export all 5 use cases.

**Update `apps/api/src/core/use-cases/index.ts`:** Add `export * from './mapping';`
  </action>
  <verify>
    TypeScript compiles: `cd apps/api && npx tsc --noEmit`
  </verify>
  <done>
    5 use cases exist with proper ownership validation, 404/403 separation, defense-in-depth, correct return types, and ListMappingsResult using 'page' (not 'offset') with isActive filter support
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/api && npx tsc --noEmit`
2. All 5 use cases are exported from barrel file
3. Repository methods support pagination, URL filter, and isActive filter
4. Ownership validation follows established 404/403 pattern from ListBatchesUseCase
5. ListMappingsResult has `page` field (calculated from offset/limit), not `offset` field
</verification>

<success_criteria>
- MappingRepository has findByIdWithDeleted, findByProjectIdPaginated (with isActive param), countStepsByMappingId
- 5 use cases (Create, List, Get, Update, Delete) exist with ownership validation
- All use cases inject repositories and follow Clean Architecture
- Inverted URL prefix matching implemented in findByProjectIdPaginated
- isActive filter implemented in findByProjectIdPaginated and passed through ListMappingsUseCase
- stepCount calculated via parallelized Promise.all in ListMappingsUseCase
- ListMappingsResult uses `page` field (1-indexed, calculated as Math.floor(offset/limit)+1), NOT `offset`
- GetMappingUseCase returns mapping with ordered steps array
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-mapping-crud/22-01-SUMMARY.md`
</output>
