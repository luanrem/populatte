---
phase: 22-mapping-crud
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/api/src/presentation/dto/mapping.dto.ts
  - apps/api/src/presentation/controllers/mapping.controller.ts
  - apps/api/src/infrastructure/mapping/mapping.module.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "POST /projects/:projectId/mappings creates a mapping and returns 201"
    - "GET /projects/:projectId/mappings lists paginated mappings with optional ?targetUrl filter"
    - "GET /projects/:projectId/mappings/:mappingId returns mapping with steps array"
    - "PATCH /projects/:projectId/mappings/:mappingId updates mapping fields"
    - "DELETE /projects/:projectId/mappings/:mappingId soft-deletes and returns 204"
    - "All endpoints require authentication via ClerkAuthGuard"
    - "Validation errors return 400 with detailed error messages"
  artifacts:
    - path: "apps/api/src/presentation/dto/mapping.dto.ts"
      provides: "Zod schemas for create, update, list query DTOs"
      exports: ["createMappingSchema", "updateMappingSchema", "listMappingsQuerySchema", "CreateMappingDto", "UpdateMappingDto", "ListMappingsQueryDto"]
    - path: "apps/api/src/presentation/controllers/mapping.controller.ts"
      provides: "REST endpoints for mapping CRUD"
      exports: ["MappingController"]
    - path: "apps/api/src/infrastructure/mapping/mapping.module.ts"
      provides: "NestJS module wiring use cases to controller"
      exports: ["MappingModule"]
  key_links:
    - from: "MappingController"
      to: "mapping use cases"
      via: "constructor injection"
      pattern: "@Injectable.*CreateMappingUseCase"
    - from: "app.module.ts"
      to: "MappingModule"
      via: "imports array"
      pattern: "MappingModule"
    - from: "MappingController endpoints"
      to: "ClerkAuthGuard"
      via: "@UseGuards decorator"
      pattern: "@UseGuards\\(ClerkAuthGuard\\)"
---

<objective>
Create mapping controller, DTOs, and module wiring for HTTP endpoints

Purpose: Expose mapping CRUD operations via REST API with proper validation, authentication, and response formatting
Output: Mapping endpoints accessible at /projects/:projectId/mappings with full CRUD support
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-mapping-crud/22-CONTEXT.md
@.planning/phases/22-mapping-crud/22-01-SUMMARY.md

# Existing patterns to follow
@apps/api/src/presentation/controllers/project.controller.ts
@apps/api/src/presentation/controllers/batch.controller.ts
@apps/api/src/presentation/dto/project.dto.ts
@apps/api/src/presentation/dto/batch.dto.ts
@apps/api/src/infrastructure/project/project.module.ts
@apps/api/src/infrastructure/batch/batch.module.ts
@apps/api/src/app.module.ts

# Domain entities
@apps/api/src/core/entities/mapping.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mapping DTOs with Zod validation</name>
  <files>
    apps/api/src/presentation/dto/mapping.dto.ts
  </files>
  <action>
Create `apps/api/src/presentation/dto/mapping.dto.ts` with Zod schemas:

```typescript
import { z } from 'zod';
import { SuccessTrigger } from '../../core/entities/mapping.entity';

// Create mapping schema
export const createMappingSchema = z.object({
  name: z.string().min(3).max(100),
  targetUrl: z.string().url(),
  successTrigger: z.nativeEnum(SuccessTrigger).nullable().optional()
    .transform(val => val === '' ? null : val),  // coerce empty string to null
  successConfig: z.object({
    selector: z.string().optional(),
  }).nullable().optional(),
});

// Update mapping schema (all fields optional)
export const updateMappingSchema = z.object({
  name: z.string().min(3).max(100).optional(),
  targetUrl: z.string().url().optional(),
  isActive: z.boolean().optional(),
  successTrigger: z.nativeEnum(SuccessTrigger).nullable().optional()
    .transform(val => val === '' ? null : val),
  successConfig: z.object({
    selector: z.string().optional(),
  }).nullable().optional(),
});

// List query schema with pagination and optional URL filter
export const listMappingsQuerySchema = z.object({
  limit: z.coerce.number().int().min(1).max(100).default(20),
  offset: z.coerce.number().int().min(0).default(0),
  targetUrl: z.string().url().optional(),  // optional filter for extension lookup
  isActive: z.coerce.boolean().optional(), // optional filter (default: show all non-deleted)
});

export type CreateMappingDto = z.infer<typeof createMappingSchema>;
export type UpdateMappingDto = z.infer<typeof updateMappingSchema>;
export type ListMappingsQueryDto = z.infer<typeof listMappingsQuerySchema>;
```

Key validation rules from CONTEXT.md:
- targetUrl must be valid URL with protocol
- name: min 3, max 100 characters
- successTrigger: strict enum validation
- Empty strings coerced to null for optional fields
- Pagination: default 20, max 100
  </action>
  <verify>
    TypeScript compiles: `cd apps/api && npx tsc --noEmit`
  </verify>
  <done>
    mapping.dto.ts exists with createMappingSchema, updateMappingSchema, listMappingsQuerySchema and exported types
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mapping controller and module</name>
  <files>
    apps/api/src/presentation/controllers/mapping.controller.ts
    apps/api/src/infrastructure/mapping/mapping.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
**Create `apps/api/src/presentation/controllers/mapping.controller.ts`:**

Follow ProjectController and BatchController patterns:

```typescript
@Controller('projects/:projectId/mappings')
@UseGuards(ClerkAuthGuard)
export class MappingController {
  public constructor(
    private readonly createMapping: CreateMappingUseCase,
    private readonly listMappings: ListMappingsUseCase,
    private readonly getMapping: GetMappingUseCase,
    private readonly updateMapping: UpdateMappingUseCase,
    private readonly deleteMapping: DeleteMappingUseCase,
  ) {}

  @Post()
  // Returns 201 by default for POST
  // Validates body with ZodValidationPipe
  // Calls createMapping.execute with projectId, user.id, and DTO fields
  // Returns full Mapping entity

  @Get()
  // Validates query with ZodValidationPipe(listMappingsQuerySchema)
  // Calls listMappings.execute with projectId, userId, limit, offset, targetUrl
  // Returns ListMappingsResult

  @Get(':mappingId')
  // Calls getMapping.execute with projectId, mappingId, userId
  // Returns MappingWithSteps

  @Patch(':mappingId')
  // Validates body with ZodValidationPipe(updateMappingSchema)
  // Calls updateMapping.execute
  // Returns updated Mapping

  @Delete(':mappingId')
  @HttpCode(HttpStatus.NO_CONTENT)
  // Calls deleteMapping.execute
  // Returns void (204 No Content)
}
```

Route ordering note: @Get() before @Get(':mappingId') to prevent NestJS path conflicts (same pattern as BatchController).

**Create `apps/api/src/infrastructure/mapping/mapping.module.ts`:**

```typescript
import { Module } from '@nestjs/common';
import {
  CreateMappingUseCase,
  ListMappingsUseCase,
  GetMappingUseCase,
  UpdateMappingUseCase,
  DeleteMappingUseCase,
} from '../../core/use-cases/mapping';
import { MappingController } from '../../presentation/controllers/mapping.controller';

@Module({
  controllers: [MappingController],
  providers: [
    CreateMappingUseCase,
    ListMappingsUseCase,
    GetMappingUseCase,
    UpdateMappingUseCase,
    DeleteMappingUseCase,
  ],
})
export class MappingModule {}
```

**Update `apps/api/src/app.module.ts`:**
- Import MappingModule from './infrastructure/mapping/mapping.module'
- Add MappingModule to imports array
  </action>
  <verify>
    TypeScript compiles: `cd apps/api && npx tsc --noEmit`
    Lint passes: `cd apps/api && npm run lint`
  </verify>
  <done>
    MappingController has 5 endpoints, MappingModule wires use cases, app.module.ts imports MappingModule
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/api && npx tsc --noEmit`
2. Lint passes: `cd apps/api && npm run lint`
3. API starts without errors: `cd apps/api && npm run start:dev` (briefly verify no startup crashes)
4. MappingModule is imported in AppModule
</verification>

<success_criteria>
- mapping.dto.ts has Zod schemas with proper validation rules
- MappingController has 5 endpoints: POST, GET (list), GET (detail), PATCH, DELETE
- All endpoints use ClerkAuthGuard
- POST returns 201, DELETE returns 204
- MappingModule registers all 5 use cases
- AppModule imports MappingModule
- TypeScript compiles and lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/22-mapping-crud/22-02-SUMMARY.md`
</output>
