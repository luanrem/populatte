---
phase: 23-step-crud
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - apps/api/src/presentation/dto/step.dto.ts
  - apps/api/src/presentation/controllers/step.controller.ts
  - apps/api/src/infrastructure/step/step.module.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "POST /mappings/:mappingId/steps creates a step and returns it"
    - "PATCH /mappings/:mappingId/steps/:stepId updates a step and returns it"
    - "DELETE /mappings/:mappingId/steps/:stepId deletes a step (204 No Content)"
    - "PUT /mappings/:mappingId/steps/reorder accepts ordered IDs and returns all steps"
    - "API starts without errors after StepModule is added"
  artifacts:
    - path: "apps/api/src/presentation/dto/step.dto.ts"
      provides: "Zod validation schemas for step CRUD operations"
      exports: ["createStepSchema", "updateStepSchema", "reorderStepsSchema"]
    - path: "apps/api/src/presentation/controllers/step.controller.ts"
      provides: "Step REST endpoints with ClerkAuthGuard"
      exports: ["StepController"]
    - path: "apps/api/src/infrastructure/step/step.module.ts"
      provides: "NestJS module wiring use cases to controller"
      exports: ["StepModule"]
  key_links:
    - from: "StepController"
      to: "CreateStepUseCase"
      via: "dependency injection"
      pattern: "private readonly createStep: CreateStepUseCase"
    - from: "StepModule"
      to: "AppModule"
      via: "module import"
      pattern: "StepModule"
---

<objective>
Create Step REST API endpoints with Zod validation DTOs, StepController with 4 endpoints, and StepModule wiring everything together.

Purpose: Complete the Step CRUD feature by exposing use cases as REST endpoints following established controller patterns.
Output: Working /mappings/:mappingId/steps endpoints integrated into the API.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-step-crud/23-CONTEXT.md

# Reference patterns
@apps/api/src/presentation/dto/mapping.dto.ts
@apps/api/src/presentation/controllers/mapping.controller.ts
@apps/api/src/infrastructure/mapping/mapping.module.ts
@apps/api/src/core/entities/step.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step DTOs with Zod validation</name>
  <files>
    apps/api/src/presentation/dto/step.dto.ts
  </files>
  <action>
Create Zod validation schemas for step operations:

**selectorEntrySchema** (reusable):
```typescript
const selectorEntrySchema = z.object({
  type: z.nativeEnum(SelectorType),
  value: z.string().min(1),
});
```

**createStepSchema:**
- action: z.nativeEnum(StepAction) (required)
- selector: selectorEntrySchema (required)
- selectorFallbacks: z.array(selectorEntrySchema).optional()
- sourceFieldKey: z.string().min(1).optional()
- fixedValue: z.string().optional()
- optional: z.boolean().optional()
- clearBefore: z.boolean().optional()
- pressEnter: z.boolean().optional()
- waitMs: z.number().int().min(0).optional()
- Add .refine() to reject if BOTH sourceFieldKey AND fixedValue are provided (non-empty)

**updateStepSchema:**
- All fields optional (same types as create)
- Same .refine() for sourceFieldKey/fixedValue mutual exclusion

**reorderStepsSchema:**
- orderedStepIds: z.array(z.string().uuid()).min(1)
- Add .refine() to reject duplicate IDs

Export types:
- CreateStepDto, UpdateStepDto, ReorderStepsDto
  </action>
  <verify>
Run `npm run type-check --filter=@populatte/api` - no TypeScript errors
  </verify>
  <done>
Step DTOs exist with Zod validation including mutual exclusion and duplicate checks
  </done>
</task>

<task type="auto">
  <name>Task 2: Create step controller and module, wire to app</name>
  <files>
    apps/api/src/presentation/controllers/step.controller.ts
    apps/api/src/infrastructure/step/step.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
**StepController at /mappings/:mappingId/steps:**

Follow MappingController patterns exactly:
- @Controller('mappings/:mappingId/steps')
- @UseGuards(ClerkAuthGuard)
- Inject all 4 use cases via constructor

**Endpoints:**

1. POST / (create step)
   - @Post()
   - @Body with ZodValidationPipe(createStepSchema)
   - @Param('mappingId')
   - @CurrentUser() user
   - Call createStep.execute({ mappingId, userId: user.id, ...body })
   - Returns created Step (implicit 201)

2. PATCH /:stepId (update step)
   - @Patch(':stepId')
   - @Body with ZodValidationPipe(updateStepSchema)
   - @Param('mappingId'), @Param('stepId')
   - @CurrentUser() user
   - Call updateStep.execute({ stepId, mappingId, userId: user.id, ...body })
   - Returns updated Step

3. DELETE /:stepId (delete step)
   - @Delete(':stepId')
   - @HttpCode(HttpStatus.NO_CONTENT)
   - @Param('mappingId'), @Param('stepId')
   - @CurrentUser() user
   - Call deleteStep.execute({ stepId, mappingId, userId: user.id })
   - Returns void (204)

4. PUT /reorder (reorder steps)
   - @Put('reorder')
   - @Body with ZodValidationPipe(reorderStepsSchema)
   - @Param('mappingId')
   - @CurrentUser() user
   - Call reorderSteps.execute({ mappingId, userId: user.id, orderedStepIds: body.orderedStepIds })
   - Returns Step[]

**StepModule:**
- @Module decorator
- controllers: [StepController]
- providers: [CreateStepUseCase, UpdateStepUseCase, DeleteStepUseCase, ReorderStepsUseCase]

**AppModule:**
- Add StepModule to imports array (after MappingModule)

**Verification:**
- Start API: `npm run dev --filter=@populatte/api`
- Check no errors in console
  </action>
  <verify>
Run `npm run dev --filter=@populatte/api` - API starts without errors
Run `npm run type-check --filter=@populatte/api` - no TypeScript errors
Run `npm run lint --filter=@populatte/api` - no linting errors
  </verify>
  <done>
StepController exposes 4 endpoints, StepModule wires everything, API runs successfully
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run type-check --filter=@populatte/api`
2. Linting passes: `npm run lint --filter=@populatte/api`
3. API starts: `npm run dev --filter=@populatte/api` without errors
4. All expected files exist with proper exports
</verification>

<success_criteria>
- POST /mappings/:mappingId/steps creates step with auto-assigned order
- PATCH /mappings/:mappingId/steps/:stepId updates step fields
- DELETE /mappings/:mappingId/steps/:stepId returns 204 No Content
- PUT /mappings/:mappingId/steps/reorder accepts orderedStepIds and returns all steps
- Zod rejects if both sourceFieldKey and fixedValue are provided
- Zod rejects duplicate IDs in reorder request
- API starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-step-crud/23-02-SUMMARY.md`
</output>
