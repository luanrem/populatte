---
phase: 24-extension-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/extension/package.json
  - apps/extension/wxt.config.ts
  - apps/extension/tsconfig.json
  - apps/extension/entrypoints/popup/index.html
  - apps/extension/entrypoints/popup/main.tsx
  - apps/extension/entrypoints/popup/App.tsx
  - apps/extension/entrypoints/background.ts
  - apps/extension/entrypoints/content.ts
  - apps/extension/styles/globals.css
  - apps/extension/public/icon-16.png
  - apps/extension/public/icon-32.png
  - apps/extension/public/icon-48.png
  - apps/extension/public/icon-128.png
autonomous: true

must_haves:
  truths:
    - "Extension loads in Chrome developer mode without errors"
    - "Popup opens when clicking extension icon"
    - "Service worker initializes on extension load"
    - "Content script injects into web pages"
  artifacts:
    - path: "apps/extension/package.json"
      provides: "Extension package configuration"
      contains: "wxt"
    - path: "apps/extension/wxt.config.ts"
      provides: "WXT build configuration"
      contains: "defineConfig"
    - path: "apps/extension/entrypoints/popup/App.tsx"
      provides: "React popup root component"
      contains: "Populatte"
    - path: "apps/extension/entrypoints/background.ts"
      provides: "Service worker entry"
      contains: "defineBackground"
    - path: "apps/extension/entrypoints/content.ts"
      provides: "Content script entry"
      contains: "defineContentScript"
  key_links:
    - from: "apps/extension/wxt.config.ts"
      to: "manifest generation"
      via: "WXT convention"
      pattern: "manifest:"
    - from: "apps/extension/entrypoints/popup/main.tsx"
      to: "apps/extension/entrypoints/popup/App.tsx"
      via: "React render"
      pattern: "createRoot.*App"
---

<objective>
Scaffold the Chrome extension using WXT framework with all three execution contexts (popup, background, content script) working.

Purpose: Establish the extension infrastructure that all subsequent phases build upon. This is the foundation for auth, popup UI, and content script functionality.

Output: A working Chrome extension that loads in developer mode with React popup, service worker, and content script ready for feature implementation.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-extension-foundation/24-CONTEXT.md
@.planning/research/STACK-extension.md
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize WXT project with React</name>
  <files>
    apps/extension/package.json
    apps/extension/wxt.config.ts
    apps/extension/tsconfig.json
    apps/extension/styles/globals.css
  </files>
  <action>
Create the apps/extension directory structure from scratch (do NOT use npx wxt init as it's interactive).

1. Create `apps/extension/package.json`:
```json
{
  "name": "@populatte/extension",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "wxt",
    "dev:firefox": "wxt -b firefox",
    "build": "wxt build",
    "build:firefox": "wxt build -b firefox",
    "zip": "wxt zip",
    "lint": "eslint entrypoints src",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "lucide-react": "0.555.0"
  },
  "devDependencies": {
    "wxt": "^0.20.13",
    "@wxt-dev/module-react": "^1.1.5",
    "@types/chrome": "^0.0.287",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "typescript": "^5",
    "tailwindcss": "^4",
    "@tailwindcss/vite": "^4"
  }
}
```

2. Create `apps/extension/wxt.config.ts`:
```typescript
import { defineConfig } from 'wxt';
import tailwindcss from '@tailwindcss/vite';

export default defineConfig({
  modules: ['@wxt-dev/module-react'],
  manifest: {
    name: 'Populatte',
    description: 'Automate web form filling from your data',
    permissions: ['storage', 'activeTab', 'scripting'],
    host_permissions: ['<all_urls>'],
    action: {
      default_title: 'Populatte',
    },
  },
  vite: () => ({
    plugins: [tailwindcss()],
    resolve: {
      alias: {
        '@': './src',
      },
    },
  }),
});
```

3. Create `apps/extension/tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "react-jsx",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "noUncheckedIndexedAccess": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "types": ["chrome"]
  },
  "include": ["src", "entrypoints", "wxt.config.ts", ".wxt/types"],
  "exclude": ["node_modules", ".output"]
}
```

4. Create `apps/extension/styles/globals.css`:
```css
@import "tailwindcss";
```
  </action>
  <verify>
    Files exist: `ls apps/extension/package.json apps/extension/wxt.config.ts apps/extension/tsconfig.json apps/extension/styles/globals.css`
  </verify>
  <done>WXT project configuration files created with React, Tailwind, and TypeScript support</done>
</task>

<task type="auto">
  <name>Task 2: Create extension entrypoints</name>
  <files>
    apps/extension/entrypoints/popup/index.html
    apps/extension/entrypoints/popup/main.tsx
    apps/extension/entrypoints/popup/App.tsx
    apps/extension/entrypoints/background.ts
    apps/extension/entrypoints/content.ts
    apps/extension/public/icon-16.png
    apps/extension/public/icon-32.png
    apps/extension/public/icon-48.png
    apps/extension/public/icon-128.png
  </files>
  <action>
1. Create `apps/extension/entrypoints/popup/index.html`:
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Populatte</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="./main.tsx"></script>
  </body>
</html>
```

2. Create `apps/extension/entrypoints/popup/main.tsx`:
```tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import '../../styles/globals.css';

const root = document.getElementById('root');
if (root) {
  ReactDOM.createRoot(root).render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
}
```

3. Create `apps/extension/entrypoints/popup/App.tsx`:
```tsx
import { Coffee } from 'lucide-react';

export default function App() {
  return (
    <div className="w-[350px] h-[500px] bg-white p-4">
      <header className="flex items-center gap-2 mb-4 pb-3 border-b">
        <Coffee className="w-6 h-6 text-amber-700" />
        <h1 className="text-lg font-semibold text-gray-900">Populatte</h1>
      </header>

      <main className="space-y-4">
        <div className="p-3 bg-amber-50 rounded-lg border border-amber-200">
          <p className="text-sm text-amber-800">
            Extension loaded successfully. Ready for auth integration.
          </p>
        </div>

        <div className="text-xs text-gray-500">
          <p>Status: Disconnected</p>
          <p>Version: 0.1.0</p>
        </div>
      </main>
    </div>
  );
}
```

4. Create `apps/extension/entrypoints/background.ts`:
```typescript
export default defineBackground(() => {
  console.log('[Populatte] Service worker initialized');

  // Register message listener at top level (critical for SW restart handling)
  browser.runtime.onMessage.addListener((message, sender, sendResponse) => {
    console.log('[Populatte] Message received:', message.type);

    if (message.type === 'PING') {
      return Promise.resolve({ success: true, pong: true });
    }

    return false;
  });

  // Log when extension is installed or updated
  browser.runtime.onInstalled.addListener((details) => {
    console.log('[Populatte] Extension installed/updated:', details.reason);
  });
});
```

5. Create `apps/extension/entrypoints/content.ts`:
```typescript
export default defineContentScript({
  matches: ['<all_urls>'],
  runAt: 'document_idle',

  main() {
    console.log('[Populatte] Content script loaded on:', window.location.hostname);

    // Register message listener
    browser.runtime.onMessage.addListener((message, sender) => {
      console.log('[Populatte] Content script received:', message.type);

      if (message.type === 'PING') {
        return Promise.resolve({ success: true, context: 'content' });
      }

      return false;
    });
  },
});
```

6. Create placeholder icons (simple colored squares for now):
   - Create `apps/extension/public/` directory
   - Generate simple SVG-based PNG icons using Node.js canvas or use placeholder solid color images

   For placeholder icons, create a simple script or manually create 16x16, 32x32, 48x48, 128x128 PNG files with amber/coffee color (#B45309).

   Alternative: Download a coffee cup icon from lucide or similar, or create minimal placeholders:

   Since we need actual PNG files, use this approach - create a simple Node script in the extension directory:

   ```bash
   cd apps/extension
   # Create public directory
   mkdir -p public

   # Use ImageMagick or similar to create placeholder icons (if available)
   # Or create base64 encoded minimal PNGs programmatically
   ```

   For MVP, create minimal 1-color PNG placeholders. The icons can be replaced with proper designs later.

   Create `apps/extension/scripts/generate-icons.js`:
   ```javascript
   // This script generates simple placeholder icons
   // Run with: node scripts/generate-icons.js
   import { writeFileSync, mkdirSync } from 'fs';

   // Simple 1x1 amber PNG base64 repeated to create icons
   // In practice, use proper icon generation tool
   const sizes = [16, 32, 48, 128];

   // Placeholder: Create empty files that will be replaced with real icons
   mkdirSync('public', { recursive: true });

   sizes.forEach(size => {
     // Create a minimal valid PNG (1x1 amber pixel, then scale)
     // For now, just create placeholder files
     writeFileSync(`public/icon-${size}.png`, Buffer.from([
       0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, // PNG signature
       0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, // IHDR chunk
       0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, // 1x1
       0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53,
       0xDE, 0x00, 0x00, 0x00, 0x0C, 0x49, 0x44, 0x41,
       0x54, 0x08, 0xD7, 0x63, 0xF8, 0xCF, 0xC0, 0x00,
       0x00, 0x00, 0x03, 0x00, 0x01, 0x00, 0x18, 0xDD,
       0x8D, 0xB4, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45,
       0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82
     ]));
     console.log(`Created icon-${size}.png`);
   });
   ```

   Actually, simpler approach - just create the PNG files directly with proper icon data. Use a coffee-colored 1-pixel PNG that WXT will use as placeholder.
  </action>
  <verify>
    Files exist: `ls apps/extension/entrypoints/popup/index.html apps/extension/entrypoints/popup/main.tsx apps/extension/entrypoints/popup/App.tsx apps/extension/entrypoints/background.ts apps/extension/entrypoints/content.ts apps/extension/public/icon-*.png`
  </verify>
  <done>All three extension contexts (popup, background, content) have entry files, and placeholder icons exist</done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies and verify extension loads</name>
  <files>
    apps/extension/node_modules
    apps/extension/.output
  </files>
  <action>
1. Install dependencies:
```bash
cd apps/extension
npm install
```

2. Build the extension:
```bash
npm run build
```

3. Verify build output exists:
```bash
ls -la .output/chrome-mv3
```

The build should produce:
- `.output/chrome-mv3/manifest.json`
- `.output/chrome-mv3/popup.html`
- `.output/chrome-mv3/background.js`
- `.output/chrome-mv3/content-scripts/content.js`

4. Instructions for manual Chrome verification (to be done by user):
   - Open Chrome and go to `chrome://extensions`
   - Enable "Developer mode" (toggle in top right)
   - Click "Load unpacked"
   - Select the `apps/extension/.output/chrome-mv3` directory
   - Extension should appear in toolbar
   - Click extension icon - popup should open showing "Populatte" header

Note: The actual Chrome loading is verified via checkpoint in subsequent phase. For now, verify the build succeeds.
  </action>
  <verify>
    `cd apps/extension && npm run build && ls .output/chrome-mv3/manifest.json`
  </verify>
  <done>Extension builds successfully and produces valid Chrome extension output</done>
</task>

</tasks>

<verification>
1. `apps/extension/package.json` exists with wxt and react dependencies
2. `apps/extension/wxt.config.ts` configures manifest with Populatte name and permissions
3. `apps/extension/entrypoints/popup/App.tsx` renders React component
4. `apps/extension/entrypoints/background.ts` exports defineBackground
5. `apps/extension/entrypoints/content.ts` exports defineContentScript
6. `npm run build` in apps/extension succeeds
7. `.output/chrome-mv3/manifest.json` contains correct name and permissions
</verification>

<success_criteria>
- WXT project structure created at apps/extension
- All three entrypoints (popup, background, content) defined
- TypeScript and Tailwind CSS configured
- Extension builds without errors
- Build output contains valid manifest.json with "Populatte" name
</success_criteria>

<output>
After completion, create `.planning/phases/24-extension-foundation/24-01-SUMMARY.md`
</output>
