---
phase: 25-backend-extensions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/infrastructure/database/drizzle/schema/extension-codes.schema.ts
  - apps/api/src/infrastructure/database/drizzle/schema/index.ts
  - apps/api/src/infrastructure/config/extension.config.ts
  - apps/api/src/infrastructure/config/env.validation.ts
  - apps/api/src/infrastructure/config/index.ts
  - apps/api/src/infrastructure/auth/extension-auth.service.ts
  - apps/api/src/infrastructure/auth/guards/extension-auth.guard.ts
  - apps/api/src/infrastructure/auth/auth.module.ts
  - apps/api/src/presentation/controllers/extension-auth.controller.ts
  - apps/api/src/presentation/controllers/index.ts
  - apps/api/src/presentation/dto/extension-auth.dto.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Web app can generate a 6-digit connection code that expires in 5 minutes"
    - "Extension can exchange valid code for 30-day JWT (code becomes invalid after use)"
    - "Extension can validate token and retrieve user info via /auth/me"
    - "5 invalid code attempts triggers 15-minute lockout"
    - "Only one active code per user (new code invalidates old)"
  artifacts:
    - path: "apps/api/src/infrastructure/database/drizzle/schema/extension-codes.schema.ts"
      provides: "Connection code database table with userId, code, expiresAt, usedAt"
      contains: "pgTable"
    - path: "apps/api/src/infrastructure/auth/extension-auth.service.ts"
      provides: "Code generation, exchange, JWT sign/verify, lockout tracking"
      exports: ["ExtensionAuthService"]
    - path: "apps/api/src/infrastructure/auth/guards/extension-auth.guard.ts"
      provides: "Guard for extension-authenticated endpoints"
      exports: ["ExtensionAuthGuard"]
    - path: "apps/api/src/presentation/controllers/extension-auth.controller.ts"
      provides: "Auth endpoints for extension"
      exports: ["ExtensionAuthController"]
  key_links:
    - from: "extension-auth.controller.ts"
      to: "extension-auth.service.ts"
      via: "dependency injection"
      pattern: "ExtensionAuthService"
    - from: "extension-auth.service.ts"
      to: "extension-codes.schema.ts"
      via: "drizzle query"
      pattern: "extensionCodes"
    - from: "extension-auth.guard.ts"
      to: "extension-auth.service.ts"
      via: "token verification"
      pattern: "verifyExtensionToken"
---

<objective>
Implement extension authentication system with connection code flow.

Purpose: Enable Chrome extension to authenticate via 6-digit codes generated in web app, receive 30-day JWTs, and access protected endpoints. This is the backend foundation for Phase 26's extension auth UI.

Output: Three working endpoints: POST /auth/extension-code (web app generates code), POST /auth/extension-token (extension exchanges code), GET /auth/extension-me (extension validates token)
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-backend-extensions/25-CONTEXT.md

# Existing patterns to follow
@apps/api/src/infrastructure/auth/clerk.service.ts
@apps/api/src/infrastructure/auth/guards/clerk-auth.guard.ts
@apps/api/src/infrastructure/database/drizzle/schema/users.schema.ts
@apps/api/src/presentation/controllers/user.controller.ts
@apps/api/src/infrastructure/config/clerk.config.ts
@apps/api/src/infrastructure/config/env.validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extension auth infrastructure</name>
  <files>
    apps/api/src/infrastructure/database/drizzle/schema/extension-codes.schema.ts
    apps/api/src/infrastructure/database/drizzle/schema/index.ts
    apps/api/src/infrastructure/config/extension.config.ts
    apps/api/src/infrastructure/config/env.validation.ts
    apps/api/src/infrastructure/config/index.ts
    apps/api/src/infrastructure/auth/extension-auth.service.ts
    apps/api/src/infrastructure/auth/auth.module.ts
  </files>
  <action>
    1. Create extension-codes.schema.ts:
       - Table: extension_codes
       - Fields: id (uuid pk), userId (uuid, references users.id), code (text, 6 digits), expiresAt (timestamp), usedAt (timestamp nullable), createdAt (timestamp)
       - Index on code for fast lookup
       - Index on userId for finding existing codes

    2. Export from schema/index.ts

    3. Create extension.config.ts (follow clerk.config.ts pattern):
       - EXTENSION_JWT_SECRET: Required secret for signing extension JWTs
       - EXTENSION_JWT_EXPIRY: Default '30d' for 30-day tokens

    4. Update env.validation.ts:
       - Add EXTENSION_JWT_SECRET (required string)
       - Add EXTENSION_JWT_EXPIRY (optional, default '30d')

    5. Export from config/index.ts

    6. Create extension-auth.service.ts:
       - Injectable service with DrizzleService and config injection
       - generateCode(userId: string): Promise<string>
         - Invalidate existing codes for user (set usedAt = now)
         - Generate 6-digit numeric code (crypto.randomInt)
         - Store with 5-minute expiry
         - Return code string
       - exchangeCode(code: string): Promise<{token: string, user: User} | null>
         - Check lockout (track failed attempts in memory Map with userId from code lookup)
         - Find code that matches, not expired, not used
         - If not found or expired: increment lockout counter, return null
         - Mark code as used (set usedAt)
         - Sign JWT with userId in payload using jose library
         - Return token and user object
       - verifyExtensionToken(token: string): Promise<{userId: string} | null>
         - Verify JWT signature and expiry using jose
         - Return payload with userId or null
       - Private lockout Map: userId -> {failedAttempts: number, lockedUntil: Date}
         - 5 failed attempts -> 15 minute lockout
         - Reset on successful exchange

    Use jose library for JWT (already used in ecosystem, no CommonJS issues).
    Import User entity from core layer.
  </action>
  <verify>
    npm run lint --filter=@populatte/api
    npm run type-check --filter=@populatte/api
  </verify>
  <done>
    - extension_codes table schema exists with proper fields and indexes
    - ExtensionAuthService injectable with generateCode, exchangeCode, verifyExtensionToken methods
    - Config validated on startup (EXTENSION_JWT_SECRET required)
  </done>
</task>

<task type="auto">
  <name>Task 2: Auth guard and controller endpoints</name>
  <files>
    apps/api/src/infrastructure/auth/guards/extension-auth.guard.ts
    apps/api/src/infrastructure/auth/auth.module.ts
    apps/api/src/presentation/dto/extension-auth.dto.ts
    apps/api/src/presentation/controllers/extension-auth.controller.ts
    apps/api/src/presentation/controllers/index.ts
    apps/api/src/app.module.ts
  </files>
  <action>
    1. Create extension-auth.guard.ts (follow clerk-auth.guard.ts pattern):
       - Implements CanActivate
       - Injects ExtensionAuthService and UserRepository
       - Extracts Bearer token from Authorization header
       - Calls verifyExtensionToken to get userId
       - Fetches User from UserRepository.findById(userId)
       - Sets request.user if valid, throws UnauthorizedException otherwise
       - Export AuthenticatedRequest interface (same as ClerkAuthGuard)

    2. Update auth.module.ts:
       - Add ExtensionAuthService and ExtensionAuthGuard to providers
       - Export both

    3. Create extension-auth.dto.ts with Zod schemas:
       - generateCodeResponseSchema: { code: string, expiresIn: number }
       - exchangeCodeSchema: { code: z.string().length(6).regex(/^\d+$/) }
       - exchangeCodeResponseSchema: { token: string }
       - meResponseSchema: User shape subset (id, email, firstName, lastName, imageUrl)

    4. Create extension-auth.controller.ts:
       - @Controller('auth')

       POST /auth/extension-code:
       - @UseGuards(ClerkAuthGuard) - only authenticated web users can generate
       - @CurrentUser() user: User
       - Calls extensionAuthService.generateCode(user.id)
       - Returns { code, expiresIn: 300 } (5 minutes in seconds)

       POST /auth/extension-token:
       - NO guard (public endpoint for extension)
       - @Body() validated with ZodValidationPipe(exchangeCodeSchema)
       - Calls extensionAuthService.exchangeCode(code)
       - If null: throw UnauthorizedException('Invalid or expired code')
       - Returns { token }

       GET /auth/extension-me:
       - @UseGuards(ExtensionAuthGuard)
       - @CurrentUser() user: User
       - Returns user subset (id, email, firstName, lastName, imageUrl)

    5. Export from controllers/index.ts

    6. Update app.module.ts:
       - Import ExtensionAuthController in controllers array
  </action>
  <verify>
    npm run lint --filter=@populatte/api
    npm run type-check --filter=@populatte/api
    npm run build --filter=@populatte/api
  </verify>
  <done>
    - ExtensionAuthGuard validates extension JWT tokens
    - POST /auth/extension-code generates 6-digit code (requires web auth)
    - POST /auth/extension-token exchanges code for JWT (public)
    - GET /auth/extension-me returns user info (requires extension auth)
    - API builds without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Generate and push migration:
   ```bash
   cd apps/api
   npm run db:generate
   npm run db:push
   ```

2. Manual endpoint test (with API running):
   ```bash
   # Start API
   npm run dev --filter=@populatte/api

   # Get a valid Clerk token from web app dev tools, then:

   # Generate code (replace TOKEN)
   curl -X POST http://localhost:3001/auth/extension-code \
     -H "Authorization: Bearer TOKEN" \
     -H "Content-Type: application/json"
   # Expected: {"code":"123456","expiresIn":300}

   # Exchange code for extension token
   curl -X POST http://localhost:3001/auth/extension-token \
     -H "Content-Type: application/json" \
     -d '{"code":"123456"}'
   # Expected: {"token":"eyJ..."}

   # Validate extension token
   curl http://localhost:3001/auth/extension-me \
     -H "Authorization: Bearer EXTENSION_TOKEN"
   # Expected: User object
   ```
</verification>

<success_criteria>
- POST /auth/extension-code returns 6-digit code with ClerkAuthGuard
- POST /auth/extension-token exchanges code for 30-day JWT
- GET /auth/extension-me returns user info with ExtensionAuthGuard
- Code can only be used once
- New code generation invalidates previous codes
- 5 failed attempts trigger lockout (visible in logs if tested)
</success_criteria>

<output>
After completion, create `.planning/phases/25-backend-extensions/25-01-SUMMARY.md`
</output>
