---
phase: 25-backend-extensions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/core/entities/row.entity.ts
  - apps/api/src/core/repositories/row.repository.ts
  - apps/api/src/core/use-cases/row/update-row-status.use-case.ts
  - apps/api/src/core/use-cases/row/index.ts
  - apps/api/src/infrastructure/database/drizzle/repositories/drizzle-row.repository.ts
  - apps/api/src/presentation/dto/row.dto.ts
  - apps/api/src/presentation/controllers/batch.controller.ts
  - apps/api/src/infrastructure/batch/batch.module.ts
autonomous: true

must_haves:
  truths:
    - "Extension can update row status to PENDING, VALID, or ERROR"
    - "ERROR status includes optional error message and failed step identifier"
    - "VALID is final (cannot be reset)"
    - "ERROR can be reset to PENDING for retry"
    - "Ownership validation follows existing 404/403 pattern"
  artifacts:
    - path: "apps/api/src/core/use-cases/row/update-row-status.use-case.ts"
      provides: "Use case with ownership validation and status transition rules"
      exports: ["UpdateRowStatusUseCase"]
    - path: "apps/api/src/infrastructure/database/drizzle/repositories/drizzle-row.repository.ts"
      provides: "updateStatus method for row repository"
      contains: "updateStatus"
    - path: "apps/api/src/presentation/controllers/batch.controller.ts"
      provides: "PATCH endpoint for row status"
      contains: "@Patch"
  key_links:
    - from: "batch.controller.ts"
      to: "update-row-status.use-case.ts"
      via: "dependency injection"
      pattern: "UpdateRowStatusUseCase"
    - from: "update-row-status.use-case.ts"
      to: "row.repository.ts"
      via: "updateStatus call"
      pattern: "rowRepository.updateStatus"
---

<objective>
Implement row status update endpoint for extension fill operations.

Purpose: Allow extension to track fill results by updating row status to PENDING (retry), VALID (success), or ERROR (failed with details). This enables the fill cycle integration in Phase 29.

Output: PATCH /projects/:projectId/batches/:batchId/rows/:rowId endpoint that updates row status with ownership validation
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-backend-extensions/25-CONTEXT.md

# Existing patterns to follow
@apps/api/src/core/entities/row.entity.ts
@apps/api/src/core/repositories/row.repository.ts
@apps/api/src/core/use-cases/batch/get-batch.use-case.ts
@apps/api/src/infrastructure/database/drizzle/repositories/drizzle-row.repository.ts
@apps/api/src/presentation/controllers/batch.controller.ts
@apps/api/src/infrastructure/database/drizzle/schema/ingestion-rows.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Row entity and repository updates</name>
  <files>
    apps/api/src/core/entities/row.entity.ts
    apps/api/src/core/repositories/row.repository.ts
    apps/api/src/infrastructure/database/drizzle/schema/ingestion-rows.schema.ts
    apps/api/src/infrastructure/database/drizzle/repositories/drizzle-row.repository.ts
    apps/api/src/infrastructure/database/drizzle/mappers/row.mapper.ts
  </files>
  <action>
    1. Update row.entity.ts:
       - Add FillStatus enum alongside existing RowStatus:
         ```typescript
         export enum FillStatus {
           Pending = 'PENDING',
           Valid = 'VALID',
           Error = 'ERROR',
         }
         ```
       - Add to Row interface:
         - fillStatus: FillStatus (default PENDING)
         - fillErrorMessage: string | null
         - fillErrorStep: string | null (identifier of failed step)
         - fillUpdatedAt: Date | null

       - Add UpdateRowStatusData interface:
         ```typescript
         export interface UpdateRowStatusData {
           fillStatus: FillStatus;
           fillErrorMessage?: string | null;
           fillErrorStep?: string | null;
         }
         ```

    2. Update ingestion-rows.schema.ts:
       - Add fillStatusEnum pgEnum: ['PENDING', 'VALID', 'ERROR']
       - Add columns:
         - fillStatus: fillStatusEnum, default 'PENDING'
         - fillErrorMessage: text, nullable
         - fillErrorStep: text, nullable
         - fillUpdatedAt: timestamp with timezone, nullable

    3. Update row.mapper.ts:
       - Map new fields in toDomain (fillStatus, fillErrorMessage, fillErrorStep, fillUpdatedAt)
       - Handle default PENDING for fillStatus if null

    4. Update row.repository.ts:
       - Add findById(id: string): Promise<Row | null>
       - Add updateStatus(id: string, data: UpdateRowStatusData): Promise<Row>

    5. Update drizzle-row.repository.ts:
       - Implement findById:
         - Query by id, isNull deletedAt
         - Return mapped Row or null

       - Implement updateStatus:
         - Update fillStatus, fillErrorMessage, fillErrorStep
         - Set fillUpdatedAt = now(), updatedAt = now()
         - Return updated Row
  </action>
  <verify>
    npm run lint --filter=@populatte/api
    npm run type-check --filter=@populatte/api
  </verify>
  <done>
    - FillStatus enum exists with PENDING, VALID, ERROR values
    - Row entity includes fillStatus, fillErrorMessage, fillErrorStep, fillUpdatedAt
    - RowRepository has findById and updateStatus methods
    - DrizzleRowRepository implements both methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Use case and controller endpoint</name>
  <files>
    apps/api/src/core/use-cases/row/update-row-status.use-case.ts
    apps/api/src/core/use-cases/row/index.ts
    apps/api/src/core/use-cases/index.ts
    apps/api/src/presentation/dto/row.dto.ts
    apps/api/src/presentation/controllers/batch.controller.ts
    apps/api/src/infrastructure/batch/batch.module.ts
  </files>
  <action>
    1. Create update-row-status.use-case.ts:
       - Follow get-batch.use-case.ts ownership validation pattern exactly:
         - Step 1: Find project WITHOUT userId filter
         - Step 2: Check if soft-deleted (404)
         - Step 3: Validate ownership (403 with security log)
         - Step 4: Find batch, verify belongs to project
         - Step 5: Find row, verify belongs to batch

       - Status transition rules:
         - From any -> PENDING: allowed
         - From any -> VALID: allowed (final)
         - From any -> ERROR: allowed
         - From VALID -> anything: throw BadRequestException('Cannot change status of completed row')

       - Execute update via rowRepository.updateStatus()
       - Return updated Row

    2. Create core/use-cases/row/index.ts:
       - Export UpdateRowStatusUseCase

    3. Update core/use-cases/index.ts:
       - Export from './row'

    4. Create presentation/dto/row.dto.ts:
       - Import FillStatus from core/entities/row.entity
       - updateRowStatusSchema with Zod:
         ```typescript
         export const updateRowStatusSchema = z.object({
           fillStatus: z.nativeEnum(FillStatus),
           fillErrorMessage: z.string().max(1000).nullish(),
           fillErrorStep: z.string().max(100).nullish(),
         }).refine(
           (data) => {
             // If ERROR, should have error info (warning, not block)
             // If PENDING/VALID, error fields should be null
             if (data.fillStatus !== FillStatus.Error) {
               return true; // Allow clearing error fields
             }
             return true; // Allow ERROR without message (edge case)
           }
         );
         ```
       - Export UpdateRowStatusDto type

    5. Update batch.controller.ts:
       - Inject UpdateRowStatusUseCase in constructor
       - Add PATCH ':batchId/rows/:rowId/status' endpoint:
         ```typescript
         @Patch(':batchId/rows/:rowId/status')
         public async updateRowStatus(
           @Param('projectId') projectId: string,
           @Param('batchId') batchId: string,
           @Param('rowId') rowId: string,
           @Body(new ZodValidationPipe(updateRowStatusSchema))
           body: UpdateRowStatusDto,
           @CurrentUser() user: User,
         ) {
           return this.updateRowStatusUseCase.execute(
             projectId,
             batchId,
             rowId,
             user.id,
             body,
           );
         }
         ```

    6. Update batch.module.ts:
       - Import UpdateRowStatusUseCase
       - Add to providers array
  </action>
  <verify>
    npm run lint --filter=@populatte/api
    npm run type-check --filter=@populatte/api
    npm run build --filter=@populatte/api
  </verify>
  <done>
    - UpdateRowStatusUseCase follows ownership validation pattern
    - Status transitions enforced (VALID is final)
    - PATCH endpoint at /projects/:id/batches/:id/rows/:id/status
    - Request body validated with Zod
    - API builds without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Generate and push migration:
   ```bash
   cd apps/api
   npm run db:generate
   npm run db:push
   ```

2. Manual endpoint test (with API running and a valid batch/row):
   ```bash
   # Start API
   npm run dev --filter=@populatte/api

   # Get project/batch/row IDs from existing data
   # Get valid Clerk token from web app

   # Update row to ERROR
   curl -X PATCH "http://localhost:3001/projects/PROJECT_ID/batches/BATCH_ID/rows/ROW_ID/status" \
     -H "Authorization: Bearer TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"fillStatus":"ERROR","fillErrorMessage":"Field not found","fillErrorStep":"step-1"}'
   # Expected: Row object with fillStatus: "ERROR"

   # Update row to PENDING (retry)
   curl -X PATCH "http://localhost:3001/projects/PROJECT_ID/batches/BATCH_ID/rows/ROW_ID/status" \
     -H "Authorization: Bearer TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"fillStatus":"PENDING"}'
   # Expected: Row object with fillStatus: "PENDING"

   # Update row to VALID
   curl -X PATCH "http://localhost:3001/projects/PROJECT_ID/batches/BATCH_ID/rows/ROW_ID/status" \
     -H "Authorization: Bearer TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"fillStatus":"VALID"}'
   # Expected: Row object with fillStatus: "VALID"

   # Try to update VALID row (should fail)
   curl -X PATCH "http://localhost:3001/projects/PROJECT_ID/batches/BATCH_ID/rows/ROW_ID/status" \
     -H "Authorization: Bearer TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"fillStatus":"PENDING"}'
   # Expected: 400 Bad Request "Cannot change status of completed row"
   ```
</verification>

<success_criteria>
- PATCH endpoint updates fillStatus, fillErrorMessage, fillErrorStep
- Ownership validation returns 404 for missing project/batch/row
- Ownership validation returns 403 for unauthorized access (with audit log)
- VALID status is final (400 on change attempt)
- ERROR -> PENDING transition allowed for retry
- fillUpdatedAt timestamp updated on every status change
</success_criteria>

<output>
After completion, create `.planning/phases/25-backend-extensions/25-02-SUMMARY.md`
</output>
