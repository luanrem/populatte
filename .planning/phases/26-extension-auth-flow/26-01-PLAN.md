---
phase: 26-extension-auth-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/extension/src/api/client.ts
  - apps/extension/src/api/auth.ts
  - apps/extension/src/api/index.ts
  - apps/extension/entrypoints/background.ts
autonomous: true

must_haves:
  truths:
    - "AUTH_LOGIN message triggers API call to exchange code for token"
    - "Successful auth stores token and user info in chrome.storage"
    - "Failed auth returns specific error message to popup"
    - "401 responses clear auth and broadcast state update"
  artifacts:
    - path: "apps/extension/src/api/client.ts"
      provides: "fetchWithAuth utility with 401 handling"
      exports: ["fetchWithAuth", "apiUrl"]
    - path: "apps/extension/src/api/auth.ts"
      provides: "Auth API functions"
      exports: ["exchangeCode", "getMe"]
    - path: "apps/extension/entrypoints/background.ts"
      provides: "AUTH_LOGIN handler"
      contains: "case 'AUTH_LOGIN'"
  key_links:
    - from: "apps/extension/entrypoints/background.ts"
      to: "apps/extension/src/api/auth.ts"
      via: "exchangeCode function call"
      pattern: "exchangeCode\\(.*code"
    - from: "apps/extension/src/api/client.ts"
      to: "apps/extension/src/storage/auth.ts"
      via: "clearAuth on 401"
      pattern: "storage\\.auth\\.clearAuth"
---

<objective>
Implement background service worker auth handler and API client layer

Purpose: Enable extension to exchange connection codes for JWT tokens via the backend API, establishing the foundation for authenticated API calls.

Output: API client with auth handling, AUTH_LOGIN message handler in background.ts
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase dependencies
@.planning/phases/24-extension-foundation/24-02-SUMMARY.md
@.planning/phases/24-extension-foundation/24-03-SUMMARY.md
@.planning/phases/25-backend-extensions/25-01-SUMMARY.md

# Existing code to modify/reference
@apps/extension/entrypoints/background.ts
@apps/extension/src/storage/auth.ts
@apps/extension/src/types/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client layer</name>
  <files>
    apps/extension/src/api/client.ts
    apps/extension/src/api/auth.ts
    apps/extension/src/api/index.ts
  </files>
  <action>
Create API client infrastructure for the extension:

**apps/extension/src/api/client.ts:**
- Export `API_BASE_URL` constant: Use `http://localhost:3001` for development (hardcoded for now, extensions don't have .env files like web apps)
- Export `fetchWithAuth(url, options)` function:
  - Gets token from `storage.auth.getAuth()`
  - If no token, throws `Error('Not authenticated')`
  - Adds `Authorization: Bearer ${token}` header
  - On 401 response: calls `storage.auth.clearAuth()`, broadcasts STATE_UPDATED, throws `Error('SESSION_EXPIRED')`
  - Returns fetch response for successful calls
- Import storage from '../storage' (relative path per 24-03 pattern)
- Import broadcast from '../messaging'

**apps/extension/src/api/auth.ts:**
- Export `exchangeCode(code: string)` function:
  - POST to `${API_BASE_URL}/auth/extension-token` with `{ code }`
  - Returns `{ token: string }` on success
  - Throws with specific error message on failure (parse API error response)
- Export `getMe(token: string)` function:
  - GET to `${API_BASE_URL}/auth/extension-me` with Authorization header
  - Returns `{ id, email, firstName, lastName, imageUrl }` on success
  - Throws on failure
- Both functions use plain fetch (not fetchWithAuth - these are for initial auth)

**apps/extension/src/api/index.ts:**
- Export `API_BASE_URL` and `fetchWithAuth` from './client'
- Export auth API functions: `{ exchangeCode, getMe }`
  </action>
  <verify>
Run `npm run type-check --filter=@populatte/extension` - TypeScript compiles without errors.
Verify files exist: `ls apps/extension/src/api/`
  </verify>
  <done>
API client layer exists with fetchWithAuth for authenticated requests and exchangeCode/getMe for auth flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement AUTH_LOGIN handler in background</name>
  <files>
    apps/extension/entrypoints/background.ts
  </files>
  <action>
Add AUTH_LOGIN case to the message handler in background.ts:

**In the switch statement, add case 'AUTH_LOGIN':**
1. Extract code from `message.payload.code`
2. Try:
   a. Call `exchangeCode(code)` to get token
   b. Call `getMe(token)` to get user info
   c. Store token with 30-day expiry: `await storage.auth.setToken(token, Date.now() + 30 * 24 * 60 * 60 * 1000)`
   d. Store user info: `await storage.auth.setUser(user.id, user.email)`
   e. Call `notifyStateUpdate()` to broadcast new state
   f. `sendResponse({ success: true })`
3. Catch:
   - Log error to console
   - `sendResponse({ success: false, error: err.message || 'Connection failed' })`

**Imports to add at top:**
- Import `{ exchangeCode, getMe }` from '../src/api'

**Decision from CONTEXT.md:** Error message should be specific (from API) when possible, generic "Connection failed" as fallback.
  </action>
  <verify>
Run `npm run build --filter=@populatte/extension` - Extension builds without errors.
Verify AUTH_LOGIN case exists: `grep -n "case 'AUTH_LOGIN'" apps/extension/entrypoints/background.ts`
  </verify>
  <done>
Background handles AUTH_LOGIN by calling API, storing token/user, and broadcasting state update. Popup can send AUTH_LOGIN message and receive success/failure response.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint --filter=@populatte/extension` passes
2. `npm run type-check --filter=@populatte/extension` passes
3. `npm run build --filter=@populatte/extension` succeeds
4. API client files exist in apps/extension/src/api/
5. Background.ts contains AUTH_LOGIN handler
</verification>

<success_criteria>
- API client layer created with fetchWithAuth and 401 handling
- exchangeCode and getMe functions for auth flow
- AUTH_LOGIN handler in background.ts calls API and stores credentials
- All TypeScript compilation passes
- Extension builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/26-extension-auth-flow/26-01-SUMMARY.md`
</output>
