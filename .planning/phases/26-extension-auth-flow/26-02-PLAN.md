---
phase: 26-extension-auth-flow
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - apps/extension/entrypoints/popup/components/ConnectView.tsx
  - apps/extension/entrypoints/popup/components/CodeInputForm.tsx
  - apps/extension/entrypoints/popup/components/ConnectedIndicator.tsx
  - apps/extension/entrypoints/popup/components/index.ts
  - apps/extension/entrypoints/popup/App.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Connect button when not authenticated"
    - "User can enter 6-digit code and submit to authenticate"
    - "User sees Connected indicator with green checkmark when authenticated"
    - "Invalid code shows inline error below input"
    - "Connect button opens web app in new tab"
  artifacts:
    - path: "apps/extension/entrypoints/popup/components/ConnectView.tsx"
      provides: "Disconnected state UI with Connect button and code form"
      min_lines: 40
    - path: "apps/extension/entrypoints/popup/components/CodeInputForm.tsx"
      provides: "Code input form with validation and loading state"
      min_lines: 50
    - path: "apps/extension/entrypoints/popup/components/ConnectedIndicator.tsx"
      provides: "Simple connected state indicator"
      min_lines: 10
    - path: "apps/extension/entrypoints/popup/App.tsx"
      provides: "Auth-aware view switching"
      contains: "isAuthenticated"
  key_links:
    - from: "apps/extension/entrypoints/popup/components/CodeInputForm.tsx"
      to: "apps/extension/src/messaging/send.ts"
      via: "sendToBackground AUTH_LOGIN"
      pattern: "sendToBackground.*AUTH_LOGIN"
    - from: "apps/extension/entrypoints/popup/components/ConnectView.tsx"
      to: "chrome.tabs.create"
      via: "opens web app tab"
      pattern: "chrome\\.tabs\\.create|browser\\.tabs\\.create"
---

<objective>
Build auth UI components for popup with connect flow and state display

Purpose: Enable users to connect the extension by entering a code from the web app, and display authentication status clearly.

Output: ConnectView, CodeInputForm, ConnectedIndicator components, updated App.tsx with auth-aware routing
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context - LOCKED DECISIONS
@.planning/phases/26-extension-auth-flow/26-CONTEXT.md
@.planning/phases/26-extension-auth-flow/26-RESEARCH.md

# Prior plan in this phase
@.planning/phases/26-extension-auth-flow/26-01-SUMMARY.md

# Existing code
@apps/extension/entrypoints/popup/App.tsx
@apps/extension/src/messaging/send.ts
@apps/extension/src/types/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth UI components</name>
  <files>
    apps/extension/entrypoints/popup/components/ConnectView.tsx
    apps/extension/entrypoints/popup/components/CodeInputForm.tsx
    apps/extension/entrypoints/popup/components/ConnectedIndicator.tsx
    apps/extension/entrypoints/popup/components/index.ts
  </files>
  <action>
Create popup UI components for auth flow. Note: Extension doesn't have shadcn/ui installed, use Tailwind classes directly (matching existing App.tsx patterns).

**apps/extension/entrypoints/popup/components/ConnectedIndicator.tsx:**
- Simple component showing green checkmark icon + "Connected" text
- Use lucide-react `CheckCircle` icon with green color
- Example: `<div className="flex items-center gap-2"><CheckCircle className="w-4 h-4 text-green-600" /><span className="text-sm text-green-700">Connected</span></div>`

**apps/extension/entrypoints/popup/components/CodeInputForm.tsx:**
- Props: `onSuccess: () => void` (called after successful auth)
- State: `code` (string), `error` (string | null), `loading` (boolean)
- Single text input for 6-digit code (not split digit boxes - per CONTEXT.md)
- Input attributes: `type="text"`, `maxLength={6}`, `placeholder="000000"`, `inputMode="numeric"`
- Submit button with loading state:
  - When loading: show Loader2 icon spinning + "Connecting..." text
  - When not loading: "Connect" text
  - Disabled when loading or code length !== 6
- Form onSubmit:
  1. Prevent default
  2. Clear error, set loading true
  3. Validate: if `!/^\d{6}$/.test(code)`, set error "Code must be exactly 6 digits", return
  4. Call `sendToBackground({ type: 'AUTH_LOGIN', payload: { code } })`
  5. If response.success: call onSuccess()
  6. If !response.success: set error to response.error or "Connection failed"
  7. Finally: set loading false
- Error display: Below input, red text, only when error is not null
- Style input and button to match existing App.tsx amber theme

**apps/extension/entrypoints/popup/components/ConnectView.tsx:**
- Shows when user is not authenticated
- Layout:
  1. Brief instruction text: "Connect to your Populatte account"
  2. "Open Populatte" button that opens web app connection page in new tab
     - Uses `browser.tabs.create({ url: 'http://localhost:3000/extension/connect', active: true })`
     - Use localhost for dev (same as API_BASE_URL pattern)
  3. Divider or spacing
  4. "Enter connection code:" label
  5. CodeInputForm component with onSuccess prop
- Props: `onConnected: () => void` (passed to CodeInputForm)

**apps/extension/entrypoints/popup/components/index.ts:**
- Export all components: ConnectView, CodeInputForm, ConnectedIndicator
  </action>
  <verify>
Run `npm run type-check --filter=@populatte/extension` - TypeScript compiles.
Verify files exist: `ls apps/extension/entrypoints/popup/components/`
  </verify>
  <done>
Auth UI components created: ConnectView shows connect flow, CodeInputForm handles code input with validation, ConnectedIndicator shows authenticated state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire popup App.tsx for auth-aware views</name>
  <files>
    apps/extension/entrypoints/popup/App.tsx
  </files>
  <action>
Update App.tsx to show different views based on authentication state:

**Changes to App.tsx:**

1. Import new components:
   `import { ConnectView, ConnectedIndicator } from './components';`

2. Modify the main content rendering:
   - When `!state?.isAuthenticated`: render `<ConnectView onConnected={loadState} />`
   - When `state?.isAuthenticated`: render current content with ConnectedIndicator replacing the amber box

3. Replace the auth status amber box with ConnectedIndicator:
   - Remove the `<div className="p-3 bg-amber-50 rounded-lg border border-amber-200">` section
   - Add `<ConnectedIndicator />` at the top of the authenticated content

4. Remove the "Test Connection" button (was for Phase 24 testing, no longer needed)

5. Keep the header, refresh button, loading state, error state, and footer as-is

**Key structural change:**
```tsx
{state && !loading && (
  state.isAuthenticated ? (
    <>
      <ConnectedIndicator />
      {/* existing project/batch/row info */}
    </>
  ) : (
    <ConnectView onConnected={loadState} />
  )
)}
```

**Note:** The existing STATE_UPDATED listener already handles auth state changes, so when auth completes, the popup will automatically update.
  </action>
  <verify>
Run `npm run build --filter=@populatte/extension` - Extension builds successfully.
Run `npm run lint --filter=@populatte/extension` - No linting errors.
Verify App.tsx renders ConnectView: `grep -n "ConnectView" apps/extension/entrypoints/popup/App.tsx`
  </verify>
  <done>
Popup shows ConnectView when not authenticated, shows ConnectedIndicator + content when authenticated. Auth flow is complete.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint --filter=@populatte/extension` passes
2. `npm run type-check --filter=@populatte/extension` passes
3. `npm run build --filter=@populatte/extension` succeeds
4. Components exist in apps/extension/entrypoints/popup/components/
5. App.tsx imports and uses ConnectView and ConnectedIndicator
6. No Test Connection button remains in final code
</verification>

<success_criteria>
- ConnectView shows Connect button and code input form
- CodeInputForm validates 6-digit code and sends AUTH_LOGIN message
- ConnectedIndicator shows green checkmark with "Connected" text
- App.tsx renders correct view based on isAuthenticated state
- Connect button opens web app in new tab
- Inline error display for invalid/failed codes
- Loading spinner on Connect button during API call
</success_criteria>

<output>
After completion, create `.planning/phases/26-extension-auth-flow/26-02-SUMMARY.md`
</output>
