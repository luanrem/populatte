---
phase: 26-extension-auth-flow
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/extension/connect/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking Open Populatte in extension opens web app /extension/connect page"
    - "Authenticated user sees 6-digit connection code"
    - "User can copy code to clipboard with one click"
    - "User sees 5-minute expiry notice for the code"
    - "Unauthenticated user is redirected to sign-in"
  artifacts:
    - path: "apps/web/app/extension/connect/page.tsx"
      provides: "Extension connection code page"
      min_lines: 60
  key_links:
    - from: "apps/web/app/extension/connect/page.tsx"
      to: "/auth/extension-code"
      via: "useApiClient fetch"
      pattern: "apiClient\\.fetch.*extension-code"
---

<objective>
Create the web app /extension/connect page that generates and displays connection codes for the browser extension.

Purpose: Close the gap identified in UAT - extension's "Open Populatte" button opens a 404 because the web page doesn't exist.
Output: Working connection code page that authenticated users can access to link their extension.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-extension-auth-flow/26-UAT.md

# Existing patterns to follow
@apps/web/lib/api/client.ts
@apps/web/components/ui/button.tsx
@apps/web/components/ui/card.tsx
@apps/web/app/layout.tsx

# Backend endpoint (already exists)
@apps/api/src/presentation/controllers/extension-auth.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extension connect page</name>
  <files>apps/web/app/extension/connect/page.tsx</files>
  <action>
Create a client-side page at apps/web/app/extension/connect/page.tsx that:

1. **Page structure:**
   - 'use client' directive (client component for interactivity)
   - Centered card layout (single purpose page, not dashboard-style)
   - No sidebar needed - the root layout already handles SignedIn/SignedOut routing

2. **State management:**
   - code: string | null (the 6-digit code)
   - isLoading: boolean (for generate button state)
   - error: string | null (API error display)
   - copied: boolean (copy button feedback)

3. **API integration:**
   - Use useApiClient() hook from @/lib/api/client
   - Call POST /auth/extension-code endpoint on page load (useEffect)
   - Response: { code: string, expiresIn: number }
   - Store code in state, display expiresIn as "5 minutes" notice

4. **UI components (use shadcn/ui):**
   - Card with CardHeader, CardContent, CardFooter
   - Large monospace code display (text-3xl font-mono tracking-widest)
   - Button for copy action (variant="outline", with Check icon after copy)
   - Button to regenerate code if needed
   - Loading skeleton while fetching
   - Error state with retry button

5. **Copy functionality:**
   - Use navigator.clipboard.writeText(code)
   - Show "Copied!" feedback for 2 seconds
   - Use Check icon instead of Copy icon when copied

6. **Visual design:**
   - Extension icon from lucide-react (Puzzle or Link)
   - Clear instruction text: "Enter this code in the extension popup"
   - Expiry warning: "Code expires in 5 minutes"
   - Muted text for secondary info

7. **Authentication:**
   - Root layout already wraps SignedIn content with SidebarProvider
   - For this page, we want minimal chrome - just centered content
   - The page will show in the signed-in shell but content is self-contained

Example structure:
```tsx
'use client';

import { useEffect, useState } from 'react';
import { Copy, Check, RefreshCw, Puzzle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { useApiClient } from '@/lib/api/client';

export default function ExtensionConnectPage() {
  // State: code, isLoading, error, copied
  // useEffect to fetch code on mount
  // generateCode function that calls API
  // copyCode function using navigator.clipboard

  return (
    <main className="flex min-h-screen items-center justify-center p-4">
      <Card className="w-full max-w-md">
        {/* Header with icon and title */}
        {/* Content with code display or loading/error state */}
        {/* Footer with copy and regenerate buttons */}
      </Card>
    </main>
  );
}
```
  </action>
  <verify>
1. Start dev server: `npm run dev --filter=@populatte/web`
2. Navigate to http://localhost:3000/extension/connect while signed in
3. Verify page loads without 404
4. Verify 6-digit code is displayed
5. Verify copy button works (check clipboard)
6. Verify regenerate button fetches new code
7. TypeScript: `npm run type-check --filter=@populatte/web` passes
8. Lint: `npm run lint --filter=@populatte/web` passes
  </verify>
  <done>
- Extension connect page exists at /extension/connect
- Authenticated users see 6-digit code with copy functionality
- Page calls POST /auth/extension-code API endpoint
- Code displays with 5-minute expiry notice
- UAT Test 2 can now pass (Open Populatte opens valid page)
  </done>
</task>

</tasks>

<verification>
1. **Page accessibility:** http://localhost:3000/extension/connect returns 200 for authenticated users
2. **API integration:** Page successfully calls POST /auth/extension-code and displays returned code
3. **Copy function:** Clicking copy button puts code in clipboard
4. **Type safety:** No TypeScript errors in the new file
5. **Lint compliance:** ESLint passes with Next.js rules
</verification>

<success_criteria>
- [ ] /extension/connect page exists and loads without error
- [ ] Page displays 6-digit code from API
- [ ] Copy button works and shows feedback
- [ ] Regenerate button fetches new code
- [ ] 5-minute expiry notice is displayed
- [ ] Extension's "Open Populatte" button opens this page (verify in extension)
- [ ] UAT Test 2 passes: page exists (no longer 404)
- [ ] UAT Tests 4, 5 unblocked: users can now get codes to test connection flow
</success_criteria>

<output>
After completion, create `.planning/phases/26-extension-auth-flow/26-03-SUMMARY.md`
</output>
