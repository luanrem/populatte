---
phase: 27-popup-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/extension/src/api/projects.ts
  - apps/extension/src/api/batches.ts
  - apps/extension/src/api/index.ts
  - apps/extension/entrypoints/background.ts
  - apps/extension/src/types/responses.ts
autonomous: true

must_haves:
  truths:
    - "Background handler responds to GET_PROJECTS with user's project list"
    - "Background handler responds to GET_BATCHES with batches for a project"
    - "Batches include progress info (done count, total rows)"
  artifacts:
    - path: "apps/extension/src/api/projects.ts"
      provides: "fetchProjects function"
      exports: ["fetchProjects"]
    - path: "apps/extension/src/api/batches.ts"
      provides: "fetchBatches function with progress calculation"
      exports: ["fetchBatches"]
    - path: "apps/extension/entrypoints/background.ts"
      provides: "GET_PROJECTS and GET_BATCHES handlers"
      contains: "GET_PROJECTS"
  key_links:
    - from: "apps/extension/entrypoints/background.ts"
      to: "apps/extension/src/api/projects.ts"
      via: "import and call"
      pattern: "fetchProjects"
    - from: "apps/extension/src/api/projects.ts"
      to: "/projects endpoint"
      via: "fetchWithAuth"
      pattern: "fetchWithAuth.*projects"
---

<objective>
Add API handlers for project and batch listing to support popup selection dropdowns.

Purpose: Enable the popup to fetch user's projects and batches with progress info for display in selection UI.
Output: GET_PROJECTS and GET_BATCHES message handlers in background.ts, backed by API functions.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-popup-ui/27-CONTEXT.md
@apps/extension/src/api/client.ts
@apps/extension/src/api/auth.ts
@apps/extension/entrypoints/background.ts
@apps/extension/src/types/messages.ts
@apps/extension/src/types/responses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project and batch API functions</name>
  <files>
    apps/extension/src/api/projects.ts
    apps/extension/src/api/batches.ts
    apps/extension/src/api/index.ts
    apps/extension/src/types/responses.ts
  </files>
  <action>
Create API functions for fetching projects and batches:

1. Create `projects.ts`:
   - `fetchProjects()`: GET /projects using fetchWithAuth
   - Returns array of ProjectSummary (id, name, batchCount)

2. Create `batches.ts`:
   - `fetchBatches(projectId: string)`: GET /projects/:projectId/batches using fetchWithAuth
   - Returns array of BatchWithProgress (extend existing BatchSummary with pendingCount, doneCount)
   - Calculate progress by fetching batch rows and counting by fillStatus
   - NOTE: For MVP, just return rowCount as total and 0 as done (progress calculation deferred to Phase 29 when we have row status tracking)

3. Update `index.ts` to export new functions

4. Update `responses.ts` to add BatchWithProgress type:
   ```typescript
   export interface BatchWithProgress extends BatchSummary {
     pendingCount: number;
     doneCount: number;
   }
   ```

Follow existing patterns from auth.ts - use fetchWithAuth, throw errors on non-ok response.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
  </verify>
  <done>
fetchProjects and fetchBatches functions exist with proper types, exported from api/index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET_PROJECTS and GET_BATCHES handlers</name>
  <files>
    apps/extension/entrypoints/background.ts
  </files>
  <action>
Add message handlers in background.ts switch statement:

1. `GET_PROJECTS` handler:
   - Call fetchProjects()
   - Return { success: true, data: { projects } }
   - Handle errors with { success: false, error: message }

2. `GET_BATCHES` handler:
   - Extract projectId from message.payload
   - Call fetchBatches(projectId)
   - Filter out completed batches (where doneCount === rowCount) per CONTEXT.md decision
   - Return { success: true, data: { batches } }
   - Handle errors with { success: false, error: message }

Import fetchProjects and fetchBatches from '../src/api'.

Follow existing handler pattern (AUTH_LOGIN, GET_AUTH) with try/catch and sendResponse.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
Build succeeds: `cd apps/extension && pnpm build`
  </verify>
  <done>
GET_PROJECTS returns projects array, GET_BATCHES returns filtered batches with progress info
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes without errors
2. Extension builds successfully
3. Code follows existing patterns in background.ts and api/ modules
</verification>

<success_criteria>
- GET_PROJECTS handler responds with project list from API
- GET_BATCHES handler responds with batch list including progress fields
- Completed batches are filtered from GET_BATCHES response
- All functions properly typed with Response wrappers
</success_criteria>

<output>
After completion, create `.planning/phases/27-popup-ui/27-01-SUMMARY.md`
</output>
