---
phase: 27-popup-ui
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - apps/extension/entrypoints/popup/components/ProjectSelector.tsx
  - apps/extension/entrypoints/popup/components/BatchSelector.tsx
  - apps/extension/entrypoints/popup/components/RowIndicator.tsx
  - apps/extension/entrypoints/popup/components/index.ts
  - apps/extension/entrypoints/popup/App.tsx
autonomous: true

must_haves:
  truths:
    - "User sees project dropdown with their projects"
    - "User sees batch dropdown filtered by selected project"
    - "Batch dropdown shows progress format (filename - X/Y done)"
    - "Selections persist across popup closes"
    - "Changing project clears batch selection"
  artifacts:
    - path: "apps/extension/entrypoints/popup/components/ProjectSelector.tsx"
      provides: "Project dropdown with API fetch"
      min_lines: 40
    - path: "apps/extension/entrypoints/popup/components/BatchSelector.tsx"
      provides: "Batch dropdown with progress display"
      min_lines: 40
    - path: "apps/extension/entrypoints/popup/components/RowIndicator.tsx"
      provides: "Row position display"
      min_lines: 15
  key_links:
    - from: "apps/extension/entrypoints/popup/components/ProjectSelector.tsx"
      to: "background.ts"
      via: "sendToBackground GET_PROJECTS"
      pattern: "sendToBackground.*GET_PROJECTS"
    - from: "apps/extension/entrypoints/popup/components/BatchSelector.tsx"
      to: "background.ts"
      via: "sendToBackground GET_BATCHES"
      pattern: "sendToBackground.*GET_BATCHES"
---

<objective>
Build selection UI components for project, batch, and row navigation.

Purpose: Enable users to select which project/batch to work with and see current row position.
Output: ProjectSelector, BatchSelector, and RowIndicator components integrated into popup App.tsx.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-popup-ui/27-CONTEXT.md
@.planning/phases/27-popup-ui/27-01-SUMMARY.md
@apps/extension/entrypoints/popup/App.tsx
@apps/extension/entrypoints/popup/components/index.ts
@apps/extension/src/messaging/send.ts
@apps/extension/src/types/responses.ts
@apps/extension/src/types/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectSelector component</name>
  <files>
    apps/extension/entrypoints/popup/components/ProjectSelector.tsx
  </files>
  <action>
Create ProjectSelector dropdown component:

1. Props interface:
   - `selectedId: string | null` - currently selected project
   - `onSelect: (projectId: string) => void` - selection callback

2. State:
   - `projects: ProjectSummary[]` - fetched from GET_PROJECTS
   - `loading: boolean` - fetch in progress
   - `error: string | null` - error message

3. useEffect on mount:
   - Call `sendToBackground({ type: 'GET_PROJECTS' })`
   - On success, set projects state
   - On error, set error state

4. Render:
   - Loading: Show "Loading projects..." text
   - Error: Show error message with retry button
   - Empty: Show "No projects found" with link to web app
   - Projects: Native `<select>` dropdown with:
     - Placeholder option "Select a project"
     - Options showing project name
   - onChange calls onSelect with selected projectId

Style with Tailwind classes matching existing popup components (gray borders, text sizes).
Per CONTEXT.md: Empty dropdowns on first open, no auto-selection.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
  </verify>
  <done>
ProjectSelector renders dropdown that fetches and displays projects, calls onSelect on change
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BatchSelector and RowIndicator components</name>
  <files>
    apps/extension/entrypoints/popup/components/BatchSelector.tsx
    apps/extension/entrypoints/popup/components/RowIndicator.tsx
    apps/extension/entrypoints/popup/components/index.ts
  </files>
  <action>
Create BatchSelector dropdown component:

1. Props interface:
   - `projectId: string | null` - selected project (null = disabled)
   - `selectedId: string | null` - currently selected batch
   - `onSelect: (batchId: string, rowTotal: number) => void` - selection callback (includes row count)

2. State:
   - `batches: BatchWithProgress[]`
   - `loading: boolean`
   - `error: string | null`

3. useEffect when projectId changes:
   - If null, clear batches and return
   - Call `sendToBackground({ type: 'GET_BATCHES', payload: { projectId } })`
   - On success, set batches
   - Per CONTEXT.md: If only one batch, auto-select it

4. Render:
   - Disabled state when projectId is null
   - Loading/error states like ProjectSelector
   - Empty: "No pending batches" with link to web app
   - Batches: Native `<select>` with format "filename - X/Y done"
   - onChange calls onSelect with batchId and batch.rowCount

Create RowIndicator component:

1. Props:
   - `rowIndex: number` (0-based)
   - `rowTotal: number`

2. Render:
   - If rowTotal === 0: "No rows"
   - Otherwise: "Row {rowIndex + 1} of {rowTotal}"
   - Style as centered text, gray-600

Update components/index.ts to export new components.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
  </verify>
  <done>
BatchSelector shows batches with progress format, RowIndicator displays position
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate selection components into App.tsx</name>
  <files>
    apps/extension/entrypoints/popup/App.tsx
  </files>
  <action>
Update App.tsx to wire selection components:

1. Import new components from './components'

2. Replace the current static selection display (lines 80-95) with:
   - ProjectSelector with selectedId from state.projectId
   - BatchSelector with projectId and selectedId from state
   - RowIndicator with rowIndex and rowTotal from state

3. Handler functions:
   - `handleProjectSelect(projectId)`:
     - Send PROJECT_SELECT message to background
     - Background already clears batch/row selection
   - `handleBatchSelect(batchId, rowTotal)`:
     - Send BATCH_SELECT message to background with batchId
     - Update local state or wait for STATE_UPDATED broadcast

4. Layout structure (inside authenticated block):
   ```jsx
   <ConnectedIndicator />

   <div className="space-y-3">
     <ProjectSelector
       selectedId={state.projectId}
       onSelect={handleProjectSelect}
     />
     <BatchSelector
       projectId={state.projectId}
       selectedId={state.batchId}
       onSelect={handleBatchSelect}
     />
   </div>

   <RowIndicator
     rowIndex={state.rowIndex}
     rowTotal={state.rowTotal}
   />
   ```

Remove the old static div showing Project/Batch/Row info.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
Extension builds: `cd apps/extension && pnpm build`
  </verify>
  <done>
App.tsx renders selection components, selections trigger background messages and update state
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. Extension builds successfully
3. ProjectSelector fetches and displays projects
4. BatchSelector shows batches with "filename - X/Y done" format
5. RowIndicator shows current position
6. State persists (background storage) across popup closes
</verification>

<success_criteria>
- Project dropdown loads and displays user's projects (POP-01)
- Batch dropdown filters by selected project and shows batch list (POP-02)
- Batch dropdown shows progress format (POP-02)
- Row indicator shows current position (POP-03)
- Selections persist when popup closes and restore on reopen (POP-08)
</success_criteria>

<output>
After completion, create `.planning/phases/27-popup-ui/27-02-SUMMARY.md`
</output>
