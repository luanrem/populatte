---
phase: 27-popup-ui
plan: 03
type: execute
wave: 3
depends_on: ["27-02"]
files_modified:
  - apps/extension/entrypoints/popup/components/FillControls.tsx
  - apps/extension/entrypoints/popup/components/ErrorInput.tsx
  - apps/extension/entrypoints/popup/components/index.ts
  - apps/extension/entrypoints/popup/App.tsx
  - apps/extension/src/types/messages.ts
  - apps/extension/entrypoints/background.ts
autonomous: true

must_haves:
  truths:
    - "User sees Fill button when batch is selected"
    - "User sees Next button to mark row as VALID and advance"
    - "User sees Mark Error button that shows error input"
    - "Fill button disabled when no batch selected"
    - "Fill button disabled with 'No mapping for this site' when no mapping exists"
  artifacts:
    - path: "apps/extension/entrypoints/popup/components/FillControls.tsx"
      provides: "Fill, Next, Mark Error buttons with state management"
      min_lines: 60
    - path: "apps/extension/entrypoints/popup/components/ErrorInput.tsx"
      provides: "Optional error reason input for Mark Error"
      min_lines: 20
  key_links:
    - from: "apps/extension/entrypoints/popup/components/FillControls.tsx"
      to: "background.ts"
      via: "sendToBackground ROW_NEXT"
      pattern: "sendToBackground.*ROW_NEXT"
    - from: "apps/extension/entrypoints/popup/App.tsx"
      to: "FillControls component"
      via: "import and render"
      pattern: "<FillControls"
---

<objective>
Build fill control buttons and error handling UI for the COPILOTO workflow.

Purpose: Enable users to control the fill cycle with Fill, Next, and Mark Error buttons.
Output: FillControls component with action buttons and error input, integrated into popup.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-popup-ui/27-CONTEXT.md
@.planning/phases/27-popup-ui/27-02-SUMMARY.md
@apps/extension/entrypoints/popup/App.tsx
@apps/extension/src/types/messages.ts
@apps/extension/entrypoints/background.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FillControls and ErrorInput components</name>
  <files>
    apps/extension/entrypoints/popup/components/FillControls.tsx
    apps/extension/entrypoints/popup/components/ErrorInput.tsx
    apps/extension/entrypoints/popup/components/index.ts
  </files>
  <action>
Create ErrorInput component (simple optional text input):

1. Props:
   - `value: string`
   - `onChange: (value: string) => void`
   - `onSubmit: () => void`
   - `onCancel: () => void`
   - `loading: boolean`

2. Render:
   - Text input with placeholder "Error reason (optional)"
   - Submit button "Confirm Error"
   - Cancel button
   - Disable inputs while loading

Create FillControls component:

1. Props interface:
   - `batchId: string | null` - whether fill is possible
   - `fillStatus: FillStatus` - current fill state
   - `fillProgress: { current: number; total: number } | null` - step progress during fill
   - `fillError: string | null` - error message from last fill
   - `onFill: () => void` - trigger fill
   - `onNext: () => void` - mark valid and advance
   - `onMarkError: (reason?: string) => void` - mark error

2. Local state:
   - `showErrorInput: boolean` - whether error input is visible
   - `errorReason: string` - current error reason text

3. Button states per CONTEXT.md:
   - Fill button:
     - Disabled if no batchId
     - Disabled during 'filling' status
     - Shows "Filling 3/5 fields..." when filling (use fillProgress)
     - Disabled with text "No mapping for this site" when fillStatus is 'idle' but no mapping detected
       (For now, always show Fill enabled - mapping detection is Phase 29)
   - Next button:
     - Disabled if fillStatus is 'idle' (nothing to confirm)
     - Enabled after fill completes (success or partial)
   - Mark Error button:
     - Always enabled when batch selected
     - Toggles ErrorInput visibility on click

4. Error display:
   - Show fillError below controls in red text when present
   - Include which step failed if available

5. Layout:
   ```jsx
   <div className="space-y-3">
     {fillError && <div className="text-sm text-red-600">{fillError}</div>}

     <div className="flex gap-2">
       <button className="flex-1 primary-style">
         {fillStatus === 'filling' ? `Filling ${fillProgress?.current}/${fillProgress?.total}...` : 'Fill'}
       </button>
       <button className="flex-1 secondary-style">Next</button>
       <button className="secondary-style">Mark Error</button>
     </div>

     {showErrorInput && <ErrorInput ... />}
   </div>
   ```

Style buttons with Tailwind:
- Fill: bg-amber-600 text-white hover:bg-amber-700 disabled:bg-gray-300
- Next: bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300
- Mark Error: bg-red-50 text-red-700 border border-red-200 hover:bg-red-100

Update components/index.ts to export FillControls.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
  </verify>
  <done>
FillControls renders Fill/Next/Mark Error buttons with proper disabled states and error display
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MARK_ERROR message and handler</name>
  <files>
    apps/extension/src/types/messages.ts
    apps/extension/entrypoints/background.ts
  </files>
  <action>
Add MARK_ERROR message type in messages.ts:

```typescript
export interface MarkErrorMessage {
  type: 'MARK_ERROR';
  payload: {
    reason?: string;
  };
}
```

Add to PopupToBackgroundMessage union.

Add MARK_ERROR handler in background.ts:

1. Handler logic:
   - Get current selection (projectId, batchId, rowIndex)
   - Get current row ID from storage or state
   - NOTE: For now, just advance to next row without API call
     (Phase 29 will wire up actual status update API call when we have row IDs tracked)
   - Call storage.selection.nextRow()
   - Broadcast STATE_UPDATED
   - Return success

This is a stub implementation - the actual PATCH /rows/:id/status call will be wired in Phase 29 when fill cycle integration happens.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
Extension builds: `cd apps/extension && pnpm build`
  </verify>
  <done>
MARK_ERROR message type exists and handler advances to next row
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate FillControls into App.tsx</name>
  <files>
    apps/extension/entrypoints/popup/App.tsx
  </files>
  <action>
Update App.tsx to add fill controls:

1. Import FillControls from './components'

2. Add local state for fill-specific UI:
   - `fillProgress: { current: number; total: number } | null`
   - `fillError: string | null`

3. Listen for FILL_PROGRESS messages in useEffect:
   - Update fillProgress state
   - Clear on fill complete or error

4. Handler functions:
   - `handleFill()`: Send FILL_START message (stub for Phase 29)
   - `handleNext()`: Send ROW_NEXT message, clear fillError
   - `handleMarkError(reason?)`: Send MARK_ERROR message with optional reason

5. Add FillControls to authenticated view below RowIndicator:
   ```jsx
   <FillControls
     batchId={state.batchId}
     fillStatus={state.fillStatus}
     fillProgress={fillProgress}
     fillError={fillError}
     onFill={handleFill}
     onNext={handleNext}
     onMarkError={handleMarkError}
   />
   ```

6. Update layout spacing to accommodate new controls.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && pnpm exec tsc --noEmit`
Extension builds: `cd apps/extension && pnpm build`
  </verify>
  <done>
App.tsx renders FillControls with handlers wired to background messages
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. Extension builds successfully
3. FillControls shows all three buttons
4. Next button calls ROW_NEXT and advances row
5. Mark Error shows input and advances row on submit
6. Fill button present (will be wired in Phase 29)
</verification>

<success_criteria>
- Fill/Next/Stop buttons enable based on current state (POP-04, POP-05, POP-06)
- Mark Error shows optional text input for error reason
- Fill errors show inline below controls
- All buttons are clickable and trigger appropriate messages
</success_criteria>

<output>
After completion, create `.planning/phases/27-popup-ui/27-03-SUMMARY.md`
</output>
