---
phase: 28-content-script
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/extension/src/content/selector.ts
  - apps/extension/src/content/actions.ts
  - apps/extension/src/content/index.ts
autonomous: true

must_haves:
  truths:
    - "Selector engine finds elements using CSS selectors"
    - "Selector engine finds elements using XPath expressions"
    - "When primary selector fails, fallback selectors are tried in order"
    - "Fill action clears and populates text inputs with native setters"
    - "Fill action handles select elements by value then text"
    - "Click action scrolls into view and clicks target element"
    - "Wait action delays execution for specified duration"
  artifacts:
    - path: "apps/extension/src/content/selector.ts"
      provides: "findElement function with CSS/XPath/fallback support"
      exports: ["findElement", "SelectorConfig"]
    - path: "apps/extension/src/content/actions.ts"
      provides: "executeFill, executeClick, executeWait functions"
      exports: ["executeFill", "executeClick", "executeWait", "ActionResult"]
    - path: "apps/extension/src/content/index.ts"
      provides: "Content module exports"
  key_links:
    - from: "apps/extension/src/content/actions.ts"
      to: "apps/extension/src/content/selector.ts"
      via: "import findElement"
      pattern: "import.*findElement.*selector"
---

<objective>
Build selector engine and action executors for content script DOM manipulation.

Purpose: Enable the content script to find form elements on any page (CSS/XPath with fallbacks) and execute fill/click/wait actions with React/Vue framework compatibility.

Output: Two modules (`selector.ts`, `actions.ts`) that handle all DOM interaction logic, ready for step executor integration.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-content-script/28-CONTEXT.md

# Extension types (FillStep, StepResult)
@apps/extension/src/types/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create selector engine</name>
  <files>apps/extension/src/content/selector.ts</files>
  <action>
Create the selector engine module that finds DOM elements using CSS selectors and XPath expressions.

Implementation requirements (from CONTEXT.md decisions):
1. **findElement function**:
   - Accept primary selector (type: 'css' | 'xpath', value: string)
   - Accept optional fallback array
   - Return { element: HTMLElement | null, usedSelector: string | null, attempts: number }

2. **CSS selector handling**:
   - Use document.querySelector for CSS
   - Return first match (per CONTEXT decision: multiple matches use first)

3. **XPath handling**:
   - Use document.evaluate with FIRST_ORDERED_NODE_TYPE
   - Handle XPath errors gracefully (return null)

4. **Fallback chain logic**:
   - Try primary selector first
   - If null, iterate through fallbacks in order
   - Stop at first successful match
   - Track which selector succeeded for debugging

5. **Element wait (polling)**:
   - Add waitForElement function with configurable timeout
   - Default timeout: 2000ms (per CONTEXT: 1-2 seconds)
   - Poll interval: 100ms
   - Return element or null after timeout

6. **Type exports**:
   - SelectorConfig: { type: 'css' | 'xpath', value: string }
   - FindResult: { element: HTMLElement | null, usedSelector: string | null, attempts: number }
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/extension && npm run build 2>&1 | grep -E "(error|Error)" || echo "Build OK"
```
  </verify>
  <done>
Selector engine module exists with findElement and waitForElement functions supporting both CSS and XPath selectors with fallback chains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create action executors</name>
  <files>apps/extension/src/content/actions.ts</files>
  <action>
Create action executor functions for fill, click, and wait operations.

Implementation requirements (from CONTEXT.md decisions):

1. **ActionResult type**:
   - { success: boolean, skipped?: boolean, error?: string }

2. **executeFill function**:
   - Accept element, value, options (clearBefore, pressEnter)
   - **Clear before fill**: Always clear existing content for text inputs (per CONTEXT)
   - **Input/Textarea handling**:
     - Use native property setter: Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value')?.set?.call(el, value)
     - Dispatch 'input' event with bubbles: true
     - Dispatch 'change' event with bubbles: true
     - If pressEnter, dispatch keydown/keyup for Enter key
   - **Select element handling** (per CONTEXT: value first, then text):
     - First try: set value directly and dispatch change
     - If no option matches value, find option by textContent
     - Return error if no matching option found
   - **Checkbox/Radio handling** (per CONTEXT: truthy strings):
     - Truthy values: "yes", "true", "1", "sim" (case-insensitive)
     - Set checked property via native setter
     - Dispatch change event
   - **File inputs**: Return { success: false, skipped: true, error: 'File inputs require manual action' }
   - **Hidden/Disabled fields**: Return { success: false, error: 'Element is hidden or disabled' }

3. **executeClick function**:
   - Check if element is in viewport using getBoundingClientRect
   - If outside viewport, call element.scrollIntoView({ behavior: 'instant', block: 'center' })
   - Small delay (50ms) after scroll before click
   - Use element.click() for the click action
   - Return success: true

4. **executeWait function**:
   - Accept waitMs parameter
   - Use Promise with setTimeout
   - Return success: true after wait completes

5. **Helper functions**:
   - isElementVisible(el): Check offsetParent, display, visibility
   - isElementDisabled(el): Check disabled attribute
   - isTruthyValue(val): Check against ["yes", "true", "1", "sim"]
   - getInputType(el): Determine if input, textarea, select, checkbox, radio, file

Import findElement from ./selector.ts for potential future use.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/extension && npm run build 2>&1 | grep -E "(error|Error)" || echo "Build OK"
```
  </verify>
  <done>
Action executor module exists with executeFill, executeClick, executeWait functions handling all element types with proper framework reactivity (native setters + events).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create content module index</name>
  <files>apps/extension/src/content/index.ts</files>
  <action>
Create the content module index file that exports all content script utilities.

1. Re-export from selector.ts:
   - findElement, waitForElement
   - SelectorConfig, FindResult types

2. Re-export from actions.ts:
   - executeFill, executeClick, executeWait
   - ActionResult type

3. Add module documentation comment explaining the content script utilities purpose.

Verify the module structure:
```
apps/extension/src/content/
├── index.ts      # Re-exports
├── selector.ts   # Element finding
└── actions.ts    # Action execution
```
  </action>
  <verify>
Extension builds successfully:
```bash
cd apps/extension && npm run build && echo "Content module ready"
```
  </verify>
  <done>
Content module index exports all selector and action utilities. Extension builds without errors.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check**:
```bash
cd apps/extension && npm run build
```
Extension should build without TypeScript or import errors.

2. **Module structure check**:
```bash
ls -la apps/extension/src/content/
```
Should show: index.ts, selector.ts, actions.ts

3. **Export verification**:
```bash
grep -E "^export" apps/extension/src/content/index.ts
```
Should show exports for findElement, waitForElement, executeFill, executeClick, executeWait.
</verification>

<success_criteria>
1. Selector engine finds elements via CSS selectors (CS-01)
2. Selector engine finds elements via XPath expressions (CS-02)
3. Fallback chain tries alternative selectors when primary fails (CS-03)
4. Fill action populates input/textarea/select with native setters (CS-04, CS-05)
5. Click action clicks elements with scroll-into-view (CS-06)
6. Wait action pauses for specified duration (CS-07)
7. Extension builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-content-script/28-01-SUMMARY.md`
</output>
