---
phase: 28-content-script
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - apps/extension/src/content/executor.ts
  - apps/extension/src/content/index.ts
  - apps/extension/entrypoints/content.ts
autonomous: true

must_haves:
  truths:
    - "Step executor processes steps sequentially in defined order"
    - "Each step reports success/failure with reason"
    - "Optional steps skip silently on failure without aborting"
    - "Required steps abort remaining execution on failure"
    - "Content script FILL_EXECUTE handler uses step executor"
    - "Fill results include per-step status with duration"
  artifacts:
    - path: "apps/extension/src/content/executor.ts"
      provides: "executeSteps function with sequential processing"
      exports: ["executeSteps", "ExecutionResult"]
    - path: "apps/extension/entrypoints/content.ts"
      provides: "FILL_EXECUTE handler with real step execution"
      contains: "executeSteps"
  key_links:
    - from: "apps/extension/src/content/executor.ts"
      to: "apps/extension/src/content/selector.ts"
      via: "import findElement, waitForElement"
      pattern: "import.*findElement.*waitForElement"
    - from: "apps/extension/src/content/executor.ts"
      to: "apps/extension/src/content/actions.ts"
      via: "import action executors"
      pattern: "import.*executeFill.*executeClick.*executeWait"
    - from: "apps/extension/entrypoints/content.ts"
      to: "apps/extension/src/content/executor.ts"
      via: "import executeSteps"
      pattern: "import.*executeSteps"
---

<objective>
Build step executor and integrate with content script FILL_EXECUTE handler.

Purpose: Complete the content script implementation by orchestrating selector engine and action executors to process fill steps sequentially, replacing the placeholder FILL_EXECUTE handler with real DOM manipulation.

Output: Step executor module and updated content script that processes fill steps on any page with per-step status reporting.
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-content-script/28-CONTEXT.md
@.planning/phases/28-content-script/28-01-SUMMARY.md

# Extension types (FillStep, StepResult, FillExecuteMessage)
@apps/extension/src/types/messages.ts

# Current content script (has placeholder FILL_EXECUTE)
@apps/extension/entrypoints/content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step executor</name>
  <files>apps/extension/src/content/executor.ts</files>
  <action>
Create the step executor module that processes fill steps sequentially.

Implementation requirements (from CONTEXT.md decisions):

1. **ExecutionResult type**:
   ```typescript
   interface ExecutionResult {
     success: boolean;           // true if all required steps succeeded
     stepResults: StepResult[];  // per-step results
     abortedAtStep?: string;     // step ID where execution stopped (if aborted)
   }
   ```

2. **executeSteps function**:
   - Accept: steps: FillStep[], rowData: Record<string, unknown>
   - Return: Promise<ExecutionResult>

3. **Sequential execution** (per CONTEXT: one step at a time):
   - Process steps in stepOrder sequence
   - For each step, track start time for duration calculation
   - Add 50-100ms delay between steps (use 75ms as middle ground)

4. **Step processing logic**:
   ```
   For each step:
   1. Wait for element (using waitForElement with 2s timeout)
   2. If element not found:
      - If step.optional: { success: false, skipped: true, reason: 'Element not found (optional)' }
      - If required: abort remaining steps, return ExecutionResult with success: false
   3. Determine value to use:
      - If step.sourceFieldKey: look up in rowData[sourceFieldKey]
      - If step.fixedValue: use fixedValue
      - For click/wait actions: value not needed
   4. Execute action based on step.action:
      - 'fill': executeFill(element, value, { clearBefore: step.clearBefore ?? true, pressEnter: step.pressEnter })
      - 'click': executeClick(element)
      - 'wait': executeWait(step.waitMs ?? 1000)
   5. Build StepResult with duration
   6. If action failed and not optional: abort
   ```

5. **Per-step reporting** (maps to StepResult type from messages.ts):
   ```typescript
   {
     stepId: step.id,
     success: boolean,
     skipped?: boolean,  // true if optional step was skipped
     reason?: string,    // explanation for skip/failure
     error?: string,     // error message if failed
     duration?: number   // ms taken for this step
   }
   ```

6. **Import from content modules**:
   - findElement, waitForElement from ./selector
   - executeFill, executeClick, executeWait from ./actions

7. **Handle hidden/disabled fields** (per CONTEXT):
   - If step.optional=true and field is hidden/disabled: skip silently
   - If step.optional=false and field is hidden/disabled: fail the step
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/extension && npm run build 2>&1 | grep -E "(error|Error)" || echo "Build OK"
```
  </verify>
  <done>
Step executor module exists with executeSteps function that processes steps sequentially with proper optional/required handling and per-step status reporting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update content module exports</name>
  <files>apps/extension/src/content/index.ts</files>
  <action>
Update the content module index to export the step executor.

Add exports:
- executeSteps function
- ExecutionResult type

The full export list should now include:
- From selector.ts: findElement, waitForElement, SelectorConfig, FindResult
- From actions.ts: executeFill, executeClick, executeWait, ActionResult
- From executor.ts: executeSteps, ExecutionResult
  </action>
  <verify>
Check exports:
```bash
grep "executeSteps" apps/extension/src/content/index.ts
```
  </verify>
  <done>
Content module index exports executeSteps and ExecutionResult from executor.ts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up content script FILL_EXECUTE handler</name>
  <files>apps/extension/entrypoints/content.ts</files>
  <action>
Replace the placeholder FILL_EXECUTE handler with real step execution.

Current placeholder returns mock success for all steps. Replace with:

1. **Import executeSteps**:
   ```typescript
   import { executeSteps } from '../src/content';
   ```

2. **Update FILL_EXECUTE handler**:
   ```typescript
   if (message.type === 'FILL_EXECUTE') {
     const msg = message as FillExecuteMessage;
     console.log('[Populatte] Execute fill with', msg.payload.steps.length, 'steps');

     try {
       const result = await executeSteps(msg.payload.steps, msg.payload.rowData);

       return Promise.resolve({
         success: result.success,
         data: { stepResults: result.stepResults },
       });
     } catch (err) {
       console.error('[Populatte] Fill execution error:', err);
       return Promise.resolve({
         success: false,
         error: err instanceof Error ? err.message : 'Fill execution failed',
       });
     }
   }
   ```

3. **Keep existing PING handler** unchanged.

4. **Remove mock StepResult generation** - no longer needed.

5. **Update imports** at top of file:
   - Add: import { executeSteps } from '../src/content';
   - Keep: import type { FillExecuteMessage, FillResultMessage, PingResponse, StepResult } from '../src/types';
  </action>
  <verify>
Extension builds and content script has real executeSteps call:
```bash
cd apps/extension && npm run build && grep "executeSteps" entrypoints/content.ts
```
  </verify>
  <done>
Content script FILL_EXECUTE handler uses executeSteps instead of mock. Extension builds successfully.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check**:
```bash
cd apps/extension && npm run build
```
Extension should build without TypeScript errors.

2. **Module structure check**:
```bash
ls -la apps/extension/src/content/
```
Should show: index.ts, selector.ts, actions.ts, executor.ts

3. **Content script integration check**:
```bash
grep -E "executeSteps|FILL_EXECUTE" apps/extension/entrypoints/content.ts
```
Should show import and usage of executeSteps in FILL_EXECUTE handler.

4. **No mock results remaining**:
```bash
grep -c "mock\|Mock" apps/extension/entrypoints/content.ts || echo "No mocks"
```
Should output "No mocks" or 0.
</verification>

<success_criteria>
1. Step executor processes steps in order (CS-08)
2. Per-step status reporting with success/failure and duration
3. Optional steps skip without aborting execution
4. Required step failures abort remaining steps
5. Content script FILL_EXECUTE handler uses real step execution
6. Extension builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-content-script/28-02-SUMMARY.md`
</output>
