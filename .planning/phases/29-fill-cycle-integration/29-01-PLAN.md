---
phase: 29-fill-cycle-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/extension/src/api/mappings.ts
  - apps/extension/src/api/rows.ts
  - apps/extension/src/api/index.ts
  - apps/extension/src/storage/types.ts
  - apps/extension/src/storage/preferences.ts
  - apps/extension/src/types/messages.ts
  - apps/extension/entrypoints/background.ts
autonomous: true

must_haves:
  truths:
    - "Green badge appears on extension icon when user is on a mapped page"
    - "Badge clears immediately when navigating away from mapped URL"
    - "Badge shows when mapping has at least one step (no badge for empty mappings)"
    - "Mapping detection re-evaluates when user changes project selection"
  artifacts:
    - path: "apps/extension/src/api/mappings.ts"
      provides: "API function to fetch mappings by project + URL"
      exports: ["fetchMappingsByUrl"]
    - path: "apps/extension/src/storage/preferences.ts"
      provides: "Last selected mapping ID per project"
      exports: ["preferencesStorage"]
  key_links:
    - from: "apps/extension/entrypoints/background.ts"
      to: "apps/extension/src/api/mappings.ts"
      via: "fetchMappingsByUrl call on tab activation"
      pattern: "fetchMappingsByUrl"
    - from: "apps/extension/entrypoints/background.ts"
      to: "browser.action.setBadgeText"
      via: "chrome extension API"
      pattern: "setBadgeText|setBadgeBackgroundColor"
---

<objective>
Implement mapping detection and badge indicator for the extension

Purpose: Show users when they're on a page that has an available mapping, enabling the COPILOTO fill workflow
Output: Badge appears on extension icon when on mapped page, disappears when navigating away
</objective>

<execution_context>
@/Users/luanmartins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luanmartins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-fill-cycle-integration/29-CONTEXT.md

# Existing extension code
@apps/extension/entrypoints/background.ts
@apps/extension/src/api/index.ts
@apps/extension/src/api/client.ts
@apps/extension/src/storage/preferences.ts
@apps/extension/src/storage/types.ts
@apps/extension/src/types/messages.ts

# Backend mapping API reference
@apps/api/src/core/entities/mapping.entity.ts
@apps/api/src/infrastructure/database/drizzle/repositories/drizzle-mapping.repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mapping API client functions</name>
  <files>
    apps/extension/src/api/mappings.ts
    apps/extension/src/api/index.ts
  </files>
  <action>
Create mappings.ts API client module:

1. Create fetchMappingsByUrl function:
   - Takes projectId and currentUrl as parameters
   - Calls GET /projects/{projectId}/mappings?targetUrl={currentUrl}&isActive=true
   - The backend already supports inverted prefix matching: `currentUrl LIKE storedUrl%`
   - Returns array of matching mappings with their step counts
   - Uses fetchWithAuth from client.ts

2. Create fetchMappingWithSteps function:
   - Takes projectId and mappingId
   - Calls GET /projects/{projectId}/mappings/{mappingId}
   - Returns mapping detail with steps array
   - Uses fetchWithAuth from client.ts

3. Add response types for the API responses:
   - MappingListItem: { id, name, targetUrl, stepCount, isActive }
   - MappingWithSteps: full mapping + steps array

4. Export from index.ts:
   - Add `export { fetchMappingsByUrl, fetchMappingWithSteps } from './mappings';`

Use the existing pattern from projects.ts and batches.ts for error handling.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && npm run type-check`
  </verify>
  <done>
fetchMappingsByUrl and fetchMappingWithSteps functions exist and compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mapping state to storage and messages</name>
  <files>
    apps/extension/src/storage/types.ts
    apps/extension/src/storage/preferences.ts
    apps/extension/src/types/messages.ts
  </files>
  <action>
1. Update PreferencesState in types.ts:
   - Add `lastMappingIdByProject: Record<string, string>` (maps projectId to last selected mappingId)

2. Update DEFAULT_PREFERENCES in types.ts:
   - Add `lastMappingIdByProject: {}`

3. Update preferencesStorage in preferences.ts:
   - Add `getLastMappingId(projectId: string): Promise<string | null>`
   - Add `setLastMappingId(projectId: string, mappingId: string | null): Promise<void>`

4. Update ExtensionState in messages.ts:
   - Add `mappingId: string | null` (current active mapping)
   - Add `hasMapping: boolean` (whether current URL has available mapping)

5. Add new message types to messages.ts:
   - `MappingSelectMessage`: { type: 'MAPPING_SELECT', payload: { mappingId: string } }
   - `GetMappingsMessage`: { type: 'GET_MAPPINGS' }
   - Add to PopupToBackgroundMessage union

This enables the background to track which mapping is active and the popup to show mapping selection.
  </action>
  <verify>
TypeScript compiles: `cd apps/extension && npm run type-check`
  </verify>
  <done>
PreferencesState has lastMappingIdByProject, ExtensionState has mappingId and hasMapping fields, new message types added
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement mapping detection and badge in background</name>
  <files>
    apps/extension/entrypoints/background.ts
  </files>
  <action>
Add mapping detection logic to background.ts:

1. Add tab activation listener:
```typescript
browser.tabs.onActivated.addListener(async (activeInfo) => {
  await checkMappingForTab(activeInfo.tabId);
});

browser.tabs.onUpdated.addListener(async (tabId, changeInfo, tab) => {
  // Only check on URL changes for the active tab
  if (changeInfo.url) {
    const [activeTab] = await browser.tabs.query({ active: true, currentWindow: true });
    if (activeTab?.id === tabId) {
      await checkMappingForTab(tabId);
    }
  }
});
```

2. Create checkMappingForTab function:
   - Get current tab URL
   - Get selected projectId from storage
   - If no project selected, clear badge and return
   - Call fetchMappingsByUrl(projectId, currentUrl)
   - Filter to mappings with stepCount > 0 (per CONTEXT.md: no badge for empty mappings)
   - If matches found:
     - Set badge text to checkmark or count
     - Set badge background color to green (#22c55e)
     - Store hasMapping: true in state
     - If lastMappingId for this project matches one of the results, auto-select it
   - If no matches:
     - Clear badge (setBadgeText(''))
     - Store hasMapping: false in state

3. Update buildState function:
   - Add mappingId from preferences (getLastMappingId for current project)
   - Add hasMapping based on most recent check (use module-level variable)

4. Add GET_MAPPINGS handler:
   - Get current tab URL
   - Get selected projectId
   - Call fetchMappingsByUrl and return matches

5. Add MAPPING_SELECT handler:
   - Store mappingId in preferences via setLastMappingId
   - Broadcast STATE_UPDATED

6. Update PROJECT_SELECT handler:
   - After storing projectId, call checkMappingForTab to re-evaluate

Badge implementation:
- Use browser.action.setBadgeText({ text: 'âœ“' }) for single match
- Use browser.action.setBadgeText({ text: String(count) }) for multiple matches
- Use browser.action.setBadgeBackgroundColor({ color: '#22c55e' }) for green
  </action>
  <verify>
1. Extension builds: `cd apps/extension && npm run build`
2. Manual test: Load extension, select project, navigate to mapped URL, verify badge appears
  </verify>
  <done>
Badge shows green checkmark when on mapped page with steps, clears when navigating away, re-evaluates on project change
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/extension && npm run type-check`
2. Extension builds successfully: `cd apps/extension && npm run build`
3. Manual verification:
   - Load extension in Chrome
   - Connect to account
   - Select a project that has mappings
   - Navigate to a URL that matches a mapping's targetUrl prefix
   - Verify green badge appears on extension icon
   - Navigate to different URL (not mapped)
   - Verify badge clears
</verification>

<success_criteria>
- POP-07 requirement satisfied: Mapping indicator shows when current URL has available mapping
- FILL-01 requirement satisfied: Background detects URL change and checks for matching mappings
- Badge is responsive (updates immediately on tab changes)
- Empty mappings (no steps) don't trigger badge
</success_criteria>

<output>
After completion, create `.planning/phases/29-fill-cycle-integration/29-01-SUMMARY.md`
</output>
